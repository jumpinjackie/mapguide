
var DomNode=Class.create();DomNode.prototype={initialize:function(xmlNode){this.textContent='';this.nodeName=xmlNode?xmlNode.nodeName:'';this.parentNode=arguments[1]?arguments[1]:null;this.childNodes=[];this.attributes=[];this.attributeNames=[];if(xmlNode){if(xmlNode.attributes){for(var i=0;i<xmlNode.attributes.length;i++){this.attributeNames.push(xmlNode.attributes[i].name);this.attributes[xmlNode.attributes[i].name]=xmlNode.attributes[i].nodeValue;}}
for(var i=0;i<xmlNode.childNodes.length;i++){if(xmlNode.childNodes[i].nodeType!=3){this.childNodes.push(new DomNode(xmlNode.childNodes[i],this));}else{this.textContent=this.textContent+xmlNode.childNodes[i].nodeValue;}}}
this._currentNode=0;},getAttribute:function(name){return typeof(this.attributes[name])!='undefined'?this.attributes[name]:null;},removeChild:function(child){var result=null;for(var i=0;i<this.childNodes.length;i++){if(this.childNodes[i]==child){this._currentNode=0;this.childNodes.splice(i,1);child.parentNode=null;result=child;break;}}
return result;},appendChild:function(child){if(child.parentNode){child.parentNode.removeChild(child);}
child.parentNode=this;this.childNodes.push(child);},insertBefore:function(newChild,refChild){var bInserted=false;if(refChild){for(var i=0;i<this.childNodes.length;i++){if(this.childNodes[i]==refChild){if(newChild.parentNode){newChild.parentNode.removeChild(child);}
newChild.parentNode=this;this.childNodes.splice(i,0,newChild);bInserted=true;break;}}}
if(!bInserted){this.appendChild(newChild);}},toString:function(depth){var s='';var spacer='';for(i=0;i<depth;i++){spacer=spacer+'';}
s=spacer+'&lt;'+this.nodeName;if(this.attributes.length>0){for(var name in this.attributes){if(typeof(this.attributes[name])=='String'){s=s+' '+name+'="'+this.attributes[name]+'"';}}}
s=s+'&gt;';if(this.childNodes.length==0){s=s+this.textContent;spacer='';}else{s=s+'\n';}
for(var i=0;i<this.childNodes.length;i++){s=s+this.childNodes[i].toString(depth+1);}
s=s+spacer+'&lt;/'+this.nodeName+'&gt;';return s;},toXML:function(){var s=this.parentNode?'':'<?xml version="1.0" encoding="UTF-8"?>\n';s=s+'<'+this.nodeName;if(this.attributeNames.length>0){for(var i=0;i<this.attributeNames.length;i++){var name=this.attributeNames[i];s=s+' '+name+'="'+this.attributes[name]+'"';}}
s=s+'>';if(this.childNodes.length==0){var content=this.textContent+'';content=content.replace('&','&amp;');content=content.replace(/</g,encodeURIComponent('&lt;'));content=content.replace(/>/g,encodeURIComponent('&gt;'));s=s+content;}
for(var i=0;i<this.childNodes.length;i++){s=s+this.childNodes[i].toXML();}
s=s+'</'+this.nodeName+'>\n';return s;},getNodeText:function(name){var s='';var n=this.findFirstNode(name);if(n){s=n.textContent;}
return s;},setNodeText:function(name,value){var n=this.findFirstNode(name);if(n){n.setTextContent(value);}},setTextContent:function(value){this.textContent=value;},setAttribute:function(name,value){if(typeof this.attributes[name]=='undefined'){this.attributeNames.push(name);}
this.attributes[name]=value;},findFirstNode:function(name){this._currentNode=0;if(this.nodeName==name){return this;}else{for(var i=0;i<this.childNodes.length;i++){var node=this.childNodes[i].findFirstNode(name);if(node){if(node.parentNode==this){this._currentNode=i+1;}else{this._currentNode=i;}
return node;}}
return false;}},findNextNode:function(name){if(this.nodeName==name){return this;}else{for(var i=this._currentNode;i<this.childNodes.length;i++){var node=this.childNodes[i].findNextNode(name);if(node){if(node.parentNode==this){this._currentNode=i+1;}else{this._currentNode=i;}
return node;}}
return false;}}};var DomNodeFactory={create:function(name,value){var node=new DomNode();node.nodeName=name;node.textContent=value||'';return node;}};Fusion.Error=Class.create();Fusion.Error.FATAL=0;Fusion.Error.WARNING=1;Fusion.Error.NOTICE=2;Fusion.Error.prototype={type:null,message:null,initialize:function(type,message){this.type=type;this.message=message;},alert:function(){var type=this.typeToString(this.type);alert(OpenLayers.String.translate('fusionError',type,this.message));},toString:function(){var type=this.typeToString(this.type);return type+": "+this.message;},typeToString:function(type){switch(type){case Fusion.Error.FATAL:return'FATAL';case Fusion.Error.WARNING:return'WARNING';case Fusion.Error.NOTICE:return'NOTICE';default:return'UNKNOWN ('+type+')';}}};Fusion.Lib.ApplicationDefinition=Class.create();Fusion.Lib.ApplicationDefinition.prototype={mapGroups:null,widgetSets:null,oBroker:null,searchDefinitions:null,searchCategories:null,initialize:function(sessionId){Fusion.Lib.EventMgr.initialize.apply(this,[]);this.sessionId=sessionId;this.oBroker=Fusion.getBroker();this.applicationDefinition=Fusion.getApplicationDefinitionURL();this.widgetSets=[];this.mapGroups=[];this.searchDefinitions=[];this.searchCategories=[];this.parse();},loadFailure:function(){Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.String.translate('appDefLoadFailed',this.applicationDefinition)));},parse:function(){if(this.applicationDefinition==''){return null;}
if((this.applicationDefinition.match('Library://')==null)&&(this.applicationDefinition.match('Session:')==null)){var options={};options.method='get';options.onSuccess=this.convertXML.bind(this);options.onFailure=this.loadFailure.bind(this);new Ajax.Request(this.applicationDefinition,options);}else{if(!this.sessionId){var r=new Fusion.Lib.MGRequest.MGCreateSession();this.oBroker.dispatchRequest(r,this.getAppDef.bind(this));}else{this.getAppDef();}}
return true;},getAppDef:function(xhr){if(xhr){this.sessionId=xhr.responseText;Fusion.sessionId=this.sessionId;}
var r=new Fusion.Lib.MGRequest.MGGetResourceContent(this.applicationDefinition);r.parameters.session=this.sessionId;this.oBroker.dispatchRequest(r,this.convertXML.bind(this));},convertXML:function(r,json){if(json){this.parseJSON(r,json);}else{if(r.responseXML.documentElement.nodeName=='parsererror'){Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,'invalid XML document: '+this.applicationDefinition));}
var options={};options.onSuccess=this.parseJSON.bind(this);options.parameters='xml='+encodeURIComponent(r.responseText.replace(/\\/g,'\\\\\\\\'))+'&ts='+((new Date()).getTime());var sl=Fusion.getScriptLanguage();Fusion.ajaxRequest('common/'+sl+'/Xml2JSON.'+sl,options);}},parseJSON:function(r,json){if(json){var mainNode;eval("mainNode="+r.responseText);var appDef=mainNode.ApplicationDefinition;if(appDef.Title){var title=appDef.Title[0];document.title=title;}
if(appDef.MapSet){var mapSet=appDef.MapSet[0];if(mapSet.MapGroup instanceof Array){for(var i=0;i<mapSet.MapGroup.length;i++){var mapGroup=new Fusion.Lib.ApplicationDefinition.MapGroup(mapSet.MapGroup[i]);this.mapGroups.push(mapGroup);}}}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.String.translate('appDefParseError')));}
if(appDef.WidgetSet){for(var i=0;i<appDef.WidgetSet.length;i++){var widgetSet=new Fusion.Lib.ApplicationDefinition.WidgetSet(appDef.WidgetSet[i]);this.widgetSets.push(widgetSet);}}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.String.translate('widgetSetParseError')));}
if(appDef.Extension){var extension=appDef.Extension[0];if(extension.SearchDefinitions instanceof Array){var categories=extension.SearchDefinitions[0];if(categories.SearchCategory instanceof Array){for(var i=0;i<categories.SearchCategory.length;i++){var oCategory={};var category=categories.SearchCategory[i];oCategory.id=category['@id'];oCategory.name=category['@name'];oCategory.layer=category.Layer?category.Layer[0]:'';oCategory.searchDefinitions=[];this.searchCategories[oCategory.id]=oCategory;var defns=category.SearchDefinition;for(var k=0;k<defns.length;k++){var defn=new Fusion.Lib.ApplicationDefinition.SearchDefinition(defns[k]);defn.category=oCategory;oCategory.searchDefinitions[defn.id]=defn;this.searchDefinitions[defn.id]=defn;}}}}}}
Fusion.setLoadState(Fusion.LOAD_WIDGETS);},create:function(){for(var i=0;i<this.widgetSets.length;i++){this.widgetSets[i].create(this);}},getMapByName:function(name){var map=null;for(var i=0;i<this.widgetSets.length;i++){map=this.widgetSets[i].getMapByName(name);if(map){break;}}
return map;},getMapById:function(id){var map=null;for(var i=0;i<this.widgetSets.length;i++){map=this.widgetSets[i].mapWidget;if(map.mapId==id){break;}}
return map;},getMapByIndice:function(indice){var map=null;if(this.widgetSets.length<indice){map=this.widgetSets[indice].getMapWidget();}
return map;},getMapGroup:function(mapGroupId){var mapGroup=null;for(var i=0;i<this.mapGroups.length;++i){if(this.mapGroups[i].mapId==mapGroupId){mapGroup=this.mapGroups[i];break;}}
return mapGroup;},getWidgetsByType:function(type){var widgets=[];for(var i=0;i<this.widgetSets.length;i++){widgets=widgets.concat(this.widgetSets[i].getWidgetsByType(type));}
return widgets;}};Fusion.Lib.ApplicationDefinition.MapGroup=Class.create();Fusion.Lib.ApplicationDefinition.MapGroup.prototype={initialView:null,maps:null,initialize:function(jsonNode){this.mapId=jsonNode['@id'][0];this.maps=[];if(jsonNode.InitialView){var iv=jsonNode.InitialView[0];if(iv.CenterX&&iv.CenterY&&iv.Scale){this.setInitialView({x:parseFloat(iv.CenterX[0]),y:parseFloat(iv.CenterY[0]),scale:parseFloat(iv.Scale[0])});}else if(iv.MinX&&iv.MinY&&iv.MaxX&&iv.MaxY){this.setInitialView({minX:parseFloat(iv.MinX[0]),minY:parseFloat(iv.MinY[0]),maxX:parseFloat(iv.MaxX[0]),maxY:parseFloat(iv.MaxY[0])});}else{}}
if(jsonNode.Map instanceof Array){for(var i=0;i<jsonNode.Map.length;i++){var map=new Fusion.Lib.ApplicationDefinition.Map(jsonNode.Map[i]);this.maps.push(map);}}else{}
this.links={groups:[],layers:[]};this.layerEvents={};if(jsonNode.Extension){var extension=jsonNode.Extension[0];if(extension.Links){if(extension.Links[0].Group instanceof Array){for(var j=0;j<extension.Links[0].Group.length;j++){var group=extension.Links[0].Group[j];this.links.groups.push({name:group.Name,url:group.Url});}}
if(extension.Links[0].Layer instanceof Array){for(var j=0;j<extension.Links[0].Layer.length;j++){var layer=extension.Links[0].Layer[j];this.links.layers.push({name:layer.Name,url:layer.Url});}}}
if(extension.LayerEvents){if(extension.LayerEvents[0].Layer instanceof Array){for(var j=0;j<extension.LayerEvents[0].Layer.length;j++){var layer=extension.LayerEvents[0].Layer[j];var layerObj={};layerObj.name=layer.Name[0];layerObj.onEnable=[];layerObj.onDisable=[];if(layer.OnEnable instanceof Array){for(var k=0;k<layer.OnEnable[0].Layer.length;k++){var kLayer=layer.OnEnable[0].Layer[k];layerObj.onEnable.push({name:kLayer.Name[0],enable:kLayer.Enable[0]=='true'?true:false});}}
if(layer.OnDisable instanceof Array){for(var k=0;k<layer.OnDisable[0].Layer.length;k++){var kLayer=layer.OnDisable[0].Layer[k];layerObj.onDisable.push({name:kLayer.Name[0],enable:kLayer.Enable[0]=='true'?true:false});}}
this.layerEvents[layerObj.name]=layerObj;}}}}else{this.extension={};}},getInitialView:function(){return this.initialView;},setInitialView:function(view){this.initialView=view;}};Fusion.Lib.ApplicationDefinition.Map=Class.create();Fusion.Lib.ApplicationDefinition.Map.prototype={type:null,singleTile:false,extension:null,initialize:function(jsonNode){this.type=jsonNode.Type[0];if(jsonNode.SingleTile){var b=jsonNode.SingleTile[0].toLowerCase();this.singleTile=(b=="true")?true:false;}
if(jsonNode.Extension){this.extension=jsonNode.Extension[0];}else{this.extension={};}
this.resourceId=this.extension.ResourceId?this.extension.ResourceId[0]:'';if(!Fusion.Maps[this.type]){Fusion.require(this.type+'/'+this.type+'.js');}}};Fusion.Lib.ApplicationDefinition.WidgetSet=Class.create();Fusion.Lib.ApplicationDefinition.WidgetSet.prototype={containers:null,containersByName:null,widgetTags:null,widgetTagsByName:null,widgetInstances:null,mapWidget:null,mapId:null,initialize:function(jsonNode){this.containers=[];this.widgetTags=[];this.widgetInstances=[];this.widgetTagsByName={};this.containersByName={};if(jsonNode.MapWidget){for(var i=0;i<jsonNode.MapWidget.length;i++){var widget=new Fusion.Lib.ApplicationDefinition.Widget(jsonNode.MapWidget[i]);widget.widgetSet=this;this.mapWidgetTag=widget;this.mapId=jsonNode.MapWidget[i].MapId[0];}}
var paramMapId=Fusion.getQueryParam('mapid');if(paramMapId.length>0){this.mapId=paramMapId;}
if(jsonNode.Widget){for(var i=0;i<jsonNode.Widget.length;i++){var widget=new Fusion.Lib.ApplicationDefinition.Widget(jsonNode.Widget[i]);widget.widgetSet=this;this.widgetTags.push(widget);this.widgetTagsByName[widget.name]=widget;}}
if(jsonNode.Container){for(var i=0;i<jsonNode.Container.length;i++){var container=new Fusion.Lib.ApplicationDefinition.Container(jsonNode.Container[i]);this.containers.push(container);this.containersByName[container.name]=container;}}},addWidgetInstance:function(widget){this.widgetInstances.push(widget);},getMapWidget:function(){return this.mapWidget;},create:function(appDef){var mapGroup=null;if(this.mapId){for(var i=0;i<appDef.mapGroups.length;++i){if(this.mapId==appDef.mapGroups[i].mapId){mapGroup=appDef.mapGroups[i];break;}}}
this.mapWidget=new Fusion.Widget.Map(this.mapWidgetTag,mapGroup,this);this.mapWidget.setMenu();$(this.mapWidgetTag.name).widget=this.mapWidget;for(var i=0;i<this.widgetTags.length;i++){this.widgetTags[i].create(this);}
for(var i=0;i<this.containers.length;i++){this.containers[i].create(this);}},getMapByName:function(name){var map=null;if(this.mapWidget.getMapName()==name){map=this.mapWidget;}
return map;},getWidgetsByType:function(type){var widgets=[];for(var i=0;i<this.widgetInstances.length;i++){if(this.widgetInstances[i].sType==type){widgets.push(this.widgetInstances[i]);}}
return widgets;},getWidgetByName:function(name){return this.widgetTagsByName[name];},getContainerByName:function(name){return this.containersByName[name];}};Fusion.Lib.ApplicationDefinition.Container=Class.create();Fusion.Lib.ApplicationDefinition.Container.prototype={name:null,type:null,validPositions:['top','left','bottom','right'],position:'top',items:null,initialize:function(jsonNode){this.type=jsonNode.Type[0];this.name=jsonNode.Name[0];var position=jsonNode.Position?jsonNode.Position[0].toLowerCase():this.position;for(var i=0;i<this.validPositions.length;i++){if(this.validPositions[i]==position){this.position=position;break;}}
this.items=[];if(jsonNode.Item){for(var i=0;i<jsonNode.Item.length;i++){var item=new Fusion.Lib.ApplicationDefinition.Item(jsonNode.Item[i]);this.items.push(item);}}else{}},create:function(widgetSet){var container;if(this.type=='Toolbar'||this.type=='Statusbar'){if($(this.name)){container=new Jx.Toolbar(this.name,this.position);$(this.name).container=container;}
this.createWidgets(widgetSet,container);}else if(this.type=='Splitterbar'){if($(this.name)){container=new Jx.Splitter(this.name,{splitInto:this.items.length});for(var i=0;i<this.items.length;i++){container.elements[i].id=this.name+'_'+i;}
$(this.name).container=container;}
this.createWidgets(widgetSet,container);}
if(container&&container.domObj.jxLayout){container.domObj.jxLayout.resize();}},createWidgets:function(widgetSet,container){for(var i=0;i<this.items.length;i++){this.items[i].create(widgetSet,container,this.name+'_'+i);}}};Fusion.Lib.ApplicationDefinition.Widget=Class.create();Fusion.Lib.ApplicationDefinition.Widget.prototype={name:null,type:null,statusText:null,location:null,imageUrl:null,imageClass:null,tooltip:null,label:null,disabled:null,extension:null,initialize:function(jsonNode){if(jsonNode){this.type=jsonNode.Type[0];this.name=jsonNode.Name?jsonNode.Name[0]:'';this.statusText=jsonNode.StatusText?jsonNode.StatusText[0]:'';this.location=jsonNode.Location?jsonNode.Location[0]:'widgets/';if(this.location.slice(-1)!='/'){this.location+='/';}
this.imageUrl=jsonNode.ImageUrl?jsonNode.ImageUrl[0]:'';this.imageClass=jsonNode.ImageClass?jsonNode.ImageClass[0]:'';this.tooltip=jsonNode.Tooltip?jsonNode.Tooltip[0]:'';this.label=jsonNode.Label?jsonNode.Label[0]:'';this.disabled=jsonNode.Disabled?(jsonNode.Disabled[0].toLowerCase()=='true'?true:false):false;if(jsonNode.Extension){this.extension=jsonNode.Extension[0];}else{this.extension={};}
if(!Fusion.Widget[this.type]){Fusion.require(this.location+this.type+'.js');}}},getMapWidget:function(){if(this.widgetSet){return this.widgetSet.getMapWidget();}else{return null;}},create:function(widgetSet,widgetName){var widget=null;this.widgetSet=widgetSet;var oldName=this.name;if(typeof widgetName=='undefined'){widgetName=this.name;}
if(widgetName!=null&&(widgetName==''||$(widgetName)!=null)){this.name=widgetName;widget=eval("new Fusion.Widget."+this.type+"(this)");widgetSet.addWidgetInstance(widget);if($(this.name)){widget.id=this.name;$(this.name).widget=widget;}
this.name=oldName;}
return widget;}};Fusion.Lib.ApplicationDefinition.Item=Class.create();Fusion.Lib.ApplicationDefinition.Item.prototype={uniqueId:[0],type:null,initialize:function(jsonNode){this.type=jsonNode.Function[0];switch(this.type){case'Widget':this.widgetName=jsonNode.Widget[0];break;case'Flyout':this.flyout=new Fusion.Lib.ApplicationDefinition.Flyout(jsonNode);break;case'Separator':break;break;}},create:function(widgetSet,container,idx){switch(this.type){case'Widget':var widgetTag=widgetSet.getWidgetByName(this.widgetName);if(widgetTag){var name='FusionItem'+this.uniqueId[0];this.uniqueId[0]++;if(container instanceof Jx.Toolbar){var tbItem=new Jx.ToolbarItem();tbItem.domObj.id=name;container.add(tbItem);widgetTag.create(widgetSet,name);}else if(container instanceof Jx.Splitter){var widget=widgetTag.create(widgetSet,idx);}else if(container instanceof Jx.Menu||container instanceof Jx.ContextMenu||container instanceof Jx.SubMenu){var widget=widgetTag.create(widgetSet,'');if(widget.oMenu){container.add(widget.oMenu);}else{var action=new Jx.Action(widget.activateTool.bind(widget));var opt={};opt.label=widgetTag.label;opt.image=widgetTag.imageUrl;var menuItem=new Jx.MenuItem(action,opt);container.add(menuItem);}}}else{Fusion.reportError(new Fusion.Error(Fusion.Error.WARNING,"can't find widget: "+this.widgetName));}
break;case'Flyout':var menu;var opt={};opt.label=this.flyout.label;opt.tooltip=this.flyout.tooltip;opt.image=this.flyout.imageUrl;opt.imageClass=this.flyout.imageClass;if(container instanceof Jx.Toolbar){menu=new Jx.Menu(opt);}else if(container instanceof Jx.Menu||container instanceof Jx.ContextMenu||container instanceof Jx.SubMenu){menu=new Jx.SubMenu(opt);}
container.add(menu);this.flyout.create(widgetSet,menu);break;case'Separator':if(container instanceof Jx.Toolbar){container.add(new Jx.ToolbarSeparator());}else if(container instanceof(Jx.Menu)||container instanceof(Jx.SubMenu)||container instanceof(Jx.ContextMenu)){container.add(new Jx.MenuSeparator());}
break;}}};Fusion.Lib.ApplicationDefinition.Flyout=Class.create();Fusion.Lib.ApplicationDefinition.Flyout.prototype={label:null,tooltip:null,description:null,imageUrl:null,items:null,initialize:function(jsonNode){this.label=jsonNode.Label?jsonNode.Label[0]:'';this.tooltip=jsonNode.Tooltip?jsonNode.Tooltip[0]:'';this.description=jsonNode.Description?jsonNode.Description[0]:'';this.imageUrl=jsonNode.ImageUrl?jsonNode.ImageUrl[0]:'';this.items=[];if(jsonNode.Item instanceof Array){for(var i=0;i<jsonNode.Item.length;i++){this.items.push(new Fusion.Lib.ApplicationDefinition.Item(jsonNode.Item[i]));}}},create:function(widgetSet,menu){for(var i=0;i<this.items.length;i++){this.items[i].create(widgetSet,menu);}}};Fusion.Lib.ApplicationDefinition.SearchDefinition=Class.create();Fusion.Lib.ApplicationDefinition.SearchDefinition.prototype={id:null,name:null,category:null,parameters:null,join:null,rule:null,initialize:function(json){this.id=json['@id'];this.name=json['@name'];if(json.Join instanceof Array){this.join=new Fusion.Lib.ApplicationDefinition.SearchJoin(json.Join[0]);}
this.parameters=[];if(json.Parameter instanceof Array){for(var i=0;i<json.Parameter.length;i++){this.parameters.push(json.Parameter[i]['@name']);}}
var rule;if(json.SearchAnd instanceof Array){this.rule=new Fusion.Lib.ApplicationDefinition.SearchRule('AND');rule=json.SearchAnd[0];}else if(json.SearchOr instanceof Array){this.rule=new Fusion.Lib.ApplicationDefinition.SearchRule('OR');rule=json.SearchOr[0];}
if(rule&&rule.SearchCondition instanceof Array){for(var i=0;i<rule.SearchCondition.length;i++){this.rule.add(new Fusion.Lib.ApplicationDefinition.SearchCondition(rule.SearchCondition[i]));}}},getJoinUrl:function(params){if(this.join){return'&joinlayer='+this.join.layer+'&joinpk='+this.join.primaryKey+'&joinfk='+this.join.foreignKey;}else{return'';}},getFilterUrl:function(params){return'&filter='+encodeURIComponent(this.rule.toString(params));}};Fusion.Lib.ApplicationDefinition.SearchJoin=Class.create();Fusion.Lib.ApplicationDefinition.SearchJoin.prototype={layer:null,primaryKey:null,foreignKey:null,initialize:function(json){this.layer=json.Layer?json.Layer[0]:'';this.primaryKey=json.PrimaryKey?json.PrimaryKey[0]:'';this.foreignKey=json.ForeignKey?json.ForeignKey[0]:'';}};Fusion.Lib.ApplicationDefinition.SearchRule=Class.create();Fusion.Lib.ApplicationDefinition.SearchRule.prototype={type:null,conditions:null,initialize:function(type){this.type=type;this.conditions=[];},add:function(condition){this.conditions.push(condition);},remove:function(condition){for(var i=0;i<this.conditions.length;i++){if(this.conditions[i]==condition){this.conditions.splice(i,1);break;}}},toString:function(params){var conditions=[];for(var i=0;i<this.conditions.length;i++){this.conditions[i].setParams(params);var c=this.conditions[i].toString();if(c!=''){conditions.push(c);}}
return'('+conditions.join(') '+this.type+' (')+')';}};Fusion.Lib.ApplicationDefinition.SearchCondition=Class.create();Fusion.Lib.ApplicationDefinition.SearchCondition.prototype={column:null,operator:null,parameter:null,quote:null,value:null,operators:{eq:'=',like:'like',lt:'<',lte:'<=',gt:'>',gte:'>=',neq:'<>'},includeIfEmpty:false,initialize:function(json){this.column=json.Column[0];this.operator=this.operators[json.Operator[0].toLowerCase()];this.parameter=json.Parameter[0];this.quote=json['@quote']?json['@quote']:'';this.wildcard=json['@wildcard']?json['@wildcard']:'both';this.caseSensitive=true;if(json['@caseSensitive']&&json['@caseSensitive']=='false'){this.caseSensitive=false;}},setParams:function(p){if(p[this.parameter]){this.value=p[this.parameter];}else{this.value='';}},toString:function(){var value=this.value?this.value:'';if(value==''&&!this.includeIfEmpty){return'';}
var upper='';if(!this.caseSensitive){value=value.toUpperCase();upper='Upper';}
var prewildcard='';var prewildcard='';var postwildcard='';if(this.operator=='like'){if(this.wildcard=='before'||this.wildcard=='both'){prewildcard='*';}
if(this.wildcard=='after'||this.wildcard=='both'){postwildcard='*';}}
var wildcard=this.operator=='like'?'*':'';return upper+'('+this.column+') '+this.operator+' '+this.quote+prewildcard+value+postwildcard+this.quote;}};Fusion.Lib.MGBroker=Class.create();Fusion.Lib.MGBroker.prototype={mapGuideURL:'',mapAgentURL:'',method:null,initialize:function(){},dispatchRequest:function(r,f){var s=r.encode()+'&ts='+(new Date()).getTime();if(this.method){r.options.method=this.method;}
var a=new Ajax.Request(this.mapAgentURL,Object.extend({parameters:r.parameters,onComplete:f},r.options));a.originalRequest=r;},setSiteURL:function(url,user,pass){this.user=user;this.pass=pass;if(url.indexOf('mapagent.fcgi')==-1){if(url.charAt(url.length-1)!='/'){url=url+'/';}
this.mapGuideURL=url;url=url+'mapagent/mapagent.fcgi';}
this.mapAgentURL=url;},clearSiteURL:function(){this.user='';this.pass='';this.mapGuideURL='';this.mapAgentURL='';}};Fusion.Lib.MGRequest=Class.create();Fusion.Lib.MGRequest.prototype={options:null,parameters:null,initializeRequest:function(){this.options={method:'post'};this.parameters={version:'1.0.0',locale:Fusion.locale};},setParams:function(o){Object.extend(this.parameters,(o||{}));},setOptions:function(o){Object.extend(this.options,(o||{}));},encode:function(){var s=sep='';for(var p in this.parameters){if(this.parameters[p]){s=s+sep+p+'='+encodeURI(this.parameters[p]);}
sep='&';}
return s;}};Fusion.Lib.MGRequest.MGEnumerateResources=Class.create();Object.extend(Fusion.Lib.MGRequest.MGEnumerateResources.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGEnumerateResources.prototype,{initialize:function(resourceID,type,depth){this.initializeRequest();this.setParams({operation:'ENUMERATERESOURCES',resourceid:(resourceID||"Library://"),type:(type||""),depth:(typeof depth=='undefined'?-1:depth)});}});Fusion.Lib.MGRequest.MGGetResourceContent=Class.create();Object.extend(Fusion.Lib.MGRequest.MGGetResourceContent.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGGetResourceContent.prototype,{initialize:function(resourceID){this.initializeRequest();this.setParams({operation:'GETRESOURCECONTENT',resourceid:(resourceID||"Library://")});}});Fusion.Lib.MGRequest.MGGetResourceHeader=Class.create();Object.extend(Fusion.Lib.MGRequest.MGGetResourceHeader.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGGetResourceHeader.prototype,{initialize:function(resourceID){this.initializeRequest();this.setParams({operation:'GETRESOURCEHEADER',resourceid:(resourceID||"Library://")});}});Fusion.Lib.MGRequest.MGCreateSession=Class.create();Object.extend(Fusion.Lib.MGRequest.MGCreateSession.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGCreateSession.prototype,{initialize:function(){this.initializeRequest();this.setParams({operation:'CREATESESSION'});}});Fusion.Lib.MGRequest.MGCopyResource=Class.create();Object.extend(Fusion.Lib.MGRequest.MGCopyResource.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGCopyResource.prototype,{initialize:function(sourceID,destinationID,overwrite){this.initializeRequest();this.setParams({operation:'COPYRESOURCE',source:sourceID,destination:destinationID,overwrite:overwrite});}});Fusion.Lib.MGRequest.MGDeleteResource=Class.create();Object.extend(Fusion.Lib.MGRequest.MGDeleteResource.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGDeleteResource.prototype,{initialize:function(resourceID){this.initializeRequest();this.setParams({operation:'DELETERESOURCE',resourceid:resourceID});}});Fusion.Lib.MGRequest.MGMoveResource=Class.create();Object.extend(Fusion.Lib.MGRequest.MGMoveResource.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGMoveResource.prototype,{initialize:function(sourceID,destinationID,overwrite){this.initializeRequest();this.setParams({operation:'MOVERESOURCE',source:sourceID,destination:destinationID,overwrite:overwrite});}});Fusion.Lib.MGRequest.MGMoveResource=Class.create();Object.extend(Fusion.Lib.MGRequest.MGMoveResource.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGMoveResource.prototype,{initialize:function(resourceID,content,header){this.initializeRequest();this.setParams({method:'post',operation:'SETRESOURCE',resourceid:resourceID,content:content,header:header});}});Fusion.Lib.MGRequest.MGDescribeSchema=Class.create();Object.extend(Fusion.Lib.MGRequest.MGDescribeSchema.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGDescribeSchema.prototype,{initialize:function(resourceID,schema){this.initializeRequest();this.setParams({operation:'DESCRIBEFEATURESCHEMA',resourceid:resourceID,schema:schema});}});Fusion.Lib.MGRequest.MGGetSpatialContexts=Class.create();Object.extend(Fusion.Lib.MGRequest.MGGetSpatialContexts.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGGetSpatialContexts.prototype,{initialize:function(resourceID,activeonly){this.initializeRequest();this.setParams({operation:'GETSPATIALCONTEXTS',resourceid:resourceID,activeonly:activeonly?'1':'0'});}});Fusion.Lib.MGRequest.MGEnumerateResourceReferences=Class.create();Object.extend(Fusion.Lib.MGRequest.MGEnumerateResourceReferences.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGEnumerateResourceReferences.prototype,{initialize:function(resourceID){this.initializeRequest();this.setParams({operation:'ENUMERATERESOURCEREFERENCES',resourceid:resourceID});}});Fusion.Lib.MGRequest.MGEnumerateResourceData=Class.create();Object.extend(Fusion.Lib.MGRequest.MGEnumerateResourceData.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGEnumerateResourceData.prototype,{initialize:function(resourceID){this.initializeRequest();this.setParams({operation:'ENUMERATERESOURCEDATA',resourceid:resourceID});}});Fusion.Lib.MGRequest.MGGetVisibleMapExtent=Class.create();Object.extend(Fusion.Lib.MGRequest.MGGetVisibleMapExtent.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGGetVisibleMapExtent.prototype,{initialize:function(sessionId,mapName,viewCenterX,viewCenterY,viewScale,dataExtent,displayDpi,displayWidth,displayHeight,showLayers,hideLayers,showGroups,hideGroups,refreshLayers){this.initializeRequest();this.setParams({operation:'GETVISIBLEMAPEXTENT',session:sessionId,mapname:mapName,setviewcenterx:viewCenterX,setviewcentery:viewCenterY,setviewscale:viewScale,setdataextent:dataExtent,setdisplaydpi:displayDpi,setdisplaywidth:displayWidth,setdisplayheight:displayHeight,showlayers:showLayers,hidelayers:hideLayers,showgroups:showGroups,hidegroups:hideGroups,refreshlayers:refreshLayers});}});Fusion.Lib.MGRequest.MGQueryMapFeatures=Class.create();Object.extend(Fusion.Lib.MGRequest.MGQueryMapFeatures.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGQueryMapFeatures.prototype,{initialize:function(sessionId,mapName,geometry,maxFeatures,persist,selectionVariant,layerNames)
{this.initializeRequest();this.setParams({operation:'QUERYMAPFEATURES',session:sessionId,mapname:mapName,geometry:geometry,maxFeatures:maxFeatures,persist:persist,selectionVariant:selectionVariant,layerNames:layerNames});}});Fusion.Lib.MGRequest.MGGetFeatureSetEnvelope=Class.create();Object.extend(Fusion.Lib.MGRequest.MGGetFeatureSetEnvelope.prototype,Fusion.Lib.MGRequest.prototype);Object.extend(Fusion.Lib.MGRequest.MGGetFeatureSetEnvelope.prototype,{initialize:function(sessionId,mapName,features)
{this.initializeRequest();this.setParams({operation:'GETFEATURESETENVELOPE',session:sessionId,mapname:mapName,featureSet:features});}});Fusion.Event.WIDGET_STATE_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget=Class.create();Fusion.Widget.prototype={bIsMutuallyExclusive:null,sName:null,sType:null,oMap:null,bEnabled:false,mapLoadedWatcher:null,paramRegister:null,groups:[],group:null,domObj:null,initialize:function(widgetTag,bMutEx){this.bIsMutuallyExclusive=bMutEx;this.sType=widgetTag.type;this.sName=widgetTag.name;this.widgetTag=widgetTag;Object.inheritFrom(this,Fusion.Lib.EventMgr,[]);this.registerEventID(Fusion.Event.WIDGET_STATE_CHANGED);var group=widgetTag.extension.Group?widgetTag.extension.Group[0]:'';if(group!=''){if(!this.groups[group]){this.groups[group]=[];}
this.groups[group].push(this);this.group=group;}
this.setMap(widgetTag.getMapWidget());if(widgetTag.name){this.domObj=$(widgetTag.name);}
this.paramRegister=[];},setMap:function(oMap){if(this.mapLoadedWatcher){this.oMap.deregisterForEvent(Fusion.Event.MAP_LOADED,this.mapLoadedWatcher);this.mapLoadedWatcher=null;}
this.oMap=oMap;if(oMap){this.mapLoadedWatcher=this._mapLoaded.bind(this);oMap.registerForEvent(Fusion.Event.MAP_LOADED,this.mapLoadedWatcher);}
if(oMap&&oMap.isLoaded()){this.enable();}else{this.disable();}},getMap:function(){return this.oMap;},_mapLoaded:function(){if(this.oMap&&this.oMap.isLoaded()){this.enable();}else{this.disable();}},setMutEx:function(bIsMutEx){this.bIsMutuallyExclusive=bIsMutEx;},isMutEx:function(){return this.bIsMutuallyExclusive;},getName:function(){return this.sName;},getLocation:function(){return this.widgetTag.location;},isEnabled:function(){return this.bEnabled;},enable:function(){this.bEnabled=true;this.triggerEvent(Fusion.Event.WIDGET_STATE_CHANGED,this);},disable:function(){this.bEnabled=false;this.triggerEvent(Fusion.Event.WIDGET_STATE_CHANGED,this);},setParameter:function(param,value){},registerParameter:function(param){this.paramRegister.push(param);}};Fusion.Tool.ButtonBase=Class.create();Fusion.Tool.ButtonBase.prototype={initialize:function(){this.enable=Fusion.Tool.ButtonBase.prototype.enable;this.disable=Fusion.Tool.ButtonBase.prototype.disable;this._oButton=new Fusion.Tool.Button(this.domObj,this.widgetTag);if(!this.isEnabled()){this._oButton.disableTool();}
this.clickWatcher=this.clickCB.bind(this);this._oButton.observeEvent('click',this.clickWatcher);},clickCB:function(e){if(this.isEnabled()){this.activateTool();}
this._oButton._oButton.domObj.blur();return false;},activateTool:function(){if(this.execute){this.execute();}
if(this.group){this._oButton.activateTool();for(var i=0;i<this.groups[this.group].length;i++){if(this.groups[this.group][i]!=this){this.groups[this.group][i]._oButton.deactivateTool();}}}},enable:function(){Fusion.Widget.prototype.enable.apply(this,[]);this._oButton.enableTool();},disable:function(){Fusion.Widget.prototype.disable.apply(this,[]);this._oButton.disableTool();}};Fusion.Tool.MenuBase=Class.create();Fusion.Tool.MenuBase.prototype={initialize:function(){this.enable=Fusion.Tool.MenuBase.prototype.enable;this.disable=Fusion.Tool.MenuBase.prototype.disable;var options={};options.imgPath=this.widgetTag.imageUrl;options.imgClass=this.widgetTag.imageClass;options.tooltip=this.widgetTag.tooltip;options.label=this.widgetTag.label;if($(this.widgetTag.name)){this.oMenu=new Jx.Menu(options);$(this.widgetTag.name).appendChild(this.oMenu.domObj);}else{this.oMenu=new Jx.SubMenu(options);}},enable:function(){Fusion.Widget.prototype.enable.apply(this,[]);},disable:function(){Fusion.Widget.prototype.disable.apply(this,[]);}};Fusion.Tool.Button=Class.create();Fusion.Tool.Button.prototype={bActive:null,sActiveClass:'jxButtonActive',sDisabledClass:'jxButtonDisabled',initialize:function(domObj,widgetTag){var json=widgetTag.extension;this.buttonAction=new Jx.Action(this.buttonClicked.bind(this));if(domObj){var options={};options.imgPath=widgetTag.imageUrl;options.imgClass=widgetTag.imageClass;options.tooltip=widgetTag.tooltip;options.label=widgetTag.label;this._oButton=new Jx.Button(this.buttonAction,options);domObj.appendChild(this._oButton.domObj);}
this.bActive=false;this.bEnabled=true;if(widgetTag.disabled){this.disableTool();}},buttonClicked:function(){},observeEvent:function(sEvent,fnCB){if(this._oButton){Event.observe(this._oButton.domObj,sEvent,fnCB);}},stopObserveEvent:function(sEvent,fnCB){if(this._oButton){Event.stopObserving(this._oButton.domObj,sEvent,fnCB);}},enableTool:function(){this.buttonAction.setEnabled(true);},disableTool:function(){this.buttonAction.setEnabled(false);},activateTool:function(){this.bActive=true;if(!this._oButton){return;}
if(this._sImageURL!=null&&this._sImageURL.length>0){this._oButton.setImage(this._sImageURL);}
if(this.sActiveClass!=''){Element.addClassName(this._oButton.domA,this.sActiveClass);}},deactivateTool:function(){this.bActive=false;if(!this._oButton){return;}
if(this.sActiveClass!=''){Element.removeClassName(this._oButton.domA,this.sActiveClass);}},clickCB:function(e){this.activateTool();},isActive:function(){return this.bActive;}};Fusion.Tool.Canvas=Class.create();Fusion.Tool.Canvas.prototype={context:null,canvas:null,width:null,height:null,initialize:function()
{this.context=null;this.canvas=null;this.width=null;this.height=null;this.mouseMoveCB=this.mouseMove.bindAsEventListener(this);this.mouseUpCB=this.mouseUp.bindAsEventListener(this);this.mouseDownCB=this.mouseDown.bindAsEventListener(this);this.dblClickCB=this.dblClick.bindAsEventListener(this);this.resizeCanvasFn=this.resizeCanvas.bind(this);},clearContext:function(){if(this.context){this.context.clearRect(0,0,this.width,this.height);}},activateCanvas:function(){var map=this.getMap();map.registerForEvent(Fusion.Event.MAP_RESIZED,this.resizeCanvasFn);var domObj=map.getDomObj();var size=Element.getDimensions(domObj);this.width=size.width;this.height=size.height;if(!this.canvas){this.canvas=document.createElement('canvas');if(typeof G_vmlCanvasManager!="undefined"){document.getElementsByTagName('BODY')[0].appendChild(this.canvas);G_vmlCanvasManager.initElement(this.canvas);this.canvas=document.getElementsByTagName('BODY')[0].lastChild;}
this.canvas.id='featureDigitizer';this.canvas.style.position='absolute';this.canvas.style.top='0px';this.canvas.style.left='0px';this.canvas.style.width=this.width+'px';this.canvas.style.height=this.height+'px';this.canvas.width=this.width;this.canvas.height=this.height;this.canvas.style.zIndex=99;}
domObj.appendChild(this.canvas);if(!this.context){this.context=this.canvas.getContext('2d');}
this.canvas.style.width=this.width+'px';this.canvas.style.height=this.height+'px';this.canvas.width=this.width;this.canvas.height=this.height;map.observeEvent('mousemove',this.mouseMoveCB);map.observeEvent('mouseup',this.mouseUpCB);map.observeEvent('mousedown',this.mouseDownCB);map.observeEvent('dblclick',this.dblClickCB);},resizeCanvas:function(){var map=this.getMap();var domObj=map.getDomObj();var size=Element.getDimensions(domObj);this.width=size.width;this.height=size.height;this.canvas.style.width=this.width+'px';this.canvas.style.height=this.height+'px';this.canvas.width=this.width;this.canvas.height=this.height;},deactivateCanvas:function(){var map=this.getMap();map.deregisterForEvent(Fusion.Event.MAP_RESIZED,this.resizeCanvasFn);map.getDomObj().removeChild(this.canvas);this.context.clearRect(0,0,this.width,this.height);map.stopObserveEvent('mousemove',this.mouseMoveCB);map.stopObserveEvent('mouseup',this.mouseUpCB);map.stopObserveEvent('mousedown',this.mouseDownCB);map.stopObserveEvent('dblclick',this.dblClickCB);},mouseDown:function(e){},mouseUp:function(e){},mouseMove:function(e){},dblClick:function(e){}};Fusion.Tool.Canvas.Point=Class.create();Fusion.Tool.Canvas.Point.prototype={center:null,radius:null,lineStyle:null,fillStyle:null,initialize:function(map){this.center=new Fusion.Tool.Canvas.Node(0,0,map);this.radius=5;this.lineStyle=new Fusion.Tool.Canvas.Style({lineWidth:2,strokeStyle:'rgba(0,0,0,1.0)'});this.fillStyle=new Fusion.Tool.Canvas.Style({fillStyle:'rgba(0,0,255, 0.5)'});this.segments=[];},setPoint:function(x,y){this.center.set(x,y);},getPoint:function(){this.center.updateGeo();return{x:this.center.x,y:this.center.y};},draw:function(context){var x=this.center.px;var y=this.center.py;var radius=this.radius;this.fillStyle.apply(context);this.lineStyle.apply(context);context.beginPath();context.arc(x,y,radius,0,2*Math.PI,1);context.closePath();context.fill();context.stroke();},getNodes:function(){return[this.center];},clean:function(){},updateGeo:function(){this.center.updateGeo();},updatePx:function(){this.center.updatePx();}};Fusion.Tool.Canvas.Circle=Class.create();Fusion.Tool.Canvas.Circle.prototype={map:null,center:null,radius:null,radiusPx:null,start:null,end:null,lineStyle:null,fillStyle:null,initialize:function(map){this.map=map;this.center=new Fusion.Tool.Canvas.Node(0,0,map);this.radius=1;this.lineStyle=new Fusion.Tool.Canvas.Style({lineWidth:2,strokeStyle:'rgba(0,0,0,1.0)'});this.fillStyle=new Fusion.Tool.Canvas.Style({fillStyle:'rgba(0,0,255, 0.5)'});this.segments=[];},setCenter:function(x,y){this.center.set(x,y);},setRadius:function(r){if(r>1||r<-1){this.radius=Math.abs(r);this.radiusPx=this.map.geoToPixMeasure(this.radius);}else{this.radius=1;this.radiusPx=1;}},draw:function(context){var x=this.center.px;var y=this.center.py;var radius=this.radiusPx;this.fillStyle.apply(context);this.lineStyle.apply(context);context.beginPath();if(this.start&&this.end){context.moveTo(x,y);var s=this.start;var e=this.end;if(s<e){var t=s;s=e;e=t;}
var sx=x+Math.sin(s)*radius;var sy=y-Math.cos(s)*radius;context.lineTo(sx,sy);context.arc(x,y,radius,s-Math.PI/2,e-Math.PI/2,1);context.lineTo(x,y);}else{context.arc(x,y,radius,0,2*Math.PI,1);}
context.closePath();context.fill();context.stroke();},getNodes:function(){return[this.center];},clean:function(){},updateGeo:function(){this.center.updateGeo();this.radius=this.map.pixToGeoMeasure(this.radiusPx);},updatePx:function(){this.center.updatePx();this.radiusPx=this.map.geoToPixMeasure(this.radius);}};Fusion.Tool.Canvas.Polygon=Class.create();Fusion.Tool.Canvas.Polygon.prototype={segments:null,lineStyle:null,fillStyle:null,map:null,initialize:function(map){this.map=map;this.segments=[];this.lineStyle=new Fusion.Tool.Canvas.Style({lineWidth:2,strokeStyle:'rgba(0,0,0,1.0)'});this.fillStyle=new Fusion.Tool.Canvas.Style({fillStyle:'rgba(0,0,255, 0.5)'});},clean:function(){var nodes=this.getNodes();this.segments=[];var n1=nodes[0];var n2=nodes[1];for(var i=1;i<nodes.length;i++){if(n1.x!=n2.x||n1.y!=n2.y){this.addSegment(new Fusion.Tool.Canvas.Segment(n1,n2));n1=n2;}
n2=nodes[i];}
this.addSegment(new Fusion.Tool.Canvas.Segment(n1,nodes[0]));},getNodes:function(){var nodes=[];nodes.push(this.segments[0].from);for(var i=0;i<this.segments.length;i++){nodes.push(this.segments[i].to);}
return nodes;},reverseNodes:function(){var nSegments=this.segments.length;if(!nSegments){return;}
for(var i=0;i<nSegments;i++){var seg=this.segments[i];var tmp=seg.from;seg.from=seg.to;seg.to=tmp;};this.segments.reverse();},removeNode:function(node){if(node==this.segments[0].from){this.segments[0].from=null;this.segments.shift();this.segments[0].from=this.segments[this.segments.length-1].to;return;}
if(node==this.segments[this.segments.length-1].from){this.segments[this.segments.length-1].from=null;this.segments.pop();this.segments[0].from=this.segments[this.segments.length-1].to;return;}
for(var i=1;i<this.segments.length;i++){if(node==this.segments[i].from){this.segments[i-1].to=this.segments[i].to;this.segments[i].from=null;this.segments.splice(i,1);return;}};},draw:function(context){var x=this.segments[0].from.px;var y=this.segments[0].from.py;if(this.segments.length>2){this.fillStyle.apply(context);context.beginPath();context.moveTo(x,y);for(var i=0;i<this.segments.length;i++){var s=this.segments[i];context.lineTo(s.to.px,s.to.py);}
context.lineTo(x,y);context.closePath();context.fill();}
this.lineStyle.apply(context);for(var i=0;i<this.segments.length;i++){this.segments[i].draw(context);}
var last=this.lastSegment();context.beginPath();context.moveTo(last.to.px,last.to.py);context.lineTo(x,y);context.stroke();},addSegment:function(s){s.normalStyle=this.lineStyle;this.segments[this.segments.length]=s;},lastSegment:function(){return this.segments[this.segments.length-1];},segmentTo:function(node){var margin=arguments.length>1?arguments[1]:3;for(var i=0;i<this.segments.length;i++){if(this.segments[i].hasTo(node,margin)){return this.segments[i];}}
return null;},segmentFrom:function(node){var margin=arguments.length>1?arguments[1]:3;for(var i=0;i<this.segments.length;i++){if(this.segments[i].hasFrom(node,margin)){return this.segments[i];}}
return null;},extendLine:function(){var last=this.lastSegment();var newNode=new Fusion.Tool.Canvas.Node(last.to.x,last.to.y,this.map);var newSegment=new Fusion.Tool.Canvas.Segment(last.to,newNode);this.addSegment(newSegment);return newSegment;},contains:function(node){return true;},toString:function(){var szFeature=this.segments[0].from.toString();for(var i=0;i<this.segments.length;i++){szFeature+=','+this.segments[i].to.toString();}
return'POLYGON('+szFeature+')';},updateGeo:function(){for(var i=0;i<this.segments.length;i++){this.segments[i].updateGeo();}},updatePx:function(){for(var i=0;i<this.segments.length;i++){this.segments[i].updatePx();}}};Fusion.Tool.Canvas.Line=Class.create();Fusion.Tool.Canvas.Line.prototype={segments:null,lineStyle:null,map:null,initialize:function(map){this.map=map;this.segments=[];this.lineStyle=new Fusion.Tool.Canvas.Style({strokeStyle:'rgba(0,0,0,1.0)'});},clean:function(){var nodes=this.getNodes();this.segments=[];var n1=nodes[0];var n2=nodes[1];for(var i=1;i<nodes.length;i++){n2=nodes[i];if(n1.x!=n2.x||n1.y!=n2.y){this.addSegment(new Fusion.Tool.Canvas.Segment(n1,n2));n1=n2;}}},getNodes:function(){var nodes=[];nodes.push(this.segments[0].from);for(var i=0;i<this.segments.length;i++){nodes.push(this.segments[i].to);}
return nodes;},reverseNodes:function(){var nSegments=this.segments.length;if(!nSegments){return;}
for(var i=0;i<nSegments;i++){var seg=this.segments[i];var tmp=seg.from;seg.from=seg.to;seg.to=tmp;};this.segments.reverse();},removeNode:function(node){if(node==this.segments[0].from){this.segments[0].from=null;this.segments.shift();return;}
if(node==this.segments[this.segments.length-1].from){this.segments[this.segments.length-1].from=null;this.segments.pop();return;}
for(var i=1;i<this.segments.length;i++){if(node==this.segments[i].from){this.segments[i-1].to=this.segments[i].to;this.segments[i].from=null;this.segments.splice(i,1);return;}};},draw:function(context){for(var i=0;i<this.segments.length;i++){this.segments[i].draw(context);}},addSegment:function(s){s.normalStyle=this.lineStyle;this.segments[this.segments.length]=s;},lastSegment:function(){return this.segments[this.segments.length-1];},segmentTo:function(node){var margin=arguments.length>1?arguments[1]:3;for(var i=0;i<this.segments.length;i++){if(this.segments[i].hasTo(node,margin)){return this.segments[i];}}
return null;},segmentFrom:function(node){var margin=arguments.length>1?arguments[1]:3;for(var i=0;i<this.segments.length;i++){if(this.segments[i].hasFrom(node,margin)){return this.segments[i];}}
return null;},extendLine:function(){var last=this.lastSegment();var newNode=new Fusion.Tool.Canvas.Node(last.to.x,last.to.y,this.map);var newSegment=new Fusion.Tool.Canvas.Segment(last.to,newNode);this.addSegment(newSegment);return newSegment;},updateGeo:function(){for(var i=0;i<this.segments.length;i++){this.segments[i].updateGeo();}},updatePx:function(){for(var i=0;i<this.segments.length;i++){this.segments[i].updatePx();}}};Fusion.Tool.Canvas.Segment=Class.create();Fusion.Tool.Canvas.Segment.prototype={from:null,to:null,initialize:function(from,to){this.from=from;this.to=to;this.isEditing=false;this.normalStyle=new Fusion.Tool.Canvas.Style({lineWidth:1,strokeStyle:'rgba(0,0,0,1.0)'});this.editStyle=new Fusion.Tool.Canvas.Style({lineWidth:1,strokeStyle:'rgba(255,0,0,1.0)'});},hasTo:function(node,margin){return this.to.near({x:node.px,y:node.py},margin);},hasFrom:function(node,margin){return this.from.near({x:node.px,y:node.py},margin);},intersectsPoint:function(point,margin){var minX=Math.min(this.to.px,this.from.px);var maxX=Math.max(this.to.px,this.from.px);if(point.x>maxX||point.x<minX){return false;};var maxY=Math.max(this.to.py,this.from.py);var minY=Math.min(this.to.py,this.from.py);if(point.y<minY||point.y>maxY){return false;};var slope=parseFloat((maxY-minY))/(maxX-minX);var segY=slope*(point.x-minX)+minY;return(segY-margin<point.y&&segY+margin>point.y);},setNormalStyle:function(style){this.normalStyle=style;},setEditStyle:function(style){this.editStyle=style;},draw:function(context){if(this.isEditing){this.editStyle.apply(context);}else{this.normalStyle.apply(context);}
context.beginPath();context.moveTo(this.from.px,this.from.py);context.lineTo(this.to.px,this.to.py);context.closePath();context.stroke();if(this.isEditing){this.from.draw(context);this.to.draw(context);}},setEditing:function(bEditing){this.isEditing=bEditing;},toString:function(){return this.from.toString()+', '+this.to.toString();},updateGeo:function(){this.from.updateGeo();this.to.updateGeo();},updatePx:function(){this.from.updatePx();this.to.updatePx();}};Fusion.Tool.Canvas.Node=Class.create();Fusion.Tool.Canvas.Node.prototype={x:null,y:null,px:null,py:null,uid:null,map:null,counter:[0],isSelected:false,initialize:function(x,y,map){this.map=map;this.set(x,y);var p=map.geoToPix(x,y);this.setPx(p.x,p.y);this.radius=3;this.uid=this.counter[0];this.counter[0]++;this.normalStyle=new Fusion.Tool.Canvas.Style({lineWidth:1,strokeStyle:'rgba(0,0,0,1.0)'});this.selectedStyle=new Fusion.Tool.Canvas.Style({lineWidth:1,fillStyle:'rgba(255,0,0,1.0)',strokeStyle:'rgba(255,0,0,1.0)'});},set:function(x,y){this.x=x;this.y=y;var p=this.map.geoToPix(x,y);this.setPx(p.x,p.y);},setPx:function(px,py){this.px=px;this.py=py;},updateGeo:function(){if(!this.px||!this.py){return;};var g=this.map.pixToGeo(this.px,this.py);this.set(g.x,g.y);},updatePx:function(){if(!this.x||!this.y){return;};var p=this.map.geoToPix(this.x,this.y);this.setPx(p.x,p.y);},near:function(point,tolerance){var minX=point.x-tolerance;var maxX=point.x+tolerance;var maxY=point.y+tolerance;var minY=point.y-tolerance;return((this.px>minX&&this.px<maxX)&&(this.py>minY&&this.py<maxY))?true:false;},within:function(bbox){var minX=Math.min(bbox[0],bbox[2]);var maxX=Math.max(bbox[0],bbox[2]);var minY=Math.min(bbox[1],bbox[3]);var maxY=Math.max(bbox[1],bbox[3]);return((this.px>minX&&this.px<maxX)&&(this.py>minY&&this.py<maxY))?true:false;},draw:function(context){if(this.isSelected){this.selectedStyle.apply(context);}else{this.normalStyle.apply(context);}
context.beginPath();context.arc(this.px,this.py,this.radius,0,2*Math.PI,1);context.closePath();context.stroke();if(this.isSelected){context.fill();};},setSelected:function(bSelected){this.isSelected=bSelected;},toString:function(){return'('+this.uid+') '+this.x+' ['+this.px+'px] '+this.y+' ['+this.py+'px] ';}};Fusion.Tool.Canvas.Style=Class.create();Fusion.Tool.Canvas.Style.prototype={properties:['fillStyle','globalAlpha','globalCompositeOperation','lineCap','lineJoin','lineWidth','miterLimit','shadowBlur','shadowColor','shadowOffsetX','shadowOffsetY','strokeStyle'],initialize:function(o){for(var i=0;i<this.properties.length;i++){var p=this.properties[i];this[p]=o[p]?o[p]:null;}},set:function(p,v){this[p]=v;},apply:function(context){for(var i=0;i<this.properties.length;i++){var p=this.properties[i];if(this[p]){context[p]=this[p];}}}};Fusion.Tool.Click=Class.create();Fusion.Tool.Click.prototype={initialize:function()
{this.mouseUpCB=this.mouseUp.bindAsEventListener(this);},execute:function(x,y)
{},activateClickTool:function()
{if(this.oMap){this.oMap.observeEvent('mouseup',this.mouseUpCB);}},deactivateClickTool:function()
{if(this.oMap){this.oMap.stopObserveEvent('mouseup',this.mouseUpCB);}},mouseUp:function(e)
{if(OpenLayers.Event.isLeftClick(e)){var sPixPoint=this.oMap.getEventPosition(e);this.execute(sPixPoint.x,sPixPoint.y);}}};Fusion.Tool.Rectangle=Class.create();Fusion.Tool.Rectangle.prototype={oRectDiv:null,_sStartPos:null,_bIsActive:null,initialize:function(){this.oRectDiv=document.createElement('div');this.oRectDiv.style.position='absolute';this.oRectDiv.style.border='1px solid red';this.oRectDiv.style.top='0px';this.oRectDiv.style.left='0px';this.oRectDiv.style.width='1px';this.oRectDiv.style.height='1px';this.oRectDiv.style.visibility='hidden';this.oRectDiv.style.lineHeight='1px';this.oRectDiv.style.zIndex=99;this._bIsActive=false;this.mouseMoveCB=this.mouseMove.bindAsEventListener(this);this.mouseUpCB=this.mouseUp.bindAsEventListener(this);this.mouseDownCB=this.mouseDown.bindAsEventListener(this);this.mouseOutCB=this.mouseOut.bindAsEventListener(this);},execute:function(l,b,r,t){},activateRectTool:function(){if(this._bIsActive){return;}
if(this.oMap){this.oRectDiv.style.left='0px';this.oRectDiv.style.top='0px';this.oRectDiv.style.width='1px';this.oRectDiv.style.height='1px';this.oRectDiv.style.visibility='hidden';this._bIsActive=true;var oDomElem=this.oMap.getDomObj();oDomElem.appendChild(this.oRectDiv);this.oMap.observeEvent('mousemove',this.mouseMoveCB);this.oMap.observeEvent('mouseup',this.mouseUpCB);this.oMap.observeEvent('mousedown',this.mouseDownCB);}},deactivateRectTool:function(){this._sStartPos=null;if(!this._bIsActive){return;}
this._bIsActive=false;var oDomElem=this.oMap.getDomObj();oDomElem.removeChild(this.oRectDiv);this.oMap.stopObserveEvent('mousemove',this.mouseMoveCB);this.oMap.stopObserveEvent('mouseup',this.mouseUpCB);this.oMap.stopObserveEvent('mousedown',this.mouseDownCB);},mouseDown:function(e){if(OpenLayers.Event.isLeftClick(e)){var p=this.oMap.getEventPosition(e);this._sStartPos=p;this.oRectDiv.style.left=p.x+'px';this.oRectDiv.style.top=p.y+'px';this.oRectDiv.style.width='1px';this.oRectDiv.style.height='1px';this.oRectDiv.style.visibility='visible';OpenLayers.Event.observe(document,'mouseout',this.mouseOutCB);}
OpenLayers.Event.stop(e);},mouseUp:function(e){if(this._sStartPos!=null){var t=parseInt(this.oRectDiv.style.top);var l=parseInt(this.oRectDiv.style.left);var r=l+parseInt(this.oRectDiv.style.width);var b=t+parseInt(this.oRectDiv.style.height);this.event=e;this.execute(l,b,r,t);this.oRectDiv.style.left='0px';this.oRectDiv.style.top='0px';this.oRectDiv.style.width='1px';this.oRectDiv.style.height='1px';this.oRectDiv.style.visibility='hidden';this._sStartPos=null;OpenLayers.Event.stop(e);}
OpenLayers.Event.stopObserving(document,'mouseout',this.mouseOutCB);},mouseMove:function(e){if(this._sStartPos!=null)
{var p=this.oMap.getEventPosition(e);var l=this._sStartPos.x;var t=this._sStartPos.y;var r=p.x;var b=p.y;this.oRectDiv.style.left=Math.min(l,r)+'px';this.oRectDiv.style.top=Math.min(t,b)+'px';this.oRectDiv.style.width=Math.abs(r-l)+'px';this.oRectDiv.style.height=Math.abs(t-b)+'px';OpenLayers.Event.stop(e);}},mouseOut:function(e){var target=e.target||e.srcElement;if(target.tagName.toLowerCase()=='html'){this.mouseUp(e);}}};Fusion.Tool.Search=Class.create();Fusion.Tool.Search.prototype={lastSearch:null,lastResult:null,resultOffset:0,initialize:function(){},getProperties:function(){var properties=null;if(this.lastResult&&this.lastResult.properties){properties=this.lastResult.properties;}
return properties;},getNumberOfProperties:function(){var n=0;if(this.lastResult&&this.lastResult.properties){n=this.lastResult.properties.length;}
return n;},getProperty:function(n){var property='';if(this.lastResult&&this.lastResult.properties){property=this.lastResult.properties[n];}
return property;},getNumberOfResults:function(){result=0;if(this.lastResult&&this.lastResult.values){result=this.lastResult.values.length;}
return result;},getFirstResult:function(){this.resultOffset=0;return this.getResult(this.resultOffset);},getNextResult:function(){this.resultOffset++;return this.getResult(this.resultOffset);},getResult:function(idx){result=null;if(this.lastResult&&this.lastResult.values){result=this.lastResult.values[idx];}
return result;},zoomToResult:function(filter){var filter='&filter='+filter;var s=this.getMap().arch+'/'+Fusion.getScriptLanguage()+"/Query."+Fusion.getScriptLanguage();var params={};params.parameters='session='+this.getMap().getSessionID()+'&mapname='+this.getMap().getMapName()+'&layers='+this.layerName+filter;params.onComplete=this.selectComplete.bind(this);Fusion.ajaxRequest(s,params);},selectComplete:function(r){var node=new DomNode(r.responseXML);var success=node.getNodeText('Selection');if(success=='true'){this.getMap().newSelection();this.getMap().getSelection(this.zoomToSelection.bind(this));}},zoomToSelection:function(selection){var ll=selection.getLowerLeftCoord();var ur=selection.getUpperRightCoord();var dX=ur.x-ll.x;var dY=ur.y-ll.y;ll.x=ll.x-dX;ur.x=ur.x+dX;ll.y=ll.y-dY;ur.y=ur.y+dY;this.getMap().setExtents(new OpenLayers.Bounds(ll.x,ll.y,ur.x,ur.y));}};Fusion.Event.MAP_EXTENTS_CHANGED=Fusion.Event.lastEventId++;Fusion.Event.MAP_BUSY_CHANGED=Fusion.Event.lastEventId++;Fusion.Event.MAP_GENERIC_EVENT=Fusion.Event.lastEventId++;Fusion.Event.MAP_RESIZED=Fusion.Event.lastEventId++;Fusion.Event.MAP_SELECTION_ON=Fusion.Event.lastEventId++;Fusion.Event.MAP_SELECTION_OFF=Fusion.Event.lastEventId++;Fusion.Event.MAP_ACTIVE_LAYER_CHANGED=Fusion.Event.lastEventId++;Fusion.Event.MAP_LOADED=Fusion.Event.lastEventId++;Fusion.Event.MAP_LOADING=Fusion.Event.lastEventId++;Fusion.Event.MAP_RELOADED=Fusion.Event.lastEventId++;Fusion.Event.MAP_SESSION_CREATED=Fusion.Event.lastEventId++;Fusion.Constant.LAYER_POINT_TYPE=0;Fusion.Constant.LAYER_LINE_TYPE=1;Fusion.Constant.LAYER_POLYGON_TYPE=2;Fusion.Constant.LAYER_SOLID_TYPE=3;Fusion.Constant.LAYER_RASTER_TYPE=4;Fusion.Constant.LAYER_DWF_TYPE=5;Fusion.Widget.Map=Class.create();Fusion.Widget.Map.prototype={_oDomObj:null,_sDomObj:'',_sMapname:'',_nWidth:-1,_nHeight:-1,_fMetersperunit:-1,_fScale:-1,_nDpi:96,_oCurrentExtents:null,_oInitialExtents:null,_nWorkers:0,oContextMenu:null,bSupressContextMenu:false,aMaps:null,layerRoot:null,singleTile:true,initialize:function(widgetTag,mapGroup,widgetSet){Object.inheritFrom(this,Fusion.Lib.EventMgr,[]);this.widgetTag=widgetTag;var name=widgetTag.name;this.widgetSet=widgetSet;this._nCellSize=-1;this._sDomObj=name;this._oDomObj=$(this._sDomObj);this.layerRoot=new Fusion.Widget.Map.Group();if(this._oDomObj.jxLayout){this._oDomObj.jxLayout.addSizeChangeListener(this);}
OpenLayers.DOTS_PER_INCH=this._nDpi;if(!this.oMapOL){var options={controls:[],fallThrough:true};if(widgetTag.extension.ConstrainMapExtent){this.bRestrictExtent=widgetTag.extension.ConstrainMapExtent[0]=='true'?true:false;}
this.oMapOL=new OpenLayers.Map(this._sDomObj,options);}
this.oMapOL.viewPortDiv.style.position='absolute';var useMouseWheel=true;if(widgetTag.extension.DisableMouseWheel&&widgetTag.extension.DisableMouseWheel[0]=='true'){useMouseWheel=false;}
if(useMouseWheel){this.wheelHandler=new OpenLayers.Handler.MouseWheel(this,{"up":this.wheelUp,"down":this.wheelDown});this.wheelHandler.map=this.oMapOL;this.wheelHandler.activate();}
this.aMaps=[];this.mapGroup=mapGroup;for(var i=0;i<mapGroup.maps.length;++i){var mapTag=mapGroup.maps[i];if(Fusion.Maps[mapTag.type]){this.aMaps[i]=eval("new Fusion.Maps."+mapTag.type+"(this,mapTag)");this.layerRoot.addGroup(this.aMaps[i].layerRoot);}else{}}
$(name).widget=this;this.registerEventID(Fusion.Event.MAP_EXTENTS_CHANGED);this.registerEventID(Fusion.Event.MAP_BUSY_CHANGED);this.registerEventID(Fusion.Event.MAP_GENERIC_EVENT);this.registerEventID(Fusion.Event.MAP_RESIZED);this.registerEventID(Fusion.Event.MAP_ACTIVE_LAYER_CHANGED);this.registerEventID(Fusion.Event.MAP_LOADED);this.registerEventID(Fusion.Event.MAP_LOADING);this.registerEventID(Fusion.Event.MAP_RELOADED);this.registerEventID(Fusion.Event.MAP_SELECTION_ON);this.registerEventID(Fusion.Event.MAP_SELECTION_OFF);this.oMapOL.events.register('moveend',this,this.mapExtentsChanged);this._oDomObj.oncontextmenu=function(){return false;};OpenLayers.Event.observe(this._oDomObj,'contextmenu',this.onContextMenu.bind(this));this.aSelectionCallbacks=[];this.bFetchingSelection=false;},setMenu:function(){if(this.widgetTag.extension.MenuContainer){var contextMenu=new Jx.ContextMenu();var container=this.widgetSet.getContainerByName(this.widgetTag.extension.MenuContainer[0]);if(container){container.createWidgets(this.widgetSet,contextMenu);this.setContextMenu(contextMenu);}}},loadMapGroup:function(mapGroup){while(this.isBusy()){this._removeWorker();}
this.clearSelection();this.mapGroup=mapGroup;for(var i=0;i<this.aMaps.length;i++){this.aMaps[i].oLayerOL.destroy();}
this.aMaps=[];this.layerRoot=new Fusion.Widget.Map.Group();for(var i=0;i<mapGroup.maps.length;++i){var mapTag=mapGroup.maps[i];if(Fusion.Maps[mapTag.type]){this.aMaps[i]=eval("new Fusion.Maps."+mapTag.type+"(this,mapTag)");this.layerRoot.addGroup(this.aMaps[i].layerRoot);}else{}}},wheelChange:function(evt,deltaZ){var size=this.oMapOL.getSize();var deltaX=size.w/2-evt.xy.x;var deltaY=evt.xy.y-size.h/2;var deltaRes=deltaZ>0?0.5:2;var newRes=this.oMapOL.baseLayer.getResolution()*deltaRes;var zoomPoint=this.oMapOL.getLonLatFromPixel(evt.xy);var newCenter=new OpenLayers.LonLat(zoomPoint.lon+deltaX*newRes,zoomPoint.lat+deltaY*newRes);var newBounds=new OpenLayers.Bounds(newCenter.lon-size.w*newRes/2,newCenter.lat-size.h*newRes/2,newCenter.lon+size.w*newRes/2,newCenter.lat+size.h*newRes/2);this.setExtents(newBounds);},wheelUp:function(evt){this.wheelChange(evt,1);},wheelDown:function(evt){this.wheelChange(evt,-1);},getDomObj:function(){return this._oDomObj;},getMapName:function(){return this.aMaps[0].getMapName();},getMapTitle:function(){return this.aMaps[0]._sMapTitle;},getSessionID:function(){return this.aMaps[0].getSessionID();},getDomId:function(){return this._sDomObj;},setMapOptions:function(options){this.oMapOL.setOptions(options);},addMap:function(map){if(!map.bSingleTile){this.singleTile=false;}
this.projection=map.projection;if(this.bRestrictExtent!=null){if(this.bRestrictExtent){this.oMapOL.restrictedExtent=map._oMaxExtent;}else{this.oMapOL.restrictedExtent=false;}}
this.oMapOL.addLayer(map.oLayerOL);map.registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.selectionHandler.bind(this));map.registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.selectionHandler.bind(this));},getAllMaps:function(){return this.aMaps;},reloadMap:function(){for(var i=0;i<this.aMaps.length;++i){var map=this.aMaps[i];window.setTimeout(map.reloadMap.bind(map),1);}},query:function(options){for(var i=0;i<this.aMaps.length;i++){if(this.aMaps[i].query(options)){}}},selectionHandler:function(){if(this.hasSelection()){this.triggerEvent(Fusion.Event.MAP_SELECTION_ON);}else{this.triggerEvent(Fusion.Event.MAP_SELECTION_OFF);}},hasSelection:function(){for(var i=0;i<this.aMaps.length;i++){if(this.aMaps[i].hasSelection()){return true;}}
return false;},clearSelection:function(){this.oSelection=null;for(var i=0;i<this.aMaps.length;i++){this.aMaps[i].clearSelection();}},getSelection:function(callback,layers,startcount){var layers=(arguments[1])?arguments[1]:'';var startcount=(arguments[2])?arguments[2]:'';this.aSelectionCallbacks.push(callback);if(this.bFetchingSelection){return;}
this.bFetchingSelection=true;this.oSelection={};this.nSelectionMaps=0;for(var i=0;i<this.aMaps.length;i++){this.nSelectionMaps++;this.aMaps[i].getSelection(this.accumulateSelection.bind(this,this.aMaps[i]),layers,startcount);}},setSelection:function(selText,requery,zoomTo){for(var i=0;i<this.aMaps.length;i++){this.aMaps[i].setSelection(selText,requery,zoomTo);}},accumulateSelection:function(map,oSelection){this.oSelection[map._sMapname]=oSelection;if(!--this.nSelectionMaps){this.bFetchingSelection=false;for(var i=0;i<this.aSelectionCallbacks.length;i++){this.aSelectionCallbacks[i](this.oSelection);}
this.aSelectionCallbacks=[];}},setActiveLayer:function(oLayer){this.oActiveLayer=oLayer;this.oActiveMap=oLayer.map;this.triggerEvent(Fusion.Event.MAP_ACTIVE_LAYER_CHANGED,oLayer);},getActiveLayer:function(){return this.oActiveLayer;},_addWorker:function(){this._nWorkers+=1;this.triggerEvent(Fusion.Event.MAP_BUSY_CHANGED,this);this._oDomObj.style.cursor='wait';},_removeWorker:function(){if(this._nWorkers>0){this._nWorkers-=1;}
this.setCursor(this.cursor);this.triggerEvent(Fusion.Event.MAP_BUSY_CHANGED,this);},mapExtentsChanged:function(){this._oCurrentExtents=this.oMapOL.getExtent();this.triggerEvent(Fusion.Event.MAP_EXTENTS_CHANGED);},isBusy:function(){return this._nWorkers>0;},sizeChanged:function(){this.resize();},resize:function(){this.oMapOL.updateSize();var d=Element.getDimensions(this.getDomObj());this._nWidth=d.width;this._nHeight=d.height;if(this._oCurrentExtents){this.setExtents(this._oCurrentExtents);}else if(this._oInitialExtents){this.setExtents(this._oInitialExtents);}
this.triggerEvent(Fusion.Event.MAP_RESIZED,this);},redraw:function(){for(var i=0;i<this.aMaps.length;i++){this.aMaps[i].oLayerOL.params.ts=(new Date()).getTime();}
this.oMapOL.setCenter(this.oMapOL.getCenter(),this.oMapOL.getZoom(),false,true);},setExtents:function(oExtents){if(!oExtents){Fusion.reportError(new Fusion.Error(Fusion.Error.WARNING,OpenLayers.String.translate('nullExtents')));}
if(oExtents instanceof Array&&oExtents.length==4){oExtents=new OpenLayers.Bounds(oExtents[0],oExtents[1],oExtents[2],oExtents[3]);}
if(this.aMaps[0].bSingleTile){var viewSize=this.oMapOL.getSize();var idealResolution=Math.max(oExtents.getWidth()/viewSize.w,oExtents.getHeight()/viewSize.h,this.oMapOL.baseLayer.minResolution);idealResolution=Math.min(idealResolution,this.oMapOL.baseLayer.maxResolution);this.oMapOL.baseLayer.resolutions=[idealResolution];this.oMapOL.zoom=1;}
for(var i=0;i<this.aMaps.length;i++){this.aMaps[i].oLayerOL.params.ts=(new Date()).getTime();}
this.oMapOL.zoomToExtent(oExtents);},fullExtents:function(){if(!this._oInitialExtents){var bbox=Fusion.getQueryParam("extent");if(bbox){this._oInitialExtents=new OpenLayers.Bounds.fromArray(bbox.split(","));}else if(this.mapGroup.initialView){var iv=this.mapGroup.getInitialView();if(iv.x){this._oInitialExtents=this.getExtentFromPoint(iv.x,iv.y,iv.scale);}else if(iv.minX){this._oInitialExtents=new OpenLayers.Bounds(iv.minX,iv.minY,iv.maxX,iv.maxY);}}else{var viewSize=this.oMapOL.getSize();var oExtents=this.oMapOL.getMaxExtent();var center=oExtents.getCenterLonLat();var initRes=Math.max(oExtents.getWidth()/viewSize.w,oExtents.getHeight()/viewSize.h);var w_deg=viewSize.w*initRes/2;var h_deg=viewSize.h*initRes/2;this._oInitialExtents=new OpenLayers.Bounds(center.lon-w_deg,center.lat-h_deg,center.lon+w_deg,center.lat+h_deg);}}
this.setExtents(this._oInitialExtents);},isMapLoaded:function(){return(this._oCurrentExtents)?true:false;},zoom:function(fX,fY,nFactor){var extent=this.oMapOL.getExtent();var fDeltaX=extent.right-extent.left;var fDeltaY=extent.top-extent.bottom;var fMinX,fMaxX,fMinY,fMaxY;if(nFactor==1||nFactor==0){fMinX=fX-(fDeltaX/2);fMaxX=fX+(fDeltaX/2);fMinY=fY-(fDeltaY/2);fMaxY=fY+(fDeltaY/2);}else if(nFactor>0){fMinX=fX-(fDeltaX/2/nFactor);fMaxX=fX+(fDeltaX/2/nFactor);fMinY=fY-(fDeltaY/2/nFactor);fMaxY=fY+(fDeltaY/2/nFactor);}else if(nFactor<0){fMinX=fX-((fDeltaX/2)*Math.abs(nFactor));fMaxX=fX+((fDeltaX/2)*Math.abs(nFactor));fMinY=fY-((fDeltaY/2)*Math.abs(nFactor));fMaxY=fY+((fDeltaY/2)*Math.abs(nFactor));}
this.setExtents(new OpenLayers.Bounds(fMinX,fMinY,fMaxX,fMaxY));},zoomToScale:function(fScale){var center=this.getCurrentCenter();var extent=this.getExtentFromPoint(center.x,center.y,fScale);this.setExtents(extent);},queryRect:function(fMinX,fMinY,fMaxX,fMaxY){},queryPoint:function(fX,fY){},pixToGeo:function(pX,pY){var lonLat=this.oMapOL.getLonLatFromPixel(new OpenLayers.Pixel(pX,pY));if(lonLat!=null){return{x:lonLat.lon,y:lonLat.lat};}
return null;},geoToPix:function(gX,gY){if(!(this._oCurrentExtents)){return null;}
var px=this.oMapOL.getPixelFromLonLat(new OpenLayers.LonLat(gX,gY));return{x:Math.floor(px.x),y:Math.floor(px.y)};},pixToGeoMeasure:function(nPixels){var resolution=this.oMapOL.getResolution();return(nPixels*resolution);},geoToPixMeasure:function(fGeo){return parseInt(fGeo/this.oMapOL.getResolution());},getCurrentCenter:function(){var c=this.getCurrentExtents().getCenterLonLat();return{x:c.lon,y:c.lat};},getCurrentExtents:function(){return this.oMapOL.getExtent();},getInitialExtents:function(){return this._oInitialExtents;},getExtentFromPoint:function(fX,fY,fScale){if(!fScale){fScale=this.getScale();}
var res=OpenLayers.Util.getResolutionFromScale(fScale,this.oMapOL.baseLayer.units);var size=this.getSize();var w_deg=size.w*res;var h_deg=size.h*res;return new OpenLayers.Bounds(fX-w_deg/2,fY-h_deg/2,fX+w_deg/2,fY+h_deg/2);},getScale:function(){return this.oMapOL.getScale();},getUnits:function(){return this.oMapOL.baseLayer.units;},getSize:function(){return this.oMapOL.getSize();},getEventPosition:function(e){return this.oMapOL.events.getMousePosition(e);},setCursor:function(cursor){this.cursor=cursor;if(this.isBusy()){return;}
if(cursor&&cursor.length&&typeof cursor=='object'){for(var i=0;i<cursor.length;i++){this._oDomObj.style.cursor=cursor[i];if(this._oDomObj.style.cursor==cursor[i]){break;}}}else if(typeof cursor=='string'){this._oDomObj.style.cursor=cursor;}else{this._oDomObj.style.cursor='auto';}},observeEvent:function(sEventName,fnCB)
{OpenLayers.Event.observe(this._oDomObj,sEventName,fnCB,false);},stopObserveEvent:function(sEventName,fnCB)
{OpenLayers.Event.stopObserving(this._oDomObj,sEventName,fnCB,false);},activateWidget:function(oWidget)
{if(oWidget.isMutEx()){if(this.oActiveWidget){this.deactivateWidget(this.oActiveWidget);}
oWidget.activate();this.oActiveWidget=oWidget;}else{oWidget.activate();}},deactivateWidget:function(oWidget)
{oWidget.deactivate();this.oActiveWidget=null;},isLoaded:function(){return(this.oMapOL.getExtent()!=null);},supressContextMenu:function(bSupress){this.bSupressContextMenu=bSupress;},setContextMenu:function(menu){this.oContextMenu=menu;},onContextMenu:function(e){if(this.oContextMenu&&!this.bSupressContextMenu&&this.isLoaded()){this.oContextMenu.show(e);this.contextMenuPosition=this.getEventPosition(e);OpenLayers.Event.stop(e);}},executeFromContextMenu:function(widget){widget.execute(this.contextMenuPosition.x,this.contextMenuPosition.y);}};Fusion.Event.LAYER_PROPERTY_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget.Map.Layer=Class.create();Fusion.Widget.Map.Layer.prototype={name:null,initialize:function(name){Object.inheritFrom(this,Fusion.Lib.EventMgr,[]);this.name=name;this.registerEventID(Fusion.Event.LAYER_PROPERTY_CHANGED);},clear:function(){},set:function(property,value){this[property]=value;this.triggerEvent(Fusion.Event.LAYER_PROPERTY_CHANGED,this);}};Fusion.Event.GROUP_PROPERTY_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget.Map.Group=Class.create();Fusion.Widget.Map.Group.prototype={name:null,groups:null,layers:null,initialize:function(name){Object.inheritFrom(this,Fusion.Lib.EventMgr,[]);this.name=name;this.groups=[];this.layers=[];this.registerEventID(Fusion.Event.GROUP_PROPERTY_CHANGED);},clear:function(){for(var i=0;i<this.groups.length;i++){this.groups[i].clear();}
for(var i=0;i<this.layers.length;i++){this.layers[i].clear();}
this.groups=[];this.layers=[];},set:function(property,value){this[property]=value;this.triggerEvent(Fusion.Event.GROUP_PROPERTY_CHANGED,this);},addGroup:function(group,reverse){group.parentGroup=this;if(reverse){this.groups.unshift(group);}else{this.groups.push(group);}},addLayer:function(layer,reverse){layer.parentGroup=this;if(reverse){this.layers.unshift(layer);}else{this.layers.push(layer);}},findGroup:function(name){return this.findGroupByAttribute('name',name);},findGroupByAttribute:function(attribute,value){if(this[attribute]==value){return this;}
for(var i=0;i<this.groups.length;i++){var group=this.groups[i].findGroupByAttribute(attribute,value);if(group){return group;}}
return null;},findLayer:function(name){return this.findLayerByAttribute('name',name);},findLayerByAttribute:function(attribute,value){for(var i=0;i<this.layers.length;i++){if(this.layers[i][attribute]==value){return this.layers[i];}}
for(var i=0;i<this.groups.length;i++){var layer=this.groups[i].findLayerByAttribute(attribute,value);if(layer){return layer;}}
return null;}};var GxSelectionObject=Class.create();GxSelectionObject.prototype={aLayers:null,initialize:function(o)
{this.aLayers=[];this.nTotalElements=0;this.nLayers=0;if(o.layers&&o.layers.length>0)
{this.fMinX=o.extents.minx;this.fMinY=o.extents.miny;this.fMaxX=o.extents.maxx;this.fMaxY=o.extents.maxy;this.nLayers=o.layers.length;for(var i=0;i<o.layers.length;i++)
{this.aLayers[i]=new GxSelectionObjectLayer(o,o.layers[i]);}}},getNumElements:function()
{return this.nTotalElements;},getLowerLeftCoord:function()
{return{x:this.fMinX,y:this.fMinY};},getUpperRightCoord:function()
{return{x:this.fMaxX,y:this.fMaxY};},getNumLayers:function()
{return this.nLayers;},getLayerByName:function(name)
{var oLayer=null;for(var i=0;i<this.nLayers;i++)
{if(this.aLayers[i].getName()==name)
{oLayer=this.aLayers[i];break;}}
return oLayer;},getLayer:function(iIndice)
{if(iIndice>=0&&iIndice<this.nLayers)
{return this.aLayers[iIndice];}
else
{return null;}}};var GxSelectionObjectLayer=Class.create();GxSelectionObjectLayer.prototype={sName:null,nElements:null,aElements:null,nProperties:null,aPropertiesName:null,aPropertiesTypes:null,type:null,area:null,distance:null,bbox:null,center:null,initialize:function(o,layerName)
{this.sName=layerName;this.nElements=o[layerName].numelements;this.aElements=[];this.nProperties=o[layerName].propertynames.length;this.aPropertiesName=[];this.aPropertiesName=o[layerName].propertynames;this.aPropertiesTypes=[];this.aPropertiesTypes=o[layerName].propertytypes;this.area=0;this.distance=0;for(var i=0;i<o[layerName].values.length;i++)
{this.aElements[i]=[];for(var j=0;j<o[layerName].values[i].length;j++)
{this.aElements[i][j]=o[layerName].values[i][j];}}},getName:function()
{return this.sName;},getNumElements:function()
{return this.nElements;},getNumProperties:function()
{return this.nProperties;},getPropertyNames:function()
{return this.aPropertiesName;},getPropertyTypes:function()
{return this.aPropertiesTypes;},getElementValue:function(iElement,iProperty)
{if(iElement>=0&&iElement<this.nElements&&iProperty>=0&&iProperty<this.nProperties)
{return this.aElements[iElement][iProperty];}
else
{return null;}}};Fusion.Maps.MapGuide=Class.create();Fusion.Maps.MapGuide.prototype={arch:'MapGuide',session:[null],bSingleTile:null,aShowLayers:null,aHideLayers:null,aShowGroups:null,aHideGroups:null,aRefreshLayers:null,sActiveLayer:null,selectionType:'INTERSECTS',bSelectionOn:false,oSelection:null,bDisplayInLegend:true,bExpandInLegend:true,bMapLoaded:false,bIsMapWidgetLayer:true,bLayersReversed:false,_sResourceId:null,initialize:function(map,mapTag,isMapWidgetLayer){Object.inheritFrom(this,Fusion.Lib.EventMgr,[]);this.registerEventID(Fusion.Event.MAP_SESSION_CREATED);this.registerEventID(Fusion.Event.MAP_SELECTION_ON);this.registerEventID(Fusion.Event.MAP_SELECTION_OFF);this.registerEventID(Fusion.Event.MAP_LOADED);this.registerEventID(Fusion.Event.MAP_LOADING);this.mapWidget=map;this.oSelection=null;if(isMapWidgetLayer!=null){this.bIsMapWidgetLayer=isMapWidgetLayer;}
var extension=mapTag.extension;this.selectionType=extension.SelectionType?extension.SelectionType[0]:'INTERSECTS';this.ratio=extension.MapRatio?extension.MapRatio[0]:1.0;this.sMapResourceId=mapTag.resourceId?mapTag.resourceId:'';rootOpts={displayInLegend:this.bDisplayInLegend,expandInLegend:this.bExpandInLegend,legendLabel:this._sMapname,groupName:'layerRoot'};this.layerRoot=new Fusion.Maps.MapGuide.Group(rootOpts,this);this.bSingleTile=mapTag.singleTile;this.keepAliveInterval=parseInt(extension.KeepAliveInterval?extension.KeepAliveInterval[0]:300);var sid=Fusion.sessionId;if(sid){this.session[0]=sid;this.mapSessionCreated();}else{this.createSession();}},createSession:function(){if(!this.session[0]){this.session[0]=this;var sl=Fusion.getScriptLanguage();var scriptURL=this.arch+'/'+sl+'/CreateSession.'+sl;var options={onComplete:this.createSessionCB.bind(this)};Fusion.ajaxRequest(scriptURL,options);}
if(this.session[0]instanceof Fusion.Maps.MapGuide){this.session[0].registerForEvent(Fusion.Event.MAP_SESSION_CREATED,this.mapSessionCreated.bind(this));}else{this.mapSessionCreated();}},createSessionCB:function(r,json){if(r.status==200&&json){var o;eval('o='+r.responseText);this.session[0]=o.sessionId;this.triggerEvent(Fusion.Event.MAP_SESSION_CREATED);}},mapSessionCreated:function(){if(this.sMapResourceId!=''){this.loadMap(this.sMapResourceId);}
window.setInterval(this.pingServer.bind(this),this.keepAliveInterval*1000);},sessionReady:function(){return(typeof this.session[0]=='string');},getSessionID:function(){return this.session[0];},getMapName:function(){return this._sMapname;},getMapTitle:function(){return this._sMapTitle;},loadMap:function(resourceId,options){this.bMapLoaded=false;if(this._sResourceId==resourceId){return;}
if(!this.sessionReady()){this.sMapResourceId=resourceId;return;}
if(this.bIsMapWidgetLayer){this.mapWidget.triggerEvent(Fusion.Event.MAP_LOADING);}else{this.triggerEvent(Fusion.Event.MAP_LOADING);}
this.mapWidget._addWorker();this._fScale=-1;this._nDpi=96;options=options||{};this._oMaxExtent=null;this.aShowLayers=options.showlayers||[];this.aHideLayers=options.hidelayers||[];this.aShowGroups=options.showgroups||[];this.aHideGroups=options.hidegroups||[];this.aRefreshLayers=options.refreshlayers||[];this.aLayers=[];this.oSelection=null;this.aSelectionCallbacks=[];this._bSelectionIsLoading=false;var sl=Fusion.getScriptLanguage();var loadmapScript=this.arch+'/'+sl+'/LoadMap.'+sl;var sessionid=this.getSessionID();var params='mapid='+resourceId+"&session="+sessionid;var options={onSuccess:this.mapLoaded.bind(this),parameters:params};Fusion.ajaxRequest(loadmapScript,options);},mapLoaded:function(r,json){if(json){var o;eval('o='+r.responseText);this._sResourceId=o.mapId;this._sMapname=o.mapName;this._sMapTitle=o.mapTitle;this._fMetersperunit=o.metersPerUnit;this.mapWidget._fMetersperunit=this._fMetersperunit;this._oMaxExtent=OpenLayers.Bounds.fromArray(o.extent);this.layerRoot.clear();this.layerRoot.legendLabel=this._sMapTitle;this.parseMapLayersAndGroups(o);this.minScale=1.0e10;this.maxScale=0;for(var i=0;i<this.aLayers.length;i++){this.minScale=Math.min(this.minScale,this.aLayers[i].minScale);this.maxScale=Math.max(this.maxScale,this.aLayers[i].maxScale);}
if(this.minScale<=0){this.minScale=1.0;}
for(var i=0;i<this.aShowLayers.length;i++){var layer=this.layerRoot.findLayerByAttribute('layerName',this.aShowLayers[i]);if(layer){this.aShowLayers[i]=layer.uniqueId;}else{this.aShowLayers[i]='';}}
for(var i=0;i<this.aHideLayers.length;i++){var layer=this.layerRoot.findLayerByAttribute('layerName',this.aHideLayers[i]);if(layer){this.aHideLayers[i]=layer.uniqueId;}else{this.aHideLayers[i]='';}}
for(var i=0;i<this.aShowGroups.length;i++){var group=this.layerRoot.findGroupByAttribute('groupName',this.aShowGroups[i]);if(group){this.aShowGroups[i]=group.uniqueId;}else{this.aShowGroups[i]='';}}
for(var i=0;i<this.aHideGroups.length;i++){var group=this.layerRoot.findGroupByAttribute('groupName',this.aHideGroups[i]);if(group){this.aHideGroups[i]=group.uniqueId;}else{this.aHideGroups[i]='';}}
if(!this.bSingleTile){if(o.groups.length>0){this.bSingleTile=false;this.groupName=o.groups[0].groupName}else{this.bSingleTile=true;}}
this.units=this.getClosestUnits(o.metersPerUnit);if(o.FiniteDisplayScales&&o.FiniteDisplayScales.length>0){this.scales=o.FiniteDisplayScales;}
if(this.oLayerOL){this.oLayerOL.events.unregister("loadstart",this,this.loadStart);this.oLayerOL.events.unregister("loadend",this,this.loadEnd);this.oLayerOL.events.unregister("loadcancel",this,this.loadEnd);this.oLayerOL.destroy();}
this.oLayerOL=this.createOLLayer(this._sMapname,true,this.bSingleTile);this.oLayerOL.events.register("loadstart",this,this.loadStart);this.oLayerOL.events.register("loadend",this,this.loadEnd);this.oLayerOL.events.register("loadcancel",this,this.loadEnd);if(this.bIsMapWidgetLayer){this.mapWidget.addMap(this);this.mapWidget.oMapOL.setBaseLayer(this.oLayerOL);this.mapWidget._oInitialExtents=null;this.mapWidget.fullExtents();this.mapWidget.triggerEvent(Fusion.Event.MAP_LOADED);}else{this.triggerEvent(Fusion.Event.MAP_LOADED);}
this.bMapLoaded=true;}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.String.translate('mapLoadError',r.responseText)));}
this.mapWidget._removeWorker();},getClosestUnits:function(metrsPerUnit){var units="degrees";var minDiff=100000000;for(var key in OpenLayers.INCHES_PER_UNIT)
{var newDiff=Math.abs((metrsPerUnit*39.3701)-OpenLayers.INCHES_PER_UNIT[key]);if(newDiff<minDiff)
{minDiff=newDiff;units=key;}}
return units;},reloadMap:function(){this.mapWidget._addWorker();this.aShowLayers=[];this.aHideLayers=[];this.aShowGroups=[];this.aHideGroups=[];this.aRefreshLayers=[];this.layerRoot.clear();this.oldLayers=this.aLayers.clone();this.aLayers=[];var sl=Fusion.getScriptLanguage();var loadmapScript=this.arch+'/'+sl+'/LoadMap.'+sl;var sessionid=this.getSessionID();var params='mapname='+this._sMapname+"&session="+sessionid;var options={onSuccess:this.mapReloaded.bind(this),onException:this.reloadFailed.bind(this),parameters:params};Fusion.ajaxRequest(loadmapScript,options);},reloadFailed:function(r){Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.String.translate('mapLoadError',r.transport.responseText)));this.mapWidget._removeWorker();},mapReloaded:function(r,json){if(json){var o;eval('o='+r.responseText);this.parseMapLayersAndGroups(o);for(var i=0;i<this.aLayers.length;++i){var newLayer=this.aLayers[i];for(var j=0;j<this.oldLayers.length;++j){if(this.oldLayers[j].uniqueId==newLayer.uniqueId){newLayer.selectedFeatureCount=this.oldLayers[j].selectedFeatureCount;break;}}}
this.oldLayers=null;this.mapWidget.triggerEvent(Fusion.Event.MAP_RELOADED);this.drawMap();}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.String.translate('mapLoadError',r.responseText)));}
this.mapWidget._removeWorker();},reorderLayers:function(aLayerIndex){var sl=Fusion.getScriptLanguage();var loadmapScript=this.arch+'/'+sl+'/SetLayers.'+sl;var sessionid=this.getSessionID();var params='mapname='+this._sMapname+"&session="+sessionid;params+='&layerindex='+aLayerIndex.join();var options={onSuccess:this.mapLayersReset.bind(this,aLayerIndex),parameters:params};Fusion.ajaxRequest(loadmapScript,options);},mapLayersReset:function(aLayerIndex,r,json){if(json){var o;eval('o='+r.responseText);if(o.success){var layerCopy=this.aLayers.clone();this.aLayers=[];this.aVisibleLayers=[];for(var i=0;i<aLayerIndex.length;++i){this.aLayers.push(layerCopy[aLayerIndex[i]]);if(this.aLayers[i].visible){this.aVisibleLayers.push(this.aLayers[i].layerName);}}
this.drawMap();this.triggerEvent(Fusion.Event.MAP_LAYER_ORDER_CHANGED);}else{alert(OpenLayers.String.translate('setLayersError',o.layerindex));}}},parseMapLayersAndGroups:function(o){for(var i=0;i<o.groups.length;i++){var group=new Fusion.Maps.MapGuide.Group(o.groups[i],this);var parent;if(group.parentUniqueId!=''){parent=this.layerRoot.findGroupByAttribute('uniqueId',group.parentUniqueId);}else{parent=this.layerRoot;}
parent.addGroup(group,this.bLayersReversed);}
for(var i=0;i<o.layers.length;i++){var layer=new Fusion.Maps.MapGuide.Layer(o.layers[i],this);var parent;if(layer.parentGroup!=''){parent=this.layerRoot.findGroupByAttribute('uniqueId',layer.parentGroup);}else{parent=this.layerRoot;}
parent.addLayer(layer,this.bLayersReversed);this.aLayers.push(layer);}},drawMap:function(){if(!this.bMapLoaded){return;}
var options={showLayers:this.aShowLayers.length>0?this.aShowLayers.toString():null,hideLayers:this.aHideLayers.length>0?this.aHideLayers.toString():null,showGroups:this.aShowGroups.length>0?this.aShowGroups.toString():null,hideGroups:this.aHideGroups.length>0?this.aHideGroups.toString():null,refreshLayers:this.aRefreshLayers.length>0?this.aRefreshLayers.toString():null};this.aShowLayers=[];this.aHideLayers=[];this.aShowGroups=[];this.aHideGroups=[];this.aRefreshLayers=[];this.oLayerOL.addOptions(options);this.oLayerOL.mergeNewParams({ts:(new Date()).getTime()});if(this.queryLayer)this.queryLayer.redraw();},createOLLayer:function(layerName,bIsBaseLayer,bSingleTile){var layerOptions={units:this.units,isBaseLayer:bIsBaseLayer,maxExtent:this._oMaxExtent,maxResolution:'auto',ratio:this.ratio};if(this.scales&&this.scales.length>0){layerOptions.scales=this.scales;}
if(this.maxScale!=Infinity){layerOptions.minScale=this.maxScale;}
layerOptions.maxScale=this.minScale;layerOptions.singleTile=bSingleTile;var params={};if(bSingleTile){params={session:this.getSessionID(),mapname:this._sMapname};layerOptions.showLayers=this.aShowLayers.length>0?this.aShowLayers.toString():null;layerOptions.hideLayers=this.aHideLayers.length>0?this.aHideLayers.toString():null;layerOptions.showGroups=this.aShowGroups.length>0?this.aShowGroups.toString():null;layerOptions.hideGroups=this.aHideGroups.length>0?this.aHideGroups.toString():null;layerOptions.refreshLayers=this.aRefreshLayers.length>0?this.aRefreshLayers.toString():null;}else{params={mapdefinition:this._sResourceId,basemaplayergroupname:this.groupName};}
var url=Fusion.getConfigurationItem('mapguide','mapAgentUrl');var oLayerOL=new OpenLayers.Layer.MapGuide(layerName,url,params,layerOptions);return oLayerOL;},isMapLoaded:function(){return this.bMapLoaded;},hasSelection:function(){return this.bSelectionOn;},getSelectionCB:function(userFunc,layers,startend,r,json){if(json)
{var o;eval("o="+r.responseText);var oSelection=new GxSelectionObject(o);userFunc(oSelection);}},newSelection:function(){if(this.oSelection){this.oSelection=null;}
this.bSelectionOn=true;this.drawMap();this.triggerEvent(Fusion.Event.MAP_SELECTION_ON);},getSelectedFeatureCount:function(){var total=0;for(var j=0;j<this.aLayers.length;++j){total+=this.aLayers[j].selectedFeatureCount;}
return total;},getSelectedLayers:function(){var layers=[];for(var j=0;j<this.aLayers.length;++j){if(this.aLayers[j].selectedFeatureCount>0){layers.push(this.aLayers[j]);}}
return layers;},getSelectableLayers:function(){var layers=[];for(var j=0;j<this.aLayers.length;++j){if(this.aLayers[j].selectable){layers.push(this.aLayers[j]);}}
return layers;},zoomToSelection:function(r){var xmlDoc=r.responseXML.documentElement;var x=xmlDoc.getElementsByTagName('X');var y=xmlDoc.getElementsByTagName('Y');var extent=new OpenLayers.Bounds(x[0].firstChild.nodeValue,y[0].firstChild.nodeValue,x[1].firstChild.nodeValue,y[1].firstChild.nodeValue);var center=extent.getCenterPixel();var size=extent.getSize();extent.left=center.x-2*size.w;extent.right=center.x+2*size.w;extent.bottom=center.y-2*size.h;extent.top=center.y+2*size.h;this.mapWidget.setExtents(extent);},processSelection:function(sel,requery,zoomTo,json){if(requery){}
if(zoomTo){var mgRequest=new Fusion.Lib.MGRequest.MGGetFeatureSetEnvelope(this.getSessionID(),this.getMapName(),sel);Fusion.oBroker.dispatchRequest(mgRequest,this.zoomToSelection.bind(this));}else{this.mapWidget.redraw();}},setSelection:function(selText,requery,zoomTo){var sl=Fusion.getScriptLanguage();var setSelectionScript=this.arch+'/'+sl+'/SetSelection.'+sl;var params='mapname='+this.getMapName()+"&session="+this.getSessionID();params+='&selection='+encodeURIComponent(selText);params+='&queryinfo='+(requery?"1":"0");params+='&seq='+Math.random();var options={onSuccess:this.processSelection.bind(this,selText,requery,zoomTo),parameters:params,asynchronous:false};Fusion.ajaxRequest(setSelectionScript,options);},getSelection:function(userFunc,layers,startcount){if(userFunc)
{var s=this.arch+'/'+Fusion.getScriptLanguage()+"/Selection."+Fusion.getScriptLanguage();var params={parameters:'session='+this.getSessionID()+'&mapname='+this._sMapname+'&layers='+layers+'&startcount='+startcount,onComplete:this.getSelectionCB.bind(this,userFunc,layers,startcount)};Fusion.ajaxRequest(s,params);}},selectionCleared:function()
{for(var j=0;j<this.aLayers.length;++j){this.aLayers[j].selectedFeatureCount=0;}
this.bSelectionOn=false;if(this.queryLayer){this.queryLayer.setVisibility(false);}
this.triggerEvent(Fusion.Event.MAP_SELECTION_OFF);this.drawMap();this.oSelection=null;},clearSelection:function(){if(this.hasSelection()){var s=this.arch+'/'+Fusion.getScriptLanguage()+"/ClearSelection."+Fusion.getScriptLanguage();var params={parameters:'session='+this.getSessionID()+'&mapname='+this._sMapname,onComplete:this.selectionCleared.bind(this)};Fusion.ajaxRequest(s,params);}},removeQueryLayer:function(){if(this.queryLayer){this.queryLayer.destroy();this.queryLayer=null;}},processQueryResults:function(r){this.mapWidget._removeWorker();if(r.responseText){var oNode;eval('oNode='+r.responseText);if(oNode.hasSelection){if(!this.bSingleTile){if(!this.queryLayer){this.queryLayer=this.createOLLayer("query layer",false,true);this.mapWidget.oMapOL.addLayer(this.queryLayer);this.mapWidget.registerForEvent(Fusion.Event.MAP_LOADING,this.removeQueryLayer.bind(this));}else{this.queryLayer.setVisibility(true);}}
for(var i=0;i<oNode.layers.length;++i){var layerName=oNode.layers[i];for(var j=0;j<this.aLayers.length;++j){if(layerName==this.aLayers[j].layerName){this.aLayers[j].selectedFeatureCount=oNode[layerName].featureCount;}}}
this.newSelection();}else{return;}}},query:function(options){this.mapWidget._addWorker();for(var j=0;j<this.aLayers.length;++j){this.aLayers[j].selectedFeatureCount=0;}
var geometry=options.geometry||'';var maxFeatures=options.maxFeatures||0;var bPersistant=options.persistent||true;var selectionType=options.selectionType||this.selectionType;var filter=options.filter?'&filter='+options.filter:'';var layers=options.layers||'';var extend=options.extendSelection?'&extendselection=true':'';var computed=options.computedProperties?'&computed=true':'';var sl=Fusion.getScriptLanguage();var loadmapScript=this.arch+'/'+sl+'/Query.'+sl;var sessionid=this.getSessionID();var params='mapname='+this._sMapname+"&session="+sessionid+'&spatialfilter='+geometry+'&maxfeatures='+maxFeatures+filter+'&layers='+layers+'&variant='+selectionType+extend+computed;var options={onSuccess:this.processQueryResults.bind(this),parameters:params};Fusion.ajaxRequest(loadmapScript,options);},showLayer:function(layer){if(this.oMapInfo&&this.oMapInfo.layerEvents[layer.layerName]){var layerEvent=this.oMapInfo.layerEvents[layer.layerName];for(var i=0;i<layerEvent.onEnable.length;i++){var l=this.layerRoot.findLayer(layerEvent.onEnable[i].name);if(l){if(layerEvent.onEnable[i].enable){l.show();}else{l.hide();}}}}
this.aShowLayers.push(layer.uniqueId);this.drawMap();},hideLayer:function(layer){if(this.oMapInfo&&this.oMapInfo.layerEvents[layer.layerName]){var layerEvent=this.oMapInfo.layerEvents[layer.layerName];for(var i=0;i<layerEvent.onDisable.length;i++){var l=this.layerRoot.findLayer(layerEvent.onDisable[i].name);if(l){if(layerEvent.onDisable[i].enable){l.show();}else{l.hide();}}}}
this.aHideLayers.push(layer.uniqueId);this.drawMap();},showGroup:function(group){if(group.groupName=='layerRoot'){this.oLayerOL.setVisibility(true);}else{this.aShowGroups.push(group.uniqueId);this.drawMap();}},hideGroup:function(group){if(group.groupName=='layerRoot'){this.oLayerOL.setVisibility(false);}else{this.aHideGroups.push(group.uniqueId);this.drawMap();}},refreshLayer:function(layer){this.aRefreshLayers.push(layer.uniqueId);this.drawMap();},setParameter:function(param,value){if(param=='SelectionType'){this.selectionType=value;}},loadStart:function(){this.mapWidget._addWorker();},loadEnd:function(){this.mapWidget._removeWorker();},pingServer:function(){var s=this.arch+'/'+Fusion.getScriptLanguage()+"/Common."+Fusion.getScriptLanguage();var params={};params.parameters='session='+this.getSessionID();Fusion.ajaxRequest(s,params);}};Fusion.Maps.MapGuide.Group=Class.create();Fusion.Maps.MapGuide.Group.prototype={oMap:null,initialize:function(o,oMap){this.uniqueId=o.uniqueId;Object.inheritFrom(this,Fusion.Widget.Map.Group.prototype,[o.groupName]);this.oMap=oMap;this.groupName=o.groupName;this.legendLabel=o.legendLabel;this.parentUniqueId=o.parentUniqueId;this.groupType=o.groupType;this.displayInLegend=o.displayInLegend;this.expandInLegend=o.expandInLegend;this.visible=o.visible;this.actuallyVisible=o.actuallyVisible;},show:function(){if(this.visible){return;}
this.oMap.showGroup(this);this.visible=true;if(this.legend&&this.legend.checkBox){this.legend.checkBox.checked=true;}},hide:function(){if(!this.visible){return;}
this.oMap.hideGroup(this);this.visible=false;if(this.legend&&this.legend.checkBox){this.legend.checkBox.checked=false;}},isVisible:function(){return this.visible;}};Fusion.Maps.MapGuide.Layer=Class.create();Fusion.Maps.MapGuide.Layer.prototype={scaleRanges:null,oMap:null,initialize:function(o,oMap){this.uniqueId=o.uniqueId;Object.inheritFrom(this,Fusion.Widget.Map.Layer.prototype,[o.layerName]);this.oMap=oMap;this.layerName=o.layerName;this.uniqueId=o.uniqueId;this.resourceId=o.resourceId;this.legendLabel=o.legendLabel;this.selectable=o.selectable;this.selectedFeatureCount=0;this.layerTypes=[].concat(o.layerTypes);this.displayInLegend=o.displayInLegend;this.expandInLegend=o.expandInLegend;this.visible=o.visible;this.actuallyVisible=o.actuallyVisible;this.editable=o.editable;this.layerType=null;if(this.supportsType(Fusion.Constant.LAYER_RASTER_TYPE)){this.layerType=Fusion.Constant.LAYER_RASTER_TYPE;}else if(this.supportsType(Fusion.Constant.LAYER_DWF_TYPE)){this.layerType=Fusion.Constant.LAYER_DWF_TYPE;}
this.parentGroup=o.parentGroup;this.scaleRanges=[];this.minScale=1.0e10;this.maxScale=0;for(var i=0;i<o.scaleRanges.length;i++){var scaleRange=new Fusion.Maps.MapGuide.ScaleRange(o.scaleRanges[i],this.layerType);this.scaleRanges.push(scaleRange);this.minScale=Math.min(this.minScale,scaleRange.minScale);this.maxScale=Math.max(this.maxScale,scaleRange.maxScale);}},supportsType:function(type){for(var i=0;i<this.layerTypes.length;i++){if(this.layerTypes[i]==type){return true;}}
return false;},getScaleRange:function(fScale){for(var i=0;i<this.scaleRanges.length;i++){if(this.scaleRanges[i].contains(fScale)){return this.scaleRanges[i];}}
return null;},show:function(){if(this.visible){return;}
this.oMap.showLayer(this);this.set('visible',true);if(this.legend&&this.legend.checkBox){this.legend.checkBox.checked=true;}},hide:function(){if(!this.visible){return;}
this.oMap.hideLayer(this);this.set('visible',false);if(this.legend&&this.legend.checkBox){this.legend.checkBox.checked=false;}},isVisible:function(){return this.visible;}};Fusion.Maps.MapGuide.ScaleRange=Class.create();Fusion.Maps.MapGuide.ScaleRange.prototype={styles:null,initialize:function(o,layerType){this.minScale=o.minScale;this.maxScale=o.maxScale;if(this.maxScale=='infinity'){this.maxScale=Infinity;}
this.styles=[];if(!o.styles){var styleItem=new Fusion.Maps.MapGuide.StyleItem({legendLabel:'DWF'},layerType);this.styles.push(styleItem);return;}
var staticIcon=o.styles.length>1?false:layerType;for(var i=0;i<o.styles.length;i++){var styleItem=new Fusion.Maps.MapGuide.StyleItem(o.styles[i],staticIcon);this.styles.push(styleItem);}},contains:function(fScale){return fScale>=this.minScale&&fScale<=this.maxScale;}};Fusion.Maps.MapGuide.StyleItem=Class.create();Fusion.Maps.MapGuide.StyleItem.prototype={initialize:function(o,staticIcon){this.legendLabel=o.legendLabel;this.filter=o.filter;this.geometryType=o.geometryType;if(this.geometryType==''){this.geometryType=-1;}
this.categoryIndex=o.categoryIndex;if(this.categoryindex==''){this.categoryindex=-1;}
this.staticIcon=staticIcon;},getLegendImageURL:function(fScale,layer){var url=Fusion.getConfigurationItem('mapguide','mapAgentUrl');return url+"OPERATION=GETLEGENDIMAGE&SESSION="+layer.oMap.getSessionID()+"&VERSION=1.0.0&SCALE="+fScale+"&LAYERDEFINITION="+encodeURIComponent(layer.resourceId)+"&THEMECATEGORY="+this.categoryIndex+"&TYPE="+this.geometryType;}};Fusion.Event.MAP_LAYER_ORDER_CHANGED=Fusion.Event.lastEventId++;Fusion.Maps.MapServer=Class.create();Fusion.Maps.MapServer.prototype={arch:'MapServer',session:[null],aShowLayers:null,aHideLayers:null,aShowGroups:null,aHideGroups:null,aRefreshLayers:null,sActiveLayer:null,selectionType:'INTERSECTS',bSelectionOn:false,bDisplayInLegend:true,bExpandInLegend:true,oSelection:null,bMapLoaded:false,bIsMapWidgetLayer:true,bLayersReversed:true,sMapFile:null,_sImageType:'png',initialize:function(map,mapTag,isMapWidgetLayer){Object.inheritFrom(this,Fusion.Lib.EventMgr,[]);this.registerEventID(Fusion.Event.MAP_SESSION_CREATED);this.registerEventID(Fusion.Event.MAP_SELECTION_ON);this.registerEventID(Fusion.Event.MAP_SELECTION_OFF);this.registerEventID(Fusion.Event.MAP_LOADED);this.registerEventID(Fusion.Event.MAP_LOADING);this.registerEventID(Fusion.Event.MAP_LAYER_ORDER_CHANGED);this.mapWidget=map;this.oSelection=null;if(isMapWidgetLayer!=null){this.bIsMapWidgetLayer=isMapWidgetLayer;}
var extension=mapTag.extension;this.ratio=extension.MapRatio?extension.MapRatio[0]:'1.0';rootOpts={displayInLegend:this.bDisplayInLegend,expandInLegend:this.bExpandInLegend,legendLabel:this._sMapname,uniqueId:'layerRoot',groupName:'layerRoot',visible:true,actuallyVisible:true};this.layerRoot=new Fusion.Maps.MapServer.Group(rootOpts,this);this.sMapFile=extension.MapFile?extension.MapFile[0]:'';this.bSingleTile=mapTag.singleTile;this.keepAliveInterval=parseInt(extension.KeepAliveInterval?extension.KeepAliveInterval[0]:300);if(mapTag.sid){this.session[0]=mapTag.sid;this.mapSessionCreated();}else{this.createSession();}},createSession:function(){if(!this.session[0]){this.session[0]=this;var sl=Fusion.getScriptLanguage();var scriptURL=this.arch+'/'+sl+'/CreateSession.'+sl;var options={onComplete:this.createSessionCB.bind(this)};Fusion.ajaxRequest(scriptURL,options);}
if(this.session[0]instanceof Fusion.Maps.MapServer){this.session[0].registerForEvent(Fusion.Event.MAP_SESSION_CREATED,this.mapSessionCreated.bind(this));}else{this.mapSessionCreated();}},createSessionCB:function(r,json){if(r.status==200&&json){var o;eval('o='+r.responseText);this.session[0]=o.sessionId;this.triggerEvent(Fusion.Event.MAP_SESSION_CREATED);}},mapSessionCreated:function(){if(this.sMapFile!=''){this.loadMap(this.sMapFile);}
window.setInterval(this.pingServer.bind(this),this.keepAliveInterval*1000);},sessionReady:function(){return(typeof this.session[0]=='string');},getSessionID:function(){return this.session[0];},getMapName:function(){return this._sMapname;},getMapTitle:function(){return this._sMapTitle;},loadMap:function(mapfile,options){while(this.mapWidget.isBusy()){this.mapWidget._removeWorker();}
this.bMapLoaded=false;if(this._sMapFile==mapfile){return;}
if(!this.sessionReady()){this.sMapFile=mapfile;return;}
if(this.bIsMapWidgetLayer){this.mapWidget.triggerEvent(Fusion.Event.MAP_LOADING);}else{this.triggerEvent(Fusion.Event.MAP_LOADING);}
this.mapWidget._addWorker();this._fScale=-1;this._nDpi=72;options=options||{};this._oMaxExtent=null;this.aVisibleLayers=options.showlayers||[];this.aVisibleGroups=options.showgroups||[];this.aLayers=[];this.oSelection=null;this.aSelectionCallbacks=[];this._bSelectionIsLoading=false;var sl=Fusion.getScriptLanguage();var loadmapScript=this.arch+'/'+sl+'/LoadMap.'+sl;var sessionid=this.getSessionID();var params='mapfile='+mapfile+"&session="+sessionid;var options={onSuccess:this.mapLoaded.bind(this),parameters:params};Fusion.ajaxRequest(loadmapScript,options);},mapLoaded:function(r,json){if(json)
{var o;eval('o='+r.responseText);this._sMapFile=o.mapId;this._sMapname=o.mapName;this._sMapTitle=o.mapTitle;this._fMetersperunit=o.metersPerUnit;this.mapWidget._fMetersperunit=this._fMetersperunit;this._sImageType=o.imagetype;this._oMaxExtent=OpenLayers.Bounds.fromArray(o.extent);this.layerRoot.clear();this.layerRoot.legendLabel=this._sMapTitle;this.parseMapLayersAndGroups(o);var minScale=1.0e10;var maxScale=0;for(var i=0;i<this.aLayers.length;i++){if(this.aLayers[i].visible){this.aVisibleLayers.push(this.aLayers[i].layerName);}
minScale=Math.min(minScale,this.aLayers[i].minScale);maxScale=Math.max(maxScale,this.aLayers[i].maxScale);}
if(minScale<=0){minScale=1.0;}
if(o.dpi){OpenLayers.DOTS_PER_INCH=o.dpi;}
var layerOptions={singleTile:true,ratio:this.ratio,maxExtent:this._oMaxExtent,maxResolution:'auto',minScale:maxScale,maxScale:minScale};if(o.metersPerUnit==0.0254)
layerOptions.units='inches';else if(o.metersPerUnit==0.3048)
layerOptions.units='ft';else if(o.metersPerUnit==1609.344)
layerOptions.units='mi';else if(o.metersPerUnit==1)
layerOptions.units='m';else if(o.metersPerUnit==1000)
layerOptions.units='km';else if(o.metersPerUnit==111118.7516)
layerOptions.units='dd';var params={layers:this.aVisibleLayers.join(' '),session:this.getSessionID(),map:this._sMapFile,map_imagetype:this._sImageType};if(this.oLayerOL){this.oLayerOL.events.unregister("loadstart",this,this.loadStart);this.oLayerOL.events.unregister("loadend",this,this.loadEnd);this.oLayerOL.events.unregister("loadcancel",this,this.loadEnd);this.oLayerOL.destroy();}
var url=Fusion.getConfigurationItem('mapserver','cgi');this.oLayerOL=new OpenLayers.Layer.MapServer(o.mapName,url,params,layerOptions);this.oLayerOL.events.register("loadstart",this,this.loadStart);this.oLayerOL.events.register("loadend",this,this.loadEnd);this.oLayerOL.events.register("loadcancel",this,this.loadEnd);if(this.bIsMapWidgetLayer){this.mapWidget.addMap(this);this.mapWidget.oMapOL.setBaseLayer(this.oLayerOL);this.mapWidget._oInitialExtents=null;this.mapWidget.fullExtents();this.mapWidget.triggerEvent(Fusion.Event.MAP_LOADED);}else{this.triggerEvent(Fusion.Event.MAP_LOADED);}
this.bMapLoaded=true;}
else
{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,'Failed to load requested map:\n'+r.responseText));}
this.mapWidget._removeWorker();},reloadMap:function(){this.mapWidget._addWorker();this.aShowLayers=[];this.aHideLayers=[];this.aShowGroups=[];this.aHideGroups=[];this.aRefreshLayers=[];this.layerRoot.clear();this.aLayers=[];var sl=Fusion.getScriptLanguage();var loadmapScript=this.arch+'/'+sl+'/LoadMap.'+sl;var sessionid=this.getSessionID();var params='mapname='+this._sMapname+"&session="+sessionid;var options={onSuccess:this.mapReloaded.bind(this),parameters:params};Fusion.ajaxRequest(loadmapScript,options);},mapReloaded:function(r,json){if(json){var o;eval('o='+r.responseText);this.parseMapLayersAndGroups(o);this.aVisibleLayers=[];for(var i=0;i<this.aLayers.length;i++){if(this.aLayers[i].visible){this.aVisibleLayers.push(this.aLayers[i].layerName);}}
this.drawMap();this.mapWidget.triggerEvent(Fusion.Event.MAP_RELOADED);}else{Fusion.reportError(new Fusion.Error(Fusion.Error.FATAL,OpenLayers.String.translate('mapLoadError',r.responseText)));}
this.mapWidget._removeWorker();},reorderLayers:function(aLayerIndex){var sl=Fusion.getScriptLanguage();var loadmapScript=this.arch+'/'+sl+'/SetLayers.'+sl;var sessionid=this.getSessionID();var params='mapname='+this._sMapname+"&session="+sessionid;params+='&layerindex='+aLayerIndex.join();var options={onSuccess:this.mapLayersReset.bind(this,aLayerIndex),parameters:params};Fusion.ajaxRequest(loadmapScript,options);},mapLayersReset:function(aLayerIndex,r,json){if(json){var o;eval('o='+r.responseText);if(o.success){var layerCopy=this.aLayers.clone();this.aLayers=[];this.aVisibleLayers=[];for(var i=0;i<aLayerIndex.length;++i){this.aLayers.push(layerCopy[aLayerIndex[i]]);if(this.aLayers[i].visible){this.aVisibleLayers.push(this.aLayers[i].layerName);}}
this.drawMap();this.triggerEvent(Fusion.Event.MAP_LAYER_ORDER_CHANGED);}else{alert(OpenLayers.String.translate('setLayersError',o.layerindex));}}},parseMapLayersAndGroups:function(o){for(var i=0;i<o.groups.length;i++){var group=new Fusion.Maps.MapServer.Group(o.groups[i],this);var parent;if(group.parentUniqueId!=''){parent=this.layerRoot.findGroup(group.parentUniqueId);}else{parent=this.layerRoot;}
parent.addGroup(group,this.bLayersReversed);}
for(var i=0;i<o.layers.length;i++){var layer=new Fusion.Maps.MapServer.Layer(o.layers[i],this);var parent;if(layer.parentGroup!=''){parent=this.layerRoot.findGroup(layer.parentGroup);}else{parent=this.layerRoot;}
parent.addLayer(layer,this.bLayersReversed);this.aLayers.push(layer);}},isMapLoaded:function(){return this.bMapLoaded;},getScale:function(){return this.mapWidget.getScale();},updateLayer:function(){if(this.hasSelection()){this.oLayerOL.addOptions({queryfile:this._sQueryfile});}},drawMap:function(){if(!this.bMapLoaded){return;}
var params={layers:this.aVisibleLayers.join(' '),ts:(new Date()).getTime()};if(this.hasSelection()){params['queryfile']=this._sQueryfile;}else{params['queryfile']='';}
this.oLayerOL.mergeNewParams(params);},showLayer:function(sLayer){this.aVisibleLayers.push(sLayer);this.drawMap();},hideLayer:function(sLayer){for(var i=0;i<this.aLayers.length;i++){if(this.aVisibleLayers[i]==sLayer){this.aVisibleLayers.splice(i,1);break;}}
this.drawMap();},showGroup:function(sGroup){if(sGroup=='layerRoot'){this.oLayerOL.setVisibility(true);}else{this.aVisibleGroups.push(sGroup);this.drawMap();}},hideGroup:function(sGroup){if(sGroup=='layerRoot'){this.oLayerOL.setVisibility(false);}else{for(var i=0;i<this.aVisibleGroups.length;i++){if(this.aVisibleGroups[i]==sGroup){this.aVisibleGroups.splice(i,1);break;}}
this.drawMap();}},refreshLayer:function(sLayer){this.drawMap();},hasSelection:function(){return this.bSelectionOn;},getSelectionCB:function(userFunc,layers,startend,r,json){if(json)
{var o;eval("o="+r.responseText);var oSelection=new GxSelectionObject(o);userFunc(oSelection);}},newSelection:function(){this.bSelectionOn=true;this.drawMap();this.triggerEvent(Fusion.Event.MAP_SELECTION_ON);},getSelectedFeatureCount:function(){var total=0;for(var j=0;j<this.aLayers.length;++j){total+=this.aLayers[j].selectedFeatureCount;}
return total;},getSelectedLayers:function(){var layers=[];for(var j=0;j<this.aLayers.length;++j){if(this.aLayers[j].selectedFeatureCount>0){layers.push(this.aLayers[j]);}}
return layers;},getSelectableLayers:function(){var layers=[];for(var j=0;j<this.aLayers.length;++j){if(this.aLayers[j].selectable){layers.push(this.aLayers[j]);}}
return layers;},getSelection:function(userFunc,layers,startcount){if(userFunc)
{var s=this.arch+'/'+Fusion.getScriptLanguage()+"/Selection."+Fusion.getScriptLanguage();var params={parameters:'session='+this.getSessionID()+'&mapname='+this._sMapname+'&layers='+layers+'&startcount='+startcount+'&queryfile='+this._sQueryfile,onComplete:this.getSelectionCB.bind(this,userFunc,layers,startcount)};Fusion.ajaxRequest(s,params);}},clearSelection:function(){if(!this.aLayers)return;for(var j=0;j<this.aLayers.length;++j){this.aLayers[j].selectedFeatureCount=0;}
this.bSelectionOn=false;this._sQueryfile="";this.triggerEvent(Fusion.Event.MAP_SELECTION_OFF);this.drawMap();this.oSelection=null;},processQueryResults:function(r,json){this.mapWidget._removeWorker();if(json){var o;eval("o="+r.responseText);if(!o.hasSelection){return;}else{this._sQueryfile=o.queryFile;for(var i=0;i<o.layers.length;++i){var layerName=o.layers[i];for(var j=0;j<this.aLayers.length;++j){if(layerName==this.aLayers[j].layerName){this.aLayers[j].selectedFeatureCount=o[layerName].featureCount;}}}
this.newSelection();}}},query:function(options){this.mapWidget._addWorker();for(var j=0;j<this.aLayers.length;++j){this.aLayers[j].selectedFeatureCount=0;}
var geometry=options.geometry||'';var maxFeatures=options.maxFeatures||-1;var bPersistant=options.persistent||true;var selectionType=options.selectionType||this.selectionType;var filter=options.filter?'&filter='+options.filter:'';var layers=options.layers||'';if(layers==''){layers=this.aVisibleLayers.join(',');}
var extend=options.extendSelection?'&extendselection=true':'';var computed=options.computedProperties?'&computed=true':'';var sl=Fusion.getScriptLanguage();var loadmapScript=this.arch+'/'+sl+'/Query.'+sl;var sessionid=this.getSessionID();var params='mapname='+this._sMapname+"&session="+sessionid+'&spatialfilter='+geometry+'&maxfeatures='+maxFeatures+filter+'&layers='+layers+'&variant='+selectionType+extend;var options={onSuccess:this.processQueryResults.bind(this),parameters:params};Fusion.ajaxRequest(loadmapScript,options);},loadStart:function(){this.mapWidget._addWorker();},loadEnd:function(){this.mapWidget._removeWorker();},pingServer:function(){var s=this.arch+'/'+Fusion.getScriptLanguage()+"/Common."+Fusion.getScriptLanguage();var params={};params.parameters='session='+this.getSessionID();Fusion.ajaxRequest(s,params);}};Fusion.Maps.MapServer.Group=Class.create();Fusion.Maps.MapServer.Group.prototype={oMap:null,initialize:function(o,oMap){this.uniqueId=o.uniqueId;Object.inheritFrom(this,Fusion.Widget.Map.Group.prototype,[this.uniqueId]);this.oMap=oMap;this.groupName=o.groupName;this.legendLabel=o.legendLabel;this.parentUniqueId=o.parentUniqueId;this.groupType=o.groupType;this.displayInLegend=o.displayInLegend;this.expandInLegend=o.expandInLegend;this.visible=o.visible;this.actuallyVisible=o.actuallyVisible;},clear:function(){Fusion.Widget.Map.Group.prototype.clear.apply(this,[]);},show:function(){this.oMap.showGroup(this.groupName);this.visible=true;},hide:function(){this.oMap.hideGroup(this.groupName);this.visible=false;},isVisible:function(){return this.visible;}};var MSLAYER_POINT_TYPE=0;var MSLAYER_LINE_TYPE=1;var MSLAYER_POLYGON_TYPE=2;var MSLAYER_SOLID_TYPE=3;var MSLAYER_RASTER_TYPE=4;Fusion.Maps.MapServer.Layer=Class.create();Fusion.Maps.MapServer.Layer.prototype={scaleRanges:null,oMap:null,initialize:function(o,oMap){this.uniqueId=o.uniqueId;Object.inheritFrom(this,Fusion.Widget.Map.Layer.prototype,[this.uniqueId]);this.oMap=oMap;this.layerName=o.layerName;this.uniqueId=o.uniqueId;this.resourceId=o.resourceId;this.legendLabel=o.legendLabel;this.selectable=o.selectable;this.selectedFeatureCount=0;this.layerTypes=[].concat(o.layerTypes);this.displayInLegend=o.displayInLegend;this.expandInLegend=o.expandInLegend;this.visible=o.visible;this.actuallyVisible=o.actuallyVisible;this.editable=o.editable;this.parentGroup=o.parentGroup;this.scaleRanges=[];this.minScale=1.0e10;this.maxScale=0;for(var i=0;i<o.scaleRanges.length;i++){var scaleRange=new Fusion.Maps.MapServer.ScaleRange(o.scaleRanges[i],this.supportsType(4));this.scaleRanges.push(scaleRange);this.minScale=Math.min(this.minScale,scaleRange.minScale);this.maxScale=Math.max(this.maxScale,scaleRange.maxScale);}},clear:function(){Fusion.Widget.Map.Layer.prototype.clear.apply(this,[]);this.oMap=null;this.legend=null;},supportsType:function(type){for(var i=0;i<this.layerTypes.length;i++){if(this.layerTypes[i]==type){return true;}}
return false;},getScaleRange:function(fScale){for(var i=0;i<this.scaleRanges.length;i++){if(this.scaleRanges[i].contains(fScale)){return this.scaleRanges[i];}}
return null;},show:function(){this.oMap.showLayer(this.layerName);this.set('visible',true);},hide:function(){this.oMap.hideLayer(this.layerName);this.set('visible',false);},isVisible:function(){return this.visible;}};Fusion.Maps.MapServer.ScaleRange=Class.create();Fusion.Maps.MapServer.ScaleRange.prototype={styles:null,initialize:function(o,bRaster){this.minScale=o.minScale;this.maxScale=o.maxScale;this.styles=[];if(!o.styles){return;}
if(o.styles.length==0&&bRaster)
{var tmpsyle={};tmpsyle.legendLabel="raster";tmpsyle.filter="";tmpsyle.index=0;tmpsyle.staticIcon=true;var styleItem=new Fusion.Maps.MapServer.StyleItem(tmpsyle,tmpsyle.staticIcon);this.styles.push(styleItem);}
else
{var staticIcon=o.styles.length>=1?false:bRaster;for(var i=0;i<o.styles.length;i++){var styleItem=new Fusion.Maps.MapServer.StyleItem(o.styles[i],staticIcon);this.styles.push(styleItem);}}},contains:function(fScale){return fScale>=this.minScale&&fScale<=this.maxScale;}};Fusion.Maps.MapServer.StyleItem=Class.create();Fusion.Maps.MapServer.StyleItem.prototype={initialize:function(o,staticIcon){this.legendLabel=o.legendLabel;this.filter=o.filter;this.index=o.index;this.staticIcon=staticIcon;},getLegendImageURL:function(fScale,layer){var sl=Fusion.getScriptLanguage();var url=Fusion.getFusionURL()+'/'+layer.oMap.arch+'/'+sl+'/LegendIcon.'+sl;var sessionid=layer.oMap.getSessionID();var params='mapname='+layer.oMap._sMapname+"&session="+sessionid+'&layername='+layer.resourceId+'&classindex='+this.index;return url+'?'+params;}};ï»¿Fusion.Strings.en={'scriptFailed':'failed to load script: {0}','configParseError':'Error parsing fusion configuration file, initialization aborted','configLoadError':'Error loading fusion configuration file, initialization aborted','ajaxError':'Exception occurred in AJAX callback.\n{0}\nLocation: {1} ({2})\n{3})','importFailed':'failed to import stylesheet: {0}','registerEventError':'Error registering eventID, invalid (empty) eventID.','appDefLoadFailed':'failed to load: {0}','appDefParseError':'failed to parse ApplicationDefinition','widgetSetParseError':'failed to parse the WidgetSet','fusionError':'Fusion Error: {0}\n{1}','nullExtents':'Map.setExtents called with null extents','mapLoadError':'Failed to load requested map:\n{0}','setLayersError':"setLayers failure: {0}",'printTitle':'Printable Page ','noSelection':'No Selection','selectionInfo':'{0} features selected on {1} layers','attribute':'Attribute','value':'Value','taskHome':'return to the task pane home','prevTask':'go to previous task executed','nextTask':'go to next task executed','taskList':'Task List','taskPane':'Task Pane','imperial':'Imperial','metric':'Metric','deg':'Degrees','refresh':'Refresh','expandAll':'Expand All','expand':'Expand','collapseAll':'Collapse All','collapse':'Collapse','defaultMapTitle':'Map','legendTitle':'Legend','selectionPanelTitle':'Selection','ovmapTitle':'Overview Map','taskPaneTitle':'Tasks','segment':'Segment {0}','calculating':'calculating ...','end':''};ï»¿Fusion.Strings.fr={'scriptFailed':'failed to load script: {0}','configParseError':'Error parsing fusion configuration file, initialization aborted','configLoadError':'Error loading fusion configuration file, initialization aborted','ajaxError':'Exception occurred in AJAX callback.\n{0}\nLocation: {1} ({2})\n{3})','importFailed':'failed to import stylesheet: {0}','registerEventError':'Error registering eventID, invalid (empty) eventID.','appDefLoadFailed':'failed to load: {0}','appDefParseError':'failed to parse ApplicationDefinition','widgetSetParseError':'failed to parse the WidgetSet','fusionError':'Fusion Error: {0}\n{1}','nullExtents':'Map.setExtents called with null extents','mapLoadError':'Failed to load requested map:\n{0}','setLayersError':"setLayers failure: {0}",'printTitle':'Printable Page ','noSelection':'Aucun SÃ©lection','No Selection':'Aucun SÃ©lection','selectionInfo':'{0} features selected on {1} layers - translate me','attribute':'Attribute','value':'Value','taskHome':'return to the task pane home','prevTask':'go to previous task executed','nextTask':'go to next task executed','taskList':'Task List','taskPane':'Task Pane','imperial':'Imperial','metric':'Metric','deg':'Degrees','refresh':'Refresh','expandAll':'Expand All','expand':'Expand','collapseAll':'Collapse All','collapse':'Collapse','defaultMapTitle':'Map','legendTitle':'Legend','selectionPanelTitle':'SÃ©lection','ovmapTitle':'Overview Map','taskPaneTitle':'Tasks','segment':'Segment {0}','calculating':'calculating ...','end':''};Fusion.Widget.About=Class.create();Fusion.Widget.About.prototype={_nWidth:500,_nHeight:400,_sDefaultUrl:'/mapguide/mapadmin/about.php',initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this._sAboutUrl=(json.AboutURL)?json.AboutURL[0]:this._sDefaultUrl;this.enable();},execute:function(){var sFeatures='menubar=no,location=no,resizable=no,status=no';sFeatures+=',width='+this._nWidth;sFeatures+=',height='+this._nHeight;window.open(this._sAboutUrl,'AboutPopup',sFeatures);}};Fusion.Widget.ActivityIndicator=Class.create();Fusion.Widget.ActivityIndicator.prototype={element:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);this.element=this.domObj;var json=widgetTag.extension;if(json.ElementId){var elm=$(json.ElementId[0]);if(elm&&elm!=this.domObj){this.domObj.appendChild(elm);this.element=elm;}}
this.element.style.visibility='hidden';this.getMap().registerForEvent(Fusion.Event.MAP_BUSY_CHANGED,this.busyChanged.bind(this));},busyChanged:function(){this.element.style.visibility=this.getMap().isBusy()?'visible':'hidden';}};Fusion.Widget.Buffer=Class.create();Fusion.Widget.Buffer.prototype={layerName:null,layerNameInput:null,bufferDistance:null,bufferDistanceInput:null,bufferUnits:null,bufferUnitsInput:null,borderColor:null,borderColorInput:null,fillColor:null,fillColorInput:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.layerName=json.LayerName?json.LayerName[0]:'';this.layerNameInput=json.LayerNameInput?json.LayerNameInput[0]:null;this.bufferDistance=json.BufferDistance?parseFloat(json.BufferDistance[0]):'';this.bufferDistanceInput=json.BufferDistanceInput?json.BufferDistanceInput[0]:null;this.bufferUnits=Fusion.unitFromName(json.BufferUnits?json.BufferUnits[0]:'meters');this.bufferUnitsInput=json.BufferUnitsInput?json.BufferUnitsInput[0]:null;this.borderColor=json.BorderColor?json.BorderColor[0]:'00000000';this.borderColorInput=json.BorderColorInput?json.BorderColorInput[0]:null;this.fillColor=json.FillColor?json.FillColor[0]:'00000000';this.fillColorInput=json.FillColorInput?json.FillColorInput[0]:null;if(this.layerNameInput){this.layerNameInput=$(this.layerNameInput);this.setValue(this.layerNameInput,this.layerName);}
if(this.bufferDistanceInput){this.bufferDistanceInput=$(this.bufferDistanceInput);this.setValue(this.bufferDistanceInput,this.bufferDistance);}
if(this.bufferUnitsInput){this.bufferUnitsInput=$(this.bufferUnitsInput);this.setValue(this.bufferUnitsInput,this.bufferUnits);}
if(this.borderColorInput){this.borderColorInput=$(this.borderColorInput);this.setValue(this.borderColorInput,this.borderColor);}
if(this.fillColorInput){this.fillColorInput=$(this.fillColorInput);this.setValue(this.fillColorInput,this.fillColor);}
this.enable=Fusion.Widget.Buffer.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.enable.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.disable.bind(this));},setValue:function(input,value){if(input.tagName.toLowerCase()=="input"){switch(input.type){case'radio':case'checkbox':for(var i=0;i<input.length;i++){if(input[i].value==value){input[i].checked=true;}}
break;case'file':break;case'button':case'hidden':case'image':case'password':case'reset':case'submit':case'text':input.value=value;break;default:}}
if(input.tagName.toLowerCase()=='textarea'){input.value=value;}
if(input.tagName.toLowerCase()=='select'){for(var i=0;i<input.options.length;i++){if(input.options[i].value==value){input.options[i].selected=true;break;}}}},getValue:function(input){if(input.tagName.toLowerCase()=="input"){switch(input.type){case'radio':case'checkbox':return input.value;break;case'file':case'button':case'hidden':case'image':case'password':case'reset':case'submit':case'text':return input.value;break;default:}}
if(input.tagName.toLowerCase()=='textarea'){return input.value;}
if(input.tagName.toLowerCase()=='select'){return input.options[input.selectedIndex].value;}},enable:function(){if(this.oMap&&this.oMap.hasSelection()){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}else{this.disable();}},execute:function(){var layer='&layer=';if(this.layerNameInput){layer+=this.getValue(this.layerNameInput);}else{layer+=this.layerName;}
var d;if(this.bufferDistanceInput){d=this.getValue(this.bufferDistanceInput);}else{d=this.bufferDistance;}
var du;if(this.bufferUnitsInput){du=this.getValue(this.bufferUnitsInput);}else{du=this.bufferUnits;}
var distance='&distance='+Fusion.toMeter(Fusion.unitFromName(du),d);var borderColor='&bordercolor=';if(this.borderColorInput){borderColor+=this.getValue(this.borderColorInput);}else{borderColor+=this.borderColor;}
var fillColor='&fillcolor=';if(this.fillColorInput){fillColor+=this.getValue(this.fillColorInput);}else{fillColor+=this.fillColor;}
var mapWidget=this.getMap();var aMaps=mapWidget.getAllMaps();var s=aMaps[0].arch+'/'+Fusion.getScriptLanguage()+"/Buffer."+Fusion.getScriptLanguage();var params={};params.parameters='locale='+Fusion.locale+'&session='+aMaps[0].getSessionID()+'&mapname='+aMaps[0].getMapName()+
layer+distance+borderColor+fillColor;params.onComplete=this.bufferCreated.bind(this);Fusion.ajaxRequest(s,params);},bufferCreated:function(){var aMaps=this.getMap().getAllMaps();aMaps[0].reloadMap();aMaps[0].drawMap();}};Fusion.Widget.BufferPanel=Class.create();Fusion.Widget.BufferPanel.prototype={sFeatures:'menubar=no,location=no,resizable=no,status=no',initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.sTarget=json.Target?json.Target[0]:"BufferPanelWindow";this.sBaseUrl=Fusion.getFusionURL()+'widgets/BufferPanel/BufferPanel.php';this.bSelectionOnly=(json.DisableIfSelectionEmpty&&(json.DisableIfSelectionEmpty[0]=='true'||json.DisableIfSelectionEmpty[0]=='1'))?true:false;this.additionalParameters=[];if(json.AdditionalParameter){for(var i=0;i<json.AdditionalParameter.length;i++){var p=json.AdditionalParameter[i];var k=p.Key[0];var v=p.Value[0];this.additionalParameters.push(k+'='+encodeURIComponent(v));}}
this.enable=Fusion.Widget.BufferPanel.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.enable.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.enable.bind(this));this.disable();},enable:function(){var map=this.getMap();if(this.bSelectionOnly||!map){if(map&&map.hasSelection()){if(this.action){this.action.setEnabled(true);}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}}else{if(this.action){this.action.setEnabled(false);}else{this.disable();}}}else{if(this.action){this.action.setEnabled(true);}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}}},execute:function(){var url=this.sBaseUrl;var map=this.getMap();var mapLayers=map.getAllMaps();var taskPaneTarget=Fusion.getWidgetById(this.sTarget);var pageElement=$(this.sTarget);var params=[];params.push('locale='+Fusion.locale);params.push('session='+mapLayers[0].getSessionID());params.push('mapname='+mapLayers[0].getMapName());if(taskPaneTarget||pageElement){params.push('popup=false');}else{params.push('popup=true');}
params.push('us=0');params=params.concat(this.additionalParameters);if(url.indexOf('?')<0){url+='?';}else if(url.slice(-1)!='&'){url+='&';}
url+=params.join('&');if(taskPaneTarget){taskPaneTarget.setContent(url);}else{if(pageElement){pageElement.src=url;}else{window.open(url,this.sTarget,this.sWinFeatures);}}}};Fusion.Widget.CTRLClick=Class.create();Fusion.Widget.CTRLClick.prototype={aLayers:null,initialize:function(widgetTag)
{Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);var json=widgetTag.extension;this.aLayers=[];if(json.Layer){for(var i=0;i<json.Layer.length;i++){this.aLayers.push(json.Layer[i]);}}
this.getMap().observeEvent('mouseup',this.mouseUpCRTLClick.bind(this));},mouseUpCRTLClick:function(e){if(e.ctrlKey)
{var map=this.getMap();var p=map.getEventPosition(e);var min=map.pixToGeo(p.x,p.y);var max=map.pixToGeo(p.x,p.y);if(!min){return;}
var oBroker=Fusion.oBroker;var cellSize=map._nCellSize;cellSize=1e-6;min.x-=cellSize;min.y-=cellSize;max.x+=cellSize;max.y+=cellSize;var sGeometry='POLYGON(('+min.x+' '+min.y+', '+min.x+' '+max.y+', '+max.x+' '+max.y+', '+max.x+' '+min.y+', '+min.x+' '+min.y+'))';var maxFeatures=1;var persist=0;var selection='INTERSECTS';var maps=this.getMap().getAllMaps();var layerNames=this.aLayers.toString();var r=new Fusion.Lib.MGRequest.MGQueryMapFeatures(maps[0].getSessionID(),maps[0]._sMapname,sGeometry,maxFeatures,persist,selection,layerNames);oBroker.dispatchRequest(r,this._display.bind(this));}},_display:function(r){if(r.responseXML)
{var d=new DomNode(r.responseXML);var h=d.getNodeText('Hyperlink');if(h!='')
{window.open(h,"");}}}};Fusion.Widget.CenterSelection=Class.create();Fusion.Widget.CenterSelection.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);this.enable=Fusion.Widget.CenterSelection.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.enable.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.disable.bind(this));},execute:function(){this.getMap().getSelection(this.centerSelection.bind(this));},centerSelection:function(selection){var extents=this.getMap().getCurrentExtents();var curWidth=extents[2]-extents[0];var curHeight=extents[3]-extents[1];var ll=selection.getLowerLeftCoord();var ur=selection.getUpperRightCoord();var newWidth=ur.x-ll.x;var newHeight=ur.y-ll.y;if(newWidth<curWidth&&newHeight<curHeight){var cx=(ur.x+ll.x)/2;var cy=(ur.y+ll.y)/2;this.getMap().zoom(cx,cy,1);}else{var buffer=0.1;var minx=ll.x-newWidth*buffer;var miny=ll.y-newHeight*buffer;var maxx=ur.x+newWidth*buffer;var maxy=ur.y+newHeight*buffer;this.getMap().setExtents(new OpenLayers.Bounds(minx,miny,maxx,maxy));}},enable:function(){if(this.oMap&&this.oMap.hasSelection()){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}else{this.disable();}}};Fusion.Widget.ClearSelection=Class.create();Fusion.Widget.ClearSelection.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);this.enable=Fusion.Widget.ClearSelection.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.enable.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.disable.bind(this));},execute:function(){this.getMap().clearSelection();},enable:function(){if(this.oMap&&this.oMap.hasSelection()){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}else{this.disable();}}};Fusion.Widget.ColorPicker=Class.create();Fusion.Widget.ColorPicker.prototype={colorInput:null,alpha:100,color:'#000000',colorButton:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);var json=widgetTag.extension;if(json.ColorInputId){this.colorInput=$(json.ColorInputId[0]);}
if(this.colorInput){this.alpha=100*parseInt('0x'+this.colorInput.value.substring(0,2))/255;this.color='#'+this.colorInput.value.substring(2);this.colorInput.widget=this;}
this.colorButton=new Jx.Button.Color({color:this.color,alpha:this.alpha,label:widgetTag.label,tooltip:widgetTag.tooltip});this.colorButton.addColorChangeListener(this);if(this.domObj){this.domObj.appendChild(this.colorButton.domObj);}},colorChanged:function(button){var a=parseInt(this.colorButton.alpha*255/100).toString(16);var c=a+this.colorButton.color.substring(1);if(this.colorInput){this.colorInput.value=c;}}};Fusion.Widget.CursorPosition=Class.create();Fusion.Widget.CursorPosition.prototype={defaultTemplate:'x: {x}, y: {y}',domSpan:null,units:Fusion.UNKNOWN,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);var json=widgetTag.extension;this.emptyText=json.EmptyText?json.EmptyText[0]:this.domObj.innerHTML;this.template=json.Template?json.Template[0]:this.defaultTemplate;this.precision=json.Precision?parseInt(json.Precision[0]):-1;this.units=json.Units?Fusion.unitFromName(json.Units[0]):Fusion.UNKOWN;this.domSpan=document.createElement('span');this.domSpan.className='spanCursorPosition';this.domSpan.innerHTML=this.emptyText;this.domObj.innerHTML='';this.domObj.appendChild(this.domSpan);this.enable=Fusion.Widget.CursorPosition.prototype.enable;this.disable=Fusion.Widget.CursorPosition.prototype.enable;this.mouseMoveWatcher=this.mouseMove.bind(this);this.mouseOutWatcher=this.mouseOut.bind(this);this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.setUnits.bind(this));this.registerParameter('Units');},enable:function(){this.getMap().observeEvent('mousemove',this.mouseMoveWatcher);this.getMap().observeEvent('mouseout',this.mouseOutWatcher);},disable:function(){this.getMap().stopObserveEvent('mousemove',this.mouseMoveWatcher);this.getMap().stopObserveEvent('mouseout',this.mouseOutWatcher);},mouseOut:function(e){this.domSpan.innerHTML=this.emptyText;},mouseMove:function(e){var map=this.getMap();var p=map.getEventPosition(e);if(this.units!=Fusion.PIXELS){p=map.pixToGeo(p.x,p.y);if(p){if(this.units!=Fusion.UNKNOWN){p.x=Fusion.fromMeter(this.units,p.x*map._fMetersperunit);p.y=Fusion.fromMeter(this.units,p.y*map._fMetersperunit);}
if(this.precision>=0){var factor=Math.pow(10,this.precision);p.x=Math.round(p.x*factor)/factor;p.y=Math.round(p.y*factor)/factor;}}}
if(p){var unitAbbr=Fusion.unitAbbr(this.units);this.domSpan.innerHTML=this.template.replace('{x}',p.x).replace('{y}',p.y).replace('{units}',unitAbbr).replace('{units}',unitAbbr);}},setUnits:function(){if(this.units==Fusion.UNKNOWN){this.setParameter('Units',this.getMap().getUnits());}},setParameter:function(param,value){if(param=='Units'){this.units=Fusion.unitFromName(value);}}};Fusion.Widget.EditableScale=Class.create();Fusion.Widget.EditableScale.prototype={precision:4,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);var json=widgetTag.extension;var domPrefix=document.createElement('span');domPrefix.className='inputEditableScalePrefix';domPrefix.innerHTML='1: ';this.domObj.appendChild(domPrefix);this.domScale=document.createElement('input');this.domScale.className='inputEditableScale';this.domObj.appendChild(this.domScale);Event.observe(this.domScale,'keypress',this.keyPressHandler.bindAsEventListener(this));this.precision=json.Precision?parseInt(json.Precision[0]):this.precision;this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.scaleChanged.bind(this));Fusion.addWidgetStyleSheet(widgetTag.location+'/EditableScale/EditableScale.css');},scaleChanged:function(){this.domScale.value=this.scaleToString(this.getMap().oMapOL.getScale());},scaleToString:function(scale){scale=Math.abs(parseFloat(scale));return""+Math.round(scale*Math.pow(10,this.precision))/Math.pow(10,this.precision);},keyPressHandler:function(e){if(e.keyCode==Event.KEY_RETURN){this.zoomToScale();}},zoomToScale:function(e){var scale=parseFloat(this.domScale.value);if(scale){this.getMap().zoomToScale(scale);}}};Fusion.Event.HISTORY_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget.ExtentHistory=Class.create();Fusion.Widget.ExtentHistory.prototype={events:[],aHistory:[],sDirection:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;var sDirection=json.Direction?json.Direction[0].toLowerCase():'previous';if(sDirection!='previous'&&sDirection!='next'){this.sDirection='previous';}else{this.sDirection=sDirection;}
if(!this.aHistory['history']){this.aHistory['history']=[];this.aHistory['index']=-1;this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.extentsChanged.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.reset.bind(this));}
this.enable=Fusion.Widget.ExtentHistory.prototype.historyChanged;this.disable=Fusion.Widget.ExtentHistory.prototype.historyChanged;this.registerEventID(Fusion.Event.HISTORY_CHANGED);this.registerForEvent(Fusion.Event.HISTORY_CHANGED,this.historyChanged.bind(this));this.disable();},reset:function(){if(this.getMap().isMapLoaded()){this.aHistory['history']=[this.getMap().getCurrentExtents()];this.aHistory['index']=0;}else{this.aHistory['history']=[];this.aHistory['index']=-1;}
this.historyChanged();},extentsChanged:function(){var extents=this.getMap().getCurrentExtents();if(this.aHistory['history'].length==0){this.aHistory['history'].push(extents);this.aHistory['index']=0;}else{var aExtents=this.aHistory['history'][this.aHistory['index']];if(aExtents.top==extents.top&&aExtents.bottom==extents.bottom&&aExtents.left==extents.left&&aExtents.right==extents.right){return;}
if(this.aHistory['index']!=(this.aHistory['history'].length-1)){this.aHistory['history']=this.aHistory['history'].slice(0,this.aHistory['index']+1);}
this.aHistory['history'].push(extents);this.aHistory['index']=this.aHistory['history'].length-1;}
this.triggerEvent(Fusion.Event.HISTORY_CHANGED);},historyChanged:function(){if(this.sDirection=='previous'){if(this.aHistory['index']>0){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}else{Fusion.Tool.ButtonBase.prototype.disable.apply(this,[]);}}else{if(this.aHistory['index']<(this.aHistory['history'].length-1)){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}else{Fusion.Tool.ButtonBase.prototype.disable.apply(this,[]);}}},execute:function(){if(this.sDirection=='previous'){if(this.aHistory['index']>0){this.aHistory['index']--;this.getMap().setExtents(this.aHistory['history'][this.aHistory['index']]);this.triggerEvent(Fusion.Event.HISTORY_CHANGED);}}else{if(this.aHistory['index']<(this.aHistory['history'].length-1)){this.aHistory['index']++;this.getMap().setExtents(this.aHistory['history'][this.aHistory['index']]);this.triggerEvent(Fusion.Event.HISTORY_CHANGED);}}}};Fusion.Widget.Help=Class.create();Fusion.Widget.Help.prototype={sFeatures:'menubar=no,location=no,resizable=no,status=no',target:'HelpWindow',baseUrl:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.target=json.Target?json.Target[0]:"HelpWindow";this.baseUrl=json.Url?json.Url[0]:Fusion.getFusionURL()+widgetTag.location+'/Help/Help.html';if(!widgetTag.Disabled||widgetTag.Disabled[0].toLowerCase()!='true'){this.enable();}},execute:function(){var url=this.baseUrl;var taskPaneTarget=Fusion.getWidgetById(this.target);if(taskPaneTarget){taskPaneTarget.setContent(url);}else{var pageElement=$(this.target);if(pageElement){pageElement.src=url;}else{window.open(url,this.target,this.sWinFeatures);}}}};Fusion.Widget.InitialMapView=Class.create();Fusion.Widget.InitialMapView.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);},execute:function(){this.getMap().fullExtents();}};Fusion.Widget.InvokeScript=Class.create();Fusion.Widget.InvokeScript.prototype={sScript:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.sScript=json.Script?json.Script[0]:'';},execute:function(){eval(this.sScript);}};Fusion.Widget.InvokeURL=Class.create();Fusion.Widget.InvokeURL.prototype={sFeatures:'menubar=no,location=no,resizable=no,status=no',initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.sTarget=json.Target?json.Target[0]:"InvokeUrlWindow";this.sBaseUrl=json.Url[0];this.bSelectionOnly=(json.DisableIfSelectionEmpty&&(json.DisableIfSelectionEmpty[0]=='true'||json.DisableIfSelectionEmpty[0]=='1'))?true:false;this.additionalParameters=[];if(json.AdditionalParameter){for(var i=0;i<json.AdditionalParameter.length;i++){var p=json.AdditionalParameter[i];var k=p.Key[0];var v=p.Value[0];this.additionalParameters.push(k+'='+encodeURIComponent(v));}}
this.enable=Fusion.Widget.InvokeURL.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.enable.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.enable.bind(this));this.disable();},enable:function(){var map=this.getMap();if(this.bSelectionOnly||!map){if(map&&map.hasSelection()){if(this.action){this.action.setEnabled(true);}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}}else{if(this.action){this.action.setEnabled(false);}else{this.disable();}}}else{if(this.action){this.action.setEnabled(true);}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}}},execute:function(){var url=this.sBaseUrl;var map=this.getMap();var params=[];params.push('locale='+Fusion.locale);params.push('session='+map.getSessionID());params.push('mapname='+map.getMapName());params=params.concat(this.additionalParameters);if(url.indexOf('?')<0){url+='?';}else if(url.slice(-1)!='&'){url+='&';}
url+=params.join('&');var taskPaneTarget=Fusion.getWidgetById(this.sTarget);if(taskPaneTarget){taskPaneTarget.setContent(url);}else{var pageElement=$(this.sTarget);if(pageElement){pageElement.src=url;}else{window.open(url,this.sTarget,this.sWinFeatures);}}}};Fusion.Widget.LayerManager=Class.create();Fusion.Widget.LayerManager.prototype={currentNode:null,bIsDrawn:false,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);var json=widgetTag.extension;this.delIconSrc=json.DeleteIcon?json.DeleteIcon[0]:'images/icons/select-delete.png';Fusion.addWidgetStyleSheet(widgetTag.location+'LayerManager/LayerManager.css');this.cursorNormal=["url('images/grab.cur'),move",'grab','-moz-grab','move'];this.cursorDrag=["url('images/grabbing.cur'),move",'grabbing','-moz-grabbing','move'];this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.mapLoaded.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_RELOADED,this.mapLoaded.bind(this));},mapLoaded:function(){this.draw();},clear:function(node){while(node.childNodes.length>0){this.clear(node.childNodes[0]);node.remove(node.childNodes[0]);}},draw:function(r){if(this.mapList){this.mapList.remove();this.mapList=null;}
this.mapList=document.createElement('ul');Element.addClassName(this.mapList,'jxLman');this.domObj.appendChild(this.mapList);var map=this.getMap();for(var i=0;i<map.aMaps.length;++i){var mapBlock=document.createElement('li');Element.addClassName(this.mapBlock,'jxLmanMap');mapBlock.id='mapBlock_'+i;var handle=document.createElement('a');handle.innerHTML=map.aMaps[i]._sMapTitle;Element.addClassName(handle,'jxLmanHandle');mapBlock.appendChild(handle);this.mapList.appendChild(mapBlock);this.processMapBlock(mapBlock,map.aMaps[i]);}
if(map.aMaps.length>1){var options=[];options.onUpdate=this.updateMapBlock.bind(this,map);options.handle='jxLmanHandle';options.scroll=this.domObj.id;Sortable.create(this.mapList.id,options);}},processMapBlock:function(blockDom,map){var mapBlockList=document.createElement('ul');Element.addClassName(mapBlockList,'jxLmanSet');mapBlockList.id='fusionLayerManager_'+map.getMapName();blockDom.appendChild(mapBlockList);map.layerPrefix='layer_';var processArray=map.aLayers;if(map.bLayersReversed){processArray.reverse();}
for(var i=0;i<processArray.length;++i){var blockItem=document.createElement('li');Element.addClassName(blockItem,'jxLmanLayer');blockItem.id=map.layerPrefix+i;mapBlockList.appendChild(blockItem);this.createItemHtml(blockItem,processArray[i]);blockItem.layer=processArray[i];}
var options=[];options.onUpdate=this.updateLayer.bind(this,map);options.scroll=this.domObj.id;Position.includeScrollOffsets=true;Sortable.create(mapBlockList.id,options);},createItemHtml:function(parent,layer){var delIcon=document.createElement('img');delIcon.src=this.delIconSrc;Event.observe(delIcon,'click',this.deleteLayer.bind(this,layer));delIcon.style.visibility='hidden';parent.appendChild(delIcon);var visSelect=document.createElement('input');visSelect.type='checkbox';Event.observe(visSelect,'click',this.visChanged.bind(this,layer));parent.appendChild(visSelect);if(layer.visible){visSelect.checked=true;}else{visSelect.checked=false;}
var label=document.createElement('a');label.innerHTML=layer.legendLabel;Event.observe(label,'mouseover',this.setGrabCursor.bind(this));Event.observe(label,'mousedown',this.setDragCursor.bind(this));Event.observe(label,'mouseout',this.setNormalCursor.bind(this));parent.appendChild(label);Event.observe(parent,'mouseover',this.setHandleVis.bind(this,delIcon));Event.observe(parent,'mouseout',this.setHandleHide.bind(this,delIcon));},setHandleVis:function(delIcon){delIcon.style.visibility='visible';},setHandleHide:function(delIcon){delIcon.style.visibility='hidden';},setGrabCursor:function(ev){this.setCursor(this.cursorNormal,Event.element(ev));},setDragCursor:function(ev){this.setCursor(this.cursorDrag,Event.element(ev));},setNormalCursor:function(ev){this.setCursor('auto',Event.element(ev));},setCursor:function(cursor,domObj){this.cursor=cursor;if(cursor&&cursor.length&&typeof cursor=='object'){for(var i=0;i<cursor.length;i++){domObj.style.cursor=cursor[i];if(domObj.style.cursor==cursor[i]){break;}}}else if(typeof cursor=='string'){domObj.style.cursor=cursor;}else{domObj.style.cursor='auto';}},updateLayer:function(map,ul){var aLayerIndex=[];var aIds=[];var nLayers=ul.childNodes.length;for(var i=0;i<nLayers;++i){aIds[i]=ul.childNodes[i].id.split('_');var index=parseInt(aIds[i].pop());if(map.bLayersReversed){index=nLayers-(index+1);}
aLayerIndex.push(index);ul.childNodes[i].id='';}
for(var i=0;i<ul.childNodes.length;++i){var node=ul.childNodes[i];aIds[i].push(i);node.id=aIds[i].join('_');node.childNodes[1].checked=node.layer.isVisible()}
if(map.bLayersReversed){aLayerIndex.reverse();}
map.reorderLayers(aLayerIndex);},updateMapBlock:function(map,ul){},deleteLayer:function(layer,ev){var targetLI=Event.element(ev).parentNode;var ul=targetLI.parentNode;Element.remove(targetLI.id);this.updateLayer(layer.oMap,ul);},visChanged:function(layer2,ev){var target=Event.element(ev);var layer=target.parentNode.layer;if(target.checked){layer.show();}else{layer.hide();}}};Fusion.Widget.Legend=Class.create();Fusion.Widget.Legend.prototype={currentNode:null,bIsDrawn:false,targetFolder:null,initialize:function(widgetTag){this.defLayerDWFIcon='images/icons/legend-DWF.png';this.defLayerRasterIcon='images/icons/legend-raster.png';this.defLayerThemeIcon='images/icons/legend-theme.png';this.defDisabledLayerIcon='images/icons/legend-layer.png';this.defRootFolderIcon='images/icons/legend-map.png';this.defLayerInfoIcon='images/icons/tree_layer_info.png';this.defGroupInfoIcon='images/icons/tree_group_info.png';this.bIncludeVisToggle=true;Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);var json=widgetTag.extension;this.imgLayerDWFIcon=json.LayerDWFIcon?json.LayerDWFIcon[0]:this.defLayerDWFIcon;this.imgLayerRasterIcon=json.LayerRasterIcon?json.LayerRasterIcon[0]:this.defLayerRasterIcon;this.imgLayerThemeIcon=json.LayerThemeIcon?json.LayerThemeIcon[0]:this.defLayerThemeIcon;this.imgDisabledLayerIcon=json.DisabledLayerIcon?json.DisabledLayerIcon[0]:this.defDisabledLayerIcon;this.imgLayerInfoIcon=json.LayerInfoIcon?json.LayerInfoIcon[0]:this.defLayerInfoIcon;this.imgGroupInfoIcon=json.GroupInfoIcon?json.GroupInfoIcon[0]:this.defGroupInfoIcon;this.selectedLayer=null;this.oTree=new Jx.Tree(this.domObj);this.hideInvisibleLayers=(json.HideInvisibleLayers&&json.HideInvisibleLayers[0])=='true'?true:false;this.refreshAction=new Jx.Action(this.update.bind(this));this.refreshItem=new Jx.MenuItem(this.refreshAction,{label:OpenLayers.String.translate('refresh')});this.expandAllAction=new Jx.Action(this.expandAll.bind(this));this.expandAllItem=new Jx.MenuItem(this.expandAllAction,{label:OpenLayers.String.translate('expandAll')});this.expandBranchAction=new Jx.Action(this.expandBranch.bind(this));this.expandBranchItem=new Jx.MenuItem(this.expandBranchAction,{label:OpenLayers.String.translate('expand')});this.collapseAllAction=new Jx.Action(this.collapseAll.bind(this));this.collapseAllItem=new Jx.MenuItem(this.collapseAllAction,{label:OpenLayers.String.translate('collapseAll')});this.collapseBranchAction=new Jx.Action(this.collapseBranch.bind(this));this.collapseBranchItem=new Jx.MenuItem(this.collapseBranchAction,{label:OpenLayers.String.translate('collapse')});this.contextMenu=new Jx.ContextMenu(this.sName);this.contextMenu.add(this.collapseBranchItem,this.expandBranchItem,this.refreshItem,this.expandAllItem,this.collapseAllItem);this.showRootFolder=(json.ShowRootFolder&&json.ShowRootFolder[0]=='false')?false:true;this.showMapFolder=(json.ShowMapFolder&&json.ShowMapFolder[0]=='false')?false:true;if(this.showRootFolder){var opt={};opt.label=OpenLayers.String.translate('defaultMapTitle');opt.data=null;opt.imgTreeFolder=json.RootFolderIcon?json.RootFolderIcon[0]:this.defRootFolderIcon;opt.imgTreeFolderOpen=opt.imgTreeFolder;opt.isOpen=true;opt.contextMenu=this.contextMenu;this.oRoot=new Jx.TreeFolder(opt);this.oTree.append(this.oRoot);Event.observe(this.oRoot.domObj,'mouseover',this.setFolder.bind(this));}else{this.oRoot=this.oTree;}
this.extentsChangedWatcher=this.update.bind(this);this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.mapLoaded.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_RELOADED,this.draw.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADING,this.mapLoading.bind(this));},expandAll:function(){this.recurseTree('expand',this.oRoot);},collapseAll:function(){this.recurseTree('collapse',this.oRoot);},collapseBranch:function(){if(this.targetFolder&&this.targetFolder instanceof Jx.TreeFolder){this.targetFolder.collapse();}},expandBranch:function(){if(this.targetFolder&&this.targetFolder instanceof Jx.TreeFolder){this.targetFolder.expand();}},recurseTree:function(op,folder){for(var i=0;i<folder.nodes.length;i++){var item=folder.nodes[i];if(item instanceof Jx.TreeFolder){this.recurseTree(op,item);item[op]();}}},setFolder:function(evt){var element=Event.element(evt);this.targetFolder=element.jxTreeItem;},mapLoading:function(){this.getMap().deregisterForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.extentsChangedWatcher);this.clear();},mapLoaded:function(){this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.extentsChangedWatcher);this.draw();},invalidate:function(){this.draw();},draw:function(r){this.bIsDrawn=false;this.clear();var map=this.getMap();if(this.showRootFolder){this.oRoot.setName(map.getMapTitle());}
this.oMapInfo=map.oMapInfo;var startGroup=map.layerRoot;if(!this.showMapFolder){startGroup=map.layerRoot.groups[0];}
if(!startGroup.legend){startGroup.legend={};startGroup.legend.treeItem=this.oRoot;}
for(var i=0;i<startGroup.groups.length;i++){startGroup.groups[i].visible=true;this.processMapGroup(startGroup.groups[i],this.oRoot);}
for(var i=0;i<startGroup.layers.length;i++){this.processMapLayer(startGroup.layers[i],this.oRoot);}
this.bIsDrawn=true;this.update();},processMapGroup:function(group,folder){if(group.displayInLegend){group.legend={};var opt={};opt.label=group.legendLabel;opt.data=group;opt.contextMenu=this.contextMenu;opt.isOpen=group.expandInLegend;group.legend.treeItem=new Jx.TreeFolder(opt);folder.append(group.legend.treeItem);group.legend.checkBox=document.createElement('input');group.legend.checkBox.type='checkbox';group.legend.treeItem.domObj.insertBefore(group.legend.checkBox,group.legend.treeItem.domObj.childNodes[1]);group.legend.checkBox.checked=group.visible?true:false;Event.observe(group.legend.checkBox,'click',this.stateChanged.bind(this,group));Event.observe(group.legend.treeItem.domObj,'mouseover',this.setFolder.bind(this));var groupInfo=this.getGroupInfoUrl(group.groupName);if(groupInfo){var a=document.createElement('a');a.href=groupInfo;a.target='_blank';var img=document.createElement('img');Jx.addToImgQueue({domElement:img,src:this.imgGroupInfoIcon});img.border=0;a.appendChild(img);group.legend.treeItem.domObj.insertBefore(a,group.legend.treeItem.domObj.childNodes[4]);}
if(this.oSelectionListener){group.legend.treeItem.addSelectionListener(this);}
for(var i=0;i<group.groups.length;i++){this.processMapGroup(group.groups[i],group.legend.treeItem);}
for(var i=0;i<group.layers.length;i++){this.processMapLayer(group.layers[i],group.legend.treeItem);}}},processMapLayer:function(layer,folder){layer.legend={};layer.legend.parentItem=folder;layer.legend.checkBox=document.createElement('input');layer.legend.checkBox.type='checkbox';Event.observe(layer.legend.checkBox,'click',this.stateChanged.bind(this,layer));layer.legend.currentRange=null;layer.registerForEvent(Fusion.Event.LAYER_PROPERTY_CHANGED,this.layerPropertyChanged.bind(this));},layerPropertyChanged:function(eventID,layer){layer.legend.checkBox.checked=layer.isVisible();},update:function(){if(this.bIsDrawn){window.setTimeout(this._update.bind(this),1);}},_update:function(){var map=this.getMap();var currentScale=map.getScale();for(var i=0;i<map.layerRoot.groups.length;i++){this.updateGroupLayers(map.layerRoot.groups[i],currentScale);}
for(var i=0;i<map.layerRoot.layers.length;i++){this.updateLayer(map.layerRoot.layers[i],currentScale);}},clear:function(){while(this.oRoot.nodes.length>0){this.oRoot.remove(this.oRoot.nodes[0]);}},selectionChanged:function(o){if(this.currentNode){Element.removeClassName(this.currentNode.domObj.childNodes[3],'jxTreeSelectedNode');}
this.currentNode=o;Element.addClassName(this.currentNode.domObj.childNodes[3],'jxTreeSelectedNode');if(o.data instanceof Fusion.Widget.Map.Group){this.getMap().setActiveLayer(null);}else{this.getMap().setActiveLayer(o.data);}},updateGroupLayers:function(group,fScale){for(var i=0;i<group.groups.length;i++){this.updateGroupLayers(group.groups[i],fScale);}
for(var i=0;i<group.layers.length;i++){this.updateLayer(group.layers[i],fScale);}},updateLayer:function(layer,fScale){if(!layer.displayInLegend){return;}
var range=layer.getScaleRange(fScale);if(range==layer.legend.currentRange&&layer.legend.treeItem){return;}
layer.legend.currentRange=range;if(range!=null){if(range.styles.length>0){layer.legend.checkBox.disabled=false;}else{layer.legend.checkBox.disabled=true;}
if(range.styles.length>1){if(!layer.legend.treeItem){layer.legend.treeItem=this.createFolderItem(layer);layer.parentGroup.legend.treeItem.append(layer.legend.treeItem);}else if(layer.legend.treeItem instanceof Jx.TreeItem){this.clearTreeItem(layer);layer.legend.treeItem=this.createFolderItem(layer);layer.parentGroup.legend.treeItem.append(layer.legend.treeItem);}else{while(layer.legend.treeItem.nodes.length>0){layer.legend.treeItem.remove(layer.legend.treeItem.nodes[0]);}}
for(var i=0;i<range.styles.length;i++){var item=this.createTreeItem(layer,range.styles[i],fScale,false);layer.legend.treeItem.append(item);}}else{var style=range.styles[0];if(!layer.legend.treeItem){layer.legend.treeItem=this.createTreeItem(layer,style,fScale,this.bIncludeVisToggle);layer.parentGroup.legend.treeItem.append(layer.legend.treeItem);}else if(layer.legend.treeItem instanceof Jx.TreeFolder){this.clearTreeItem(layer);layer.legend.treeItem=this.createTreeItem(layer,style,fScale,this.bIncludeVisToggle);layer.parentGroup.legend.treeItem.append(layer.legend.treeItem);}else{if(range.styles.length>0){Jx.addToImgQueue({domElement:layer.legend.treeItem.domObj.childNodes[2],src:range.styles[0].getLegendImageURL(fScale,layer,this.getMap())});Element.removeClassName(layer.legend.treeItem.domObj,'jxDisabled');}else{Element.addClassName(layer.legend.treeItem.domObj,'jxDisabled');}}}}else{if(this.hideInvisibleLayers){if(layer.legend.treeItem){layer.parentGroup.legend.treeItem.remove(layer.legend.treeItem);layer.legend.treeItem=null;}}else{layer.legend.checkBox.disabled=true;var newTreeItem=this.createTreeItem(layer,null,null,this.bIncludeVisToggle);if(layer.legend.treeItem){layer.parentGroup.legend.treeItem.replace(newTreeItem,layer.legend.treeItem);layer.legend.treeItem.finalize();}else{layer.parentGroup.legend.treeItem.append(newTreeItem);}
layer.legend.treeItem=newTreeItem;}}
layer.legend.checkBox.checked=layer.visible?true:false;},createFolderItem:function(layer){var opt={};opt.label=layer.legendLabel==''?'&nbsp;':layer.legendLabel;opt.data=layer;opt.isOpen=layer.expandInLegend;opt.contextMenu=this.contextMenu;opt.imgTreeFolderOpen=this.imgLayerThemeIcon;opt.imgTreeFolder=this.imgLayerThemeIcon;var folder=new Jx.TreeFolder(opt);folder.domObj.insertBefore(layer.legend.checkBox,folder.domObj.childNodes[1]);var layerInfo=this.getLayerInfoUrl(layer.layerName);if(layerInfo){var a=document.createElement('a');a.href=layerInfo;a.target='_blank';var img=document.createElement('img');Jx.addToImgQueue({domElement:img,src:this.imgLayerInfoIcon});img.border=0;a.appendChild(img);folder.domObj.insertBefore(a,folder.domObj.childNodes[4]);}
folder.addSelectionListener(this);Event.observe(folder.domObj,'mouseover',this.setFolder.bind(this));return folder;},createTreeItem:function(layer,style,scale,bCheckBox){var opt={};if(bCheckBox){opt.label=layer.legendLabel==''?'&nbsp;':layer.legendLabel;}else{opt.label=style.legendLabel==''?'&nbsp;':style.legendLabel;}
opt.data=layer;opt.contextMenu=this.contextMenu;if(!style){opt.imgIcon=this.imgDisabledLayerIcon;opt.enabled=false;}else{if(style.staticIcon){if(style.staticIcon==Fusion.Constant.LAYER_DWF_TYPE){opt.imgIcon=this.imgLayerDWFIcon;}else{opt.imgIcon=this.imgLayerRasterIcon;}}else{opt.imgIcon=style.getLegendImageURL(scale,layer);}}
var item=new Jx.TreeItem(opt);if(bCheckBox){item.domObj.insertBefore(layer.legend.checkBox,item.domObj.childNodes[1]);var layerInfo=this.getLayerInfoUrl(layer.layerName);if(layerInfo){var a=document.createElement('a');a.href=layerInfo;a.target='_blank';var img=document.createElement('img');Jx.addToImgQueue({domElement:img,src:this.imgLayerInfoIcon});img.border=0;a.appendChild(img);item.domObj.insertBefore(a,item.domObj.childNodes[4]);}}
item.addSelectionListener(this);return item;},clearTreeItem:function(layer){if(layer.legend.treeItem&&layer.legend.treeItem.parent){layer.legend.treeItem.parent.remove(layer.legend.treeItem);layer.legend.treeItem.finalize();layer.legend.treeItem=null;}},stateChanged:function(obj){if(obj.legend&&obj.legend.checkBox){if(obj.legend.checkBox.checked){obj.show();}else{obj.hide();}}},getGroupInfoUrl:function(groupName){if(this.oMapInfo){var groups=this.oMapInfo.links.groups;for(var i=0;i<groups.length;i++){if(groups[i].name==groupName){return groups[i].url;}}}
return null;},getLayerInfoUrl:function(layerName){if(this.oMapInfo){var layers=this.oMapInfo.links.layers;for(var i=0;i<layers.length;i++){if(layers[i].name==layerName){return layers[i].url;}}}
return null;}};Fusion.Widget.LinkToView=Class.create();Fusion.Widget.LinkToView.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);var json=widgetTag.extension;this.baseUrl=window.location.protocol+'//'+window.location.host+window.location.pathname+'?';var queryParams=Fusion.parseQueryString();var join='';for(var param in queryParams){if(typeof queryParams[param]=='function'){continue;}
if(param=='extent'){continue;}
this.baseUrl+=join+param+'='+queryParams[param];join='&';}
this.anchorLabel=this.domObj.innerHTML;this.anchor=document.createElement('a');this.anchor.className='anchorLinkToView';this.anchor.href=this.baseUrl;this.anchor.innerHTML=this.anchorLabel;this.anchor.title=this.domObj.innerHTML='';this.domObj.appendChild(this.anchor);this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.updateLink.bind(this));this.enable();},updateLink:function(){var sBbox=this.getMap().getCurrentExtents().toBBOX();var join=(this.baseUrl.indexOf('?')==this.baseUrl.length-1)?'':'&';this.anchor.href=this.baseUrl+join+'extent='+sBbox;}};Fusion.Widget.MapMenu=Class.create();Fusion.Widget.MapMenu.prototype={domObj:null,oMenu:null,sRootFolder:'',aMenus:null,initialize:function(widgetTag)
{Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.MenuBase.prototype,[]);this.enable();var json=widgetTag.extension;var mapGroups=Fusion.applicationDefinition.mapGroups;for(var i=0;i<mapGroups.length;i++){var mapGroup=mapGroups[i];var opt={};opt.label=mapGroup.mapId;var data=mapGroup;var action=new Jx.Action(this.switchMap.bind(this,data));var menuItem=new Jx.MenuItem(action,opt);this.oMenu.add(menuItem);}},switchMap:function(data){this.getMap().loadMapGroup(data);}};Fusion.Widget.Maptip=Class.create();Fusion.Widget.Maptip.prototype={oCurrentPosition:null,oMapTipPosition:null,nTimer:null,delay:null,aLayers:null,bOverTip:false,initialize:function(widgetTag)
{Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);var json=widgetTag.extension;this.delay=json.Delay?parseInt(json.Delay[0]):350;this.aLayers=[];if(json.Layer){for(var i=0;i<json.Layer.length;i++){this.aLayers.push(json.Layer[i]);}}
this.domObj.parentNode.removeChild(this.domObj);this.domObj.style.position='absolute';this.domObj.style.display='none';this.domObj.style.top='0px';this.domObj.style.left='0px';this.domObj.style.zIndex=101;Event.observe(this.domObj,'mouseover',this.mouseOverTip.bind(this));Event.observe(this.domObj,'mouseout',this.mouseOutTip.bind(this));var oDomElem=this.getMap().getDomObj();oDomElem.appendChild(this.domObj);this.getMap().observeEvent('mousemove',this.mouseMove.bind(this));this.getMap().observeEvent('mouseout',this.mouseOut.bind(this));},mouseOut:function(e){if(this.nTimer){window.clearTimeout(this.nTimer);if(!this.nHideTimer){this.nHideTimer=window.setTimeout(this.hideMaptip.bind(this),250);}}},mouseMove:function(e){if(this.bOverTip){return;}
var p=this.getMap().getEventPosition(e);if(!this.oCurrentPosition){this.oCurrentPosition=p;}else{window.clearTimeout(this.nTimer);this.nTimer=null;if(this.oMapTipPosition&&this.bIsVisible&&Math.abs(this.oMapTipPosition.x-this.oCurrentPosition.x)>3&&Math.abs(this.oMapTipPosition.y-this.oCurrentPosition.y)>3){this.nHideTimer=window.setTimeout(this.hideMaptip.bind(this),250);}
this.oCurrentPosition=p;}
this.nTimer=window.setTimeout(this.showMaptip.bind(this),this.delay);},showMaptip:function(r){var map=this.getMap();if(map==null){return;}
var cellSize=map._nCellSize;cellSize=1e-6;var oBroker=Fusion.oBroker;var x=this.oCurrentPosition.x;var y=this.oCurrentPosition.y;var min=map.pixToGeo(x,y);if(!min){return;}
min.x-=cellSize;min.y-=cellSize;var max=map.pixToGeo(x,y);max.x+=cellSize;max.y+=cellSize;var sGeometry='POLYGON(('+min.x+' '+min.y+', '+min.x+' '+max.y+', '+max.x+' '+max.y+', '+max.x+' '+min.y+', '+min.x+' '+min.y+'))';var maxFeatures=1;var persist=0;var selection='INTERSECTS';var maps=this.getMap().getAllMaps();var layerNames=this.aLayers.toString();var r=new Fusion.Lib.MGRequest.MGQueryMapFeatures(maps[0].getSessionID(),maps[0]._sMapname,sGeometry,maxFeatures,persist,selection,layerNames);oBroker.dispatchRequest(r,this._display.bind(this));},_display:function(r){if(r.responseXML){this.bIsVisible=true;this.oMapTipPosition={x:this.oCurrentPosition.x,y:this.oCurrentPosition.y};var d=new DomNode(r.responseXML);var t=d.getNodeText('Tooltip');if(t!=''){t=t.replace(/\\n/g,"<br>");this.domObj.innerHTML=t;this.domObj.style.visibility='hidden';this.domObj.style.display='block';var size=Element.getDimensions(this.domObj);this.domObj.style.top=(this.oCurrentPosition.y-size.height)+'px';this.domObj.style.left=this.oCurrentPosition.x+'px';this.domObj.style.visibility='visible';}}else{this.bIsVisible=false;}},hideMaptip:function(){this.bIsVisible=false;this.hideTimer=window.setTimeout(this._hide.bind(this),250);},_hide:function(){this.hideTimer=null;this.domObj.style.display='none';this.domObj.innerHTML='&nbsp;';this.oMapTipPosition=null;},mouseOverTip:function(){window.clearTimeout(this.nHideTimer);this.nHideTimer=null;this.bOverTip=true;},mouseOutTip:function(){this.nHideTimer=window.setTimeout(this.hideMaptip.bind(this),250);this.bOverTip=false;}};Fusion.Constant.MEASURE_TYPE_DISTANCE=0;Fusion.Constant.MEASURE_TYPE_AREA=1;Fusion.Constant.MEASURE_TYPE_BOTH=2;Fusion.Event.MEASURE_NEW_SEGMENT=Fusion.Event.lastEventId++;Fusion.Event.MEASURE_SEGMENT_UPDATE=Fusion.Event.lastEventId++;Fusion.Event.MEASURE_SEGMENT_COMPLETE=Fusion.Event.lastEventId++;Fusion.Event.MEASURE_CLEAR=Fusion.Event.lastEventId++;Fusion.Widget.Measure=Class.create();Fusion.Widget.Measure.prototype={isDigitizing:false,distances:null,distanceMarkers:null,aAreaFirstPoint:null,cumulativeDistance:0,lastDistance:0,cumulativeArea:0,lastArea:0,aAreas:[],units:Fusion.UNKNOWN,mType:null,distPrecision:0,areaPrecision:0,measureTip:null,measureTipPositionTop:null,measureTipPositionLeft:null,tooltipType:'',distanceNormalStyle:null,fillStyle:null,areaStyle:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);Object.inheritFrom(this,Fusion.Tool.Canvas.prototype,[]);this.asCursor=['crosshair'];var json=widgetTag.extension;this.units=(json.Units&&(json.Units[0]!=''))?Fusion.unitFromName(json.Units[0]):this.units;this.distPrecision=json.DistancePrecision?json.DistancePrecision[0]:2;this.areaPrecision=json.AreaPrecision?json.AreaPrecision[0]:2;this.sTarget=json.Target?json.Target[0]:"";this.sBaseUrl=Fusion.getFusionURL()+'widgets/Measure/Measure.php';this.measureType=Fusion.Constant.MEASURE_TYPE_BOTH;if(json.Type){switch(json.Type[0].toLowerCase()){case'distance':this.measureType=Fusion.Constant.MEASURE_TYPE_DISTANCE;break;case'area':this.measureType=Fusion.Constant.MEASURE_TYPE_AREA;break;}}
this.measureType=Fusion.Constant.MEASURE_TYPE_DISTANCE;var fillStyle=json.FillStyle?json.FillStyle[0]:'rgba(0,0,255, 0.3)';var lineStyleWidth=json.LineStyleWidth?json.LineStyleWidth[0]:2;var lineStyleColor=json.LineStyleColor?json.LineStyleColor[0]:'rgba(0,0,255,0.3)';this.fillStyle=new Fusion.Tool.Canvas.Style({fillStyle:fillStyle});this.lineStyle=new Fusion.Tool.Canvas.Style({lineWidth:lineStyleWidth,strokeStyle:lineStyleColor});this.distanceMarkers=[];this.distances=[];this.registerEventID(Fusion.Event.MEASURE_NEW_SEGMENT);this.registerEventID(Fusion.Event.MEASURE_SEGMENT_COMPLETE);this.registerEventID(Fusion.Event.MEASURE_SEGMENT_UPDATE);this.registerEventID(Fusion.Event.MEASURE_CLEAR);this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.resetCanvas.bind(this));this.keyHandler=this.onKeyPress.bind(this);Fusion.addWidgetStyleSheet(widgetTag.location+'Measure/Measure.css');this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.setUnits.bind(this));this.registerParameter('Units');},onKeyPress:function(e){var charCode=(e.charCode)?e.charCode:((e.keyCode)?e.keyCode:e.which);if(charCode==Event.KEY_ESC){this.resetCanvas();}},activateTool:function(){this.getMap().activateWidget(this);this._oButton.activateTool();},initVars:function(){this.aDistances=[];this.aAreas=[];this.cumulativeDistance=0;this.lastDistance=0;this.cumulativeArea=0;this.lastArea=0;this.aAreaFirstPoint=null;},activate:function(){this.activateCanvas();this.initVars();this.triggerEvent(Fusion.Event.MEASURE_CLEAR,this);Event.observe(document,"keypress",this.keyHandler);this.showPanel();},showPanel:function(){if(this.sTarget){var url=this.sBaseUrl;var taskPaneTarget=Fusion.getWidgetById(this.sTarget);var pageElement=$(this.sTarget);if(taskPaneTarget){taskPaneTarget.setContent(url);}else{if(pageElement){pageElement.src=url;}else{window.open(url,this.sTarget,this.sWinFeatures);}}}},deactivate:function(){Event.stopObserving(document,'keypress',this.keyHandler);this._oButton.deactivateTool();this.deactivateCanvas();this.resetCanvas();},resetCanvas:function(){if(this.isDigitizing){this.isDigitizing=false;}
this.clearContext();this.initVars();for(var i=0;i<this.distanceMarkers.length;i++){this.distanceMarkers[i].destroy();}
this.distanceMarkers=[];this.triggerEvent(Fusion.Event.MEASURE_CLEAR,this);},mouseDown:function(e){if(Event.isLeftClick(e)){var map=this.getMap();var p=map.getEventPosition(e);var gp=map.pixToGeo(p.x,p.y);if(!this.isDigitizing){this.resetCanvas();var from=new Fusion.Tool.Canvas.Node(gp.x,gp.y,map);var to=new Fusion.Tool.Canvas.Node(gp.x,gp.y,map);var lastSegment=new Fusion.Tool.Canvas.Segment(from,to);if(this.measureType==Fusion.Constant.MEASURE_TYPE_DISTANCE){this.feature=new Fusion.Tool.Canvas.Line(map);this.feature.lineStyle=this.lineStyle;}else{this.feature=new Fusion.Tool.Canvas.Polygon(map);this.feature.fillStyle=this.fillStyle;this.feature.lineStyle=this.lineStyle;}
this.feature.addSegment(lastSegment);this.aAreaFirstPoint=new Fusion.Tool.Canvas.Node(gp.x,gp.y,map);this.isDigitizing=true;}else{var lastSegment=this.feature.lastSegment();lastSegment.to.set(gp.x,gp.y);if(lastSegment.from.x==lastSegment.to.x&&lastSegment.from.y==lastSegment.to.y){this.dblClick(e);return;}
this.feature.extendLine();this.updateMarker(this.lastMarker,lastSegment,e);}
this.lastMarker=new Fusion.Widget.Measure.DistanceMarker(this.units);this.distanceMarkers.push(this.lastMarker);this.clearContext();this.feature.draw(this.context);}},mouseMove:function(e){if(!this.isDigitizing){return;}
var offset={x:0,y:0};var oElement=this.getMap().getDomObj();var target=e.target||e.srcElement;if(target.id!='featureDigitizer'){return;}
if(this.delayUpdateTimer){window.clearTimeout(this.delayUpdateTimer);}
var map=this.getMap();var p=map.getEventPosition(e);var gp=map.pixToGeo(p.x,p.y);var lastSegment=this.feature.lastSegment();lastSegment.to.set(gp.x,gp.y);this.clearContext();this.feature.draw(this.context);this.delayUpdateTimer=window.setTimeout(this.delayUpdate.bind(this,lastSegment,e),250);this.lastMarker.setCalculating();this.triggerEvent(Fusion.Event.MEASURE_SEGMENT_UPDATE,this,this.lastMarker,null);this.positionMarker(this.lastMarker,lastSegment);},delayUpdate:function(lastSegment,e){this.delayUpdateTimer=null;this.updateMarker(this.lastMarker,lastSegment,e);},dblClick:function(e){if(!this.isDigitizing){return;}
var p=this.getMap().getEventPosition(e);var gp=this.getMap().pixToGeo(p.x,p.y);var seg=this.feature.lastSegment();seg.to.set(gp.x,gp.y);this.clearContext();this.feature.draw(this.context);if(this.measureType==Fusion.Constant.MEASURE_TYPE_AREA||this.measureType==Fusion.Constant.MEASURE_TYPE_BOTH){}
if(this.measureType==Fusion.Constant.MEASURE_TYPE_DISTANCE||this.measureType==Fusion.Constant.MEASURE_TYPE_BOTH){}
this.isDigitizing=false;},positionMarker:function(marker,segment){var oDomElem=this.getMap().getDomObj();if(!marker.domObj.parentNode||marker.domObj.parentNode!=oDomElem){oDomElem.appendChild(marker.domObj);this.triggerEvent(Fusion.Event.MEASURE_NEW_SEGMENT,this,marker);}
var size=marker.getSize();var t=(segment.from.py+segment.to.py-size.height)/2;var l=(segment.from.px+segment.to.px-size.width)/2;marker.domObj.style.top=t+'px';marker.domObj.style.left=l+'px';},updateMarker:function(marker,segment,e){if(!marker){return;}
this.measureSegment(segment,marker);this.positionMarker(marker,segment);},measureSegment:function(segment,marker){var points='&x1='+segment.from.x+'&y1='+segment.from.y+'&x2='+segment.to.x+'&y2='+segment.to.y;var map=this.getMap();var aMaps=map.getAllMaps();var s=aMaps[0].arch+'/'+Fusion.getScriptLanguage()+"/Measure."+Fusion.getScriptLanguage();var sessionId=aMaps[0].getSessionID();var params={};params.parameters='session='+sessionId+'&locale='+Fusion.locale+'&mapname='+this.getMap().getMapName()+points;params.onComplete=this.measureCompleted.bind(this,segment,marker);Fusion.ajaxRequest(s,params);},measureCompleted:function(segment,marker,r,json){if(json&&r.status==200){var o;eval('o='+r.responseText);if(o.distance){mapUnits=Fusion.METERS;if(mapUnits!=this.units){o.distance=Fusion.convert(mapUnits,this.units,o.distance);}
var p=Math.pow(10,this.distPrecision);var d=Math.round(o.distance*p)/p;marker.setDistance(d);this.positionMarker(marker,segment);if(segment==this.feature.lastSegment()){this.triggerEvent(Fusion.Event.MEASURE_SEGMENT_UPDATE,this,marker,d);}else{this.triggerEvent(Fusion.Event.MEASURE_SEGMENT_COMPLETE,this,marker,d);}}}},setUnits:function(){if(this.units==Fusion.UNKNOWN){this.setParameter('Units',this.getMap().getUnits());}},setParameter:function(param,value){if(param=='Units'){this.units=Fusion.unitFromName(value);for(var i=0;i<this.distanceMarkers.length;i++){this.distanceMarkers[i].setUnits(this.units);}}}};Fusion.Event.MARKER_DISTANCE_CHANGED=Fusion.Event.lastEventId++;Fusion.Widget.Measure.DistanceMarker=Class.create();Fusion.Widget.Measure.DistanceMarker.prototype={calculatingImg:null,isCalculating:false,distance:null,initialize:function(units){Object.inheritFrom(this,Fusion.Lib.EventMgr,[]);this.registerEventID(Fusion.Event.MARKER_DISTANCE_CHANGED);this.domObj=document.createElement('div');this.domObj.className='divMeasureMarker';this.setUnits(units);this.calculatingImg=document.createElement('img');this.calculatingImg.src=Fusion.getFusionURL()+'widgets/Measure/MeasurePending.gif';this.calculatingImg.width=19;this.calculatingImg.height=4;this.setCalculating();},destroy:function(){Fusion.Lib.EventMgr.destroy.apply(this,[]);if(this.domObj.parentNode){this.domObj.parentNode.removeChild(this.domObj);}},setUnits:function(units){this.unit=units;this.unitAbbr=Fusion.unitAbbr(units);if(this.distance){this.setDistance(this.distance);}},getDistance:function(){return this.distance;},getDistanceLabel:function(){if(this.distance){var distance=this.distance;return distance+' '+this.unitAbbr;}else{return false;}},setDistance:function(distance){if(this.calculatingImg.parentNode){this.calculatingImg.parentNode.removeChild(this.calculatingImg);}
this.distance=distance;this.domObj.innerHTML=this.getDistanceLabel();this.isCalculating=false;this.triggerEvent(Fusion.Event.MARKER_DISTANCE_CHANGED,this);},setCalculating:function(){if(!this.isCalculating){this.isCalculating=true;this.domObj.innerHTML='';this.domObj.appendChild(this.calculatingImg);this.distance=false;this.triggerEvent(Fusion.Event.MARKER_DISTANCE_CHANGED,this);}},getSize:function(){var size=Element.getDimensions(this.domObj);var imgSize={width:19,height:4};if(size.width<imgSize.width){size.width+=imgSize.width;}
if(size.height<imgSize.height){size.height+=imgSize.height;}
return size;}};Fusion.Widget.Navigator=Class.create();Fusion.Widget.Navigator.prototype={bInternalChange:false,zoomFactor:2,panAmount:50,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);var m=document.createElement('map');m.name='Navigator_ImageMap';m.id='Navigator_ImageMap';var a=document.createElement('area');a.shape='poly';a.alt='Pan East';a.title='Pan East';a.coords='27,176, 27,177, 40,190, 44,182, 44,159';Event.observe(a,'mouseup',this.pan.bindAsEventListener(this,this.panAmount/100,0));m.appendChild(a);var a=document.createElement('area');a.shape='poly';a.alt='Pan West';a.title='Pan West';a.coords='24,177, 24,176, 7,159, 7,182, 11,190';Event.observe(a,'mouseup',this.pan.bindAsEventListener(this,-this.panAmount/100,0));m.appendChild(a);var a=document.createElement('area');a.shape='poly';a.alt='Pan South';a.title='Pan South';a.coords='25,178, 12,191, 21,197, 30,197, 39,191, 26,178';Event.observe(a,'mouseup',this.pan.bindAsEventListener(this,0,-this.panAmount/100));m.appendChild(a);var a=document.createElement('area');a.shape='poly';a.alt='Pan North';a.title='Pan North';a.coords='26,175, 43,158, 8,158, 25,175';Event.observe(a,'mouseup',this.pan.bindAsEventListener(this,0,this.panAmount/100));m.appendChild(a);var a=document.createElement('area');a.shape='circle';a.alt='Zoom Out';a.title='Zoom Out';a.coords='25,142,8';Event.observe(a,'mouseup',this.zoom.bindAsEventListener(this,1/this.zoomFactor));m.appendChild(a);var a=document.createElement('area');a.shape='circle';a.alt='Zoom In';a.title='Zoom In';a.coords='25,34,8';Event.observe(a,'mouseup',this.zoom.bindAsEventListener(this,this.zoomFactor));m.appendChild(a);this.domObj.appendChild(m);var sliderBg=document.createElement('img');sliderBg.src=Fusion.getFusionURL()+widgetTag.location+'Navigator/sliderscale.png';sliderBg.className='png24';sliderBg.width=51;sliderBg.height=201;sliderBg.style.position='absolute';sliderBg.style.left='0px';sliderBg.style.top='0px';sliderBg.useMap='#Navigator_ImageMap';this.domObj.appendChild(sliderBg);var handleDiv=document.createElement('div');handleDiv.style.position='absolute';handleDiv.style.top='6px';handleDiv.style.left='6px';handleDiv.style.width='39px';handleDiv.style.height='16px';this.domObj.appendChild(handleDiv);var sliderDiv=document.createElement('div');sliderDiv.style.position='absolute';sliderDiv.style.top='44px';sliderDiv.style.left='0px';sliderDiv.style.width='51px';sliderDiv.style.height='88px';this.domObj.appendChild(sliderDiv);var sliderHandle=document.createElement('img');sliderHandle.src=Fusion.getFusionURL()+widgetTag.location+'Navigator/slider.png';sliderHandle.className='png24';sliderHandle.width=29;sliderHandle.height=12;sliderHandle.style.position='absolute';sliderHandle.style.left='11px';sliderHandle.style.top='49px';sliderDiv.appendChild(sliderHandle);this.activityIndicator=document.createElement('img');this.activityIndicator.src=Fusion.getFusionURL()+widgetTag.location+'Navigator/spinner.gif';this.activityIndicator.width=18;this.activityIndicator.height=6;this.activityIndicator.style.position='absolute';this.activityIndicator.style.top='3px';this.activityIndicator.style.right='4px';handleDiv.appendChild(this.activityIndicator);this.domObj.style.position='absolute';this.domObj.style.zIndex=1000;this.domObj.style.width='51px';this.domObj.style.height='204px';this.domObj.style.cursor='pointer';var checkPosition=this.checkPosition.bind(this);new Draggable(this.domObj,{handle:handleDiv,starteffect:false,endeffect:false});var observer={element:this.domObj,onStart:function(){},onEnd:checkPosition};Draggables.addObserver(observer);var options={};options.axis='vertical';options.range=$R(1,91);options.sliderValue=91;options.onChange=this.scaleChanged.bindAsEventListener(this);this.slider=new Control.Slider(sliderHandle,sliderDiv,options);this.slider.setDisabled();this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.updateSlider.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_RESIZED,this.checkPosition.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.updateValue.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_BUSY_CHANGED,this.busyChanged.bind(this));},scaleChanged:function(e,value){var map=this.getMap();var activeWidget=null;if(map.oActiveWidget){activeWidget=map.oActiveWidget;map.deactivateWidget(map.oActiveWidget);}
if(!this.bInternalChange){var map=this.getMap();var center=map.getCurrentCenter();var size=map.getSize();var w_deg=size.w*value;var h_deg=size.h*value;map.setExtents(new OpenLayers.Bounds(center.x-w_deg/2,center.y-h_deg/2,center.x+w_deg/2,center.y+h_deg/2));}
Event.stop(e);if(activeWidget){map.activateWidget(activeWidget);}
return false;},checkPosition:function(){var nav=this.domObj;var pDim=Element.getDimensions(nav.parentNode);var nLeft,nTop;nLeft=parseInt(nav.style.left);nTop=parseInt(nav.style.top);if(nLeft+nav.getWidth()>pDim.width){nLeft=pDim.width-nav.getWidth();nav.style.left=nLeft+'px';}
if(nTop+nav.getHeight()>pDim.height){nTop=pDim.height-nav.getHeight();nav.style.top=nTop+'px';}
if(nLeft<0){nav.style.left='0px';}
if(nTop<0){nav.style.top='0px';}},updateSlider:function(){var olMap=this.getMap().oMapOL;if(olMap.baseLayer.singleTile){this.slider.values=[];this.slider.range=$R(olMap.baseLayer.minResolution,olMap.baseLayer.maxResolution);this.bInternalChange=true;this.slider.setValue(olMap.getResolution());this.bInternalChange=false;}else{var res=olMap.baseLayer.resolutions;var n=res.length;var max=res[0];var min=res[n-1];this.slider.values=[];this.slider.range=$R(1,91);for(var i=0;i<n;i++){var r=res[i];this.slider.values.push(parseInt((r/max)*91));}}
this.slider.setEnabled();},updateValue:function(){var olMap=this.getMap().oMapOL;this.bInternalChange=true;this.slider.setValue(olMap.getResolution());this.bInternalChange=false;},pan:function(e,x,y){var map=this.getMap();var activeWidget=null;if(map.oActiveWidget){activeWidget=map.oActiveWidget;map.deactivateWidget(map.oActiveWidget);}
var center=map.getCurrentCenter();var res=map.oMapOL.getResolution();var size=map.oMapOL.getSize();map.zoom(center.x+(x*size.w*res),center.y+(y*size.h*res),1);Event.stop(e);if(activeWidget){map.activateWidget(activeWidget);}
return false;},zoom:function(e,factor){var map=this.getMap();var activeWidget=null;if(map.oActiveWidget){activeWidget=map.oActiveWidget;map.deactivateWidget(map.oActiveWidget);}
var center=map.getCurrentCenter();map.zoom(center.x,center.y,factor);Event.stop(e);if(activeWidget){map.activateWidget(activeWidget);}
return false;},busyChanged:function(){this.activityIndicator.style.visibility=this.getMap().isBusy()?'visible':'hidden';}};Fusion.Widget.OverviewMap=Class.create();Fusion.Widget.OverviewMap.prototype={oSize:null,nMinRatio:4,nMaxRatio:32,bDisplayed:false,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);var json=widgetTag.extension;if(json.MinRatio){this.nMinRatio=json.MinRatio[0];}
if(json.MaxRatio){this.nMaxRatio=json.MaxRatio[0];}
var mapTag=null;if(json.MapId){this.sMapGroupId=json.MapId;var mapGroup=Fusion.applicationDefinition.getMapGroup(this.sMapGroupId);mapTag=mapGroup.maps[0];}else{var mainMap=this.getMap();mapTag=mainMap.mapGroup.maps[0];}
this.mapObject=eval("new Fusion.Maps."+mapTag.type+"(this.getMap(),mapTag,false)");this.mapObject.registerForEvent(Fusion.Event.MAP_LOADED,this.loadOverview.bind(this));if(this.domObj){this.domObj.style.overflow='hidden';if(this.domObj.jxLayout){this.domObj.jxLayout.addSizeChangeListener(this);}else{this.domObj.resize=this.sizeChanged.bind(this);}}
this.oMapOptions={};},mapWidgetLoaded:function()
{var mapWidget=this.getMap();if(this.sMapGroupId&&(mapWidget.projection==this.mapObject.projection)){this.loadOverview([this.mapObject.oLayerOL]);}else{var extent=this.oMap._oCurrentExtents;this.loadOverview([this.getMap().oMapOL.baseLayer.clone()]);}},keymapLoaded:function()
{this.mapObject.oLayerOL.isBaseLayer=true;},loadOverview:function()
{if(this.control){this.control.destroy();}
var size=Element.getContentBoxSize(this.domObj);this.oSize=new OpenLayers.Size(size.width,size.height);this.mapObject.oLayerOL.isBaseLayer=true;if(this.mapObject.oLayerOL.singleTile){this.oMapOptions.numZoomLevels=3;}
this.mapObject.oLayerOL.ratio=1.0;var mapOpts={div:this.domObj,size:this.oSize,minRatio:this.nMinRatio,maxRatio:this.nMaxRatio,mapOptions:this.oMapOptions,layers:[this.mapObject.oLayerOL]};this.control=new OpenLayers.Control.OverviewMap(mapOpts);if(size.width==0||size.height==0){return;}else{this.getMap().oMapOL.addControl(this.control);this.bDisplayed=true;}},sizeChanged:function(){var size=Element.getContentBoxSize(this.domObj);this.oSize=new OpenLayers.Size(size.width,size.height);if(size.width==0||size.height==0){return;}
if(!this.bDisplayed&&this.control){this.getMap().oMapOL.addControl(this.control);this.bDisplayed=true;}
if(this.control){this.control.size=new OpenLayers.Size(size.width,size.height);this.control.mapDiv.style.width=this.oSize.w+'px';this.control.mapDiv.style.height=this.oSize.h+'px';this.control.ovmap.updateSize();this.control.update();}}};Fusion.Widget.Pan=Class.create();Fusion.Widget.Pan.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);this.control=new OpenLayers.Control.DragPan();this.getMap().oMapOL.addControl(this.control);this.cursorNormal=["url('images/grab.cur'),move",'grab','-moz-grab','move'];this.cursorDrag=["url('images/grabbing.cur'),move",'grabbing','-moz-grabbing','move'];},activateTool:function(){this.getMap().activateWidget(this);},activate:function(){this.control.activate();this.getMap().setCursor(this.cursorNormal);this._oButton.activateTool();},deactivate:function(){this.control.deactivate();this.getMap().setCursor('auto');this._oButton.deactivateTool();}};Fusion.Widget.PanOnClick=Class.create();Fusion.Widget.PanOnClick.prototype={fPercent:null,nDeltaX:null,nDeltaY:null,initialize:function(widgetTag)
{Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;var percent=json.Percentage?json.Percentage[0]:75;this.fPercent=parseFloat(percent)/100;var direction=json.Direction?json.Direction[0]:'';switch(direction){case'north':this.nDeltaX=0;this.nDeltaY=1;break;case'south':this.nDeltaX=0;this.nDeltaY=-1;break;case'east':this.nDeltaX=1;this.nDeltaY=0;break;case'west':this.nDeltaX=-1;this.nDeltaY=0;break;default:this.nDeltaX=0;this.nDeltaY=0;}},execute:function()
{var extents=this.getMap().getCurrentExtents();var center=this.getMap().getCurrentCenter();var fX,fY;fX=center.x+this.nDeltaX*(extents[2]-extents[0])*this.fPercent;fY=center.y+this.nDeltaY*(extents[3]-extents[1])*this.fPercent;this.getMap().zoom(fX,fY,1);}};Fusion.require('widgets/Pan.js');Fusion.Widget.PanQuery=Class.create();Fusion.Widget.PanQuery.prototype={selectionType:'INTERSECTS',nTolerance:3,bActiveOnly:false,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);Object.inheritFrom(this,Fusion.Widget.Pan.prototype,[widgetTag]);this.control=new OpenLayers.Control.DragPan();this.getMap().oMapOL.addControl(this.control);this.control.handler.up=this.mouseUp.bind(this);var json=widgetTag.extension;this.nTolerance=json.Tolerance?Math.abs(parseInt(json.Tolerance)):3;var activeOnly=json.QueryActiveLayer?json.QueryActiveLayer[0]:'false';this.bActiveOnly=(activeOnly=='true'||activeOnly=='1')?true:false;this.cursorNormal=['auto'];this.cursorDrag=["url('images/grabbing.cur'),move",'grabbing','-moz-grabbing','move'];},mouseUp:function(e){var handler=this.control.handler;var p={x:Event.pointerX(e),y:Event.pointerY(e)};var dx=handler.start.x-handler.last.x;var dy=handler.start.y-handler.last.y;if(Math.abs(dx)<this.nTolerance&&Math.abs(dy)<this.nTolerance){var pos=this.getMap().pixToGeo(handler.last.x,handler.last.y);var options={};var dfGeoTolerance=this.getMap().pixToGeoMeasure(this.nTolerance);var minx=pos.x-dfGeoTolerance;var miny=pos.y-dfGeoTolerance;var maxx=pos.x+dfGeoTolerance;var maxy=pos.y+dfGeoTolerance;options.geometry='POLYGON(('+minx+' '+miny+', '+maxx+' '+miny+', '+maxx+' '+maxy+', '+minx+' '+maxy+', '+minx+' '+miny+'))';options.selectionType="INTERSECTS";if(this.bActiveOnly){var layer=this.getMap().getActiveLayer();if(layer){options.layers=layer.layerName;}else{return;}}
if(e.shiftKey){options.extendSelection=true;}
this.getMap().aMaps[0].query(options);}
Event.stop(e);},setParameter:function(param,value){if(param=="Tolerance"&&value>0){this.nTolerance=value;}
if(param=='SelectionType'){this.selectionType=value;}}};Fusion.Widget.Print=Class.create();Fusion.Widget.Print.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;var showPrintUI=json.ShowPrintUI?json.ShowPrintUI[0]:'false';this.showPrintUI=(showPrintUI.toLowerCase()=='true'||showPrintUI=='1');var showTitle=json.ShowTitle?json.ShowTitle[0]:'false';this.showTitle=(showTitle.toLowerCase()=='true'||showTitle=='1');this.pageTitle=json.PageTitle?json.PageTitle[0]:'';this.resultsLayer=json.ResultsLayer?json.ResultsLayer[0]:null;var showLegend=json.ShowLegend?json.ShowLegend[0]:'false';this.showLegend=(showLegend.toLowerCase()=='true'||showLegend=='1');var showNorthArrow=json.ShowNorthArrow?json.ShowNorthArrow[0]:'false';this.showNorthArrow=(showNorthArrow.toLowerCase()=='true'||showNorthArrow=='1');this.dialogContentURL=Fusion.getFusionURL()+widgetTag.location+'Print/Print.html';this.printablePageURL=Fusion.getFusionURL()+widgetTag.location+'Print/printablepage.php';Fusion.addWidgetStyleSheet(widgetTag.location+'Print/Print.css');},execute:function(){if(this.showPrintUI){this.openPrintUI();}else{this.openPrintable();}},openPrintUI:function(){if(!this.dialog){var size=Element.getPageDimensions();var o={title:OpenLayers.String.translate('printTitle'),id:'printablePage',contentURL:this.dialogContentURL,onContentLoaded:this.contentLoaded.bind(this),width:320,height:200,top:(size.height-200)/2,left:(size.width-320)/2,buttons:['generate','cancel'],handler:this.handler.bind(this)};this.dialog=new Jx.Dialog(o);}
this.dialog.open();},setParameter:function(param,value){switch(param){case'Print_ShowTitle':this.showTitle=value;break;case'Print_Title':this.pageTitle=value;break;case'Print_ShowLegend':this.showLegend=value;break;case'Print_ShowNorthArrow':this.showNorthArrow=value;break;}},contentLoaded:function(dialog){dialog.registerIds(['dialogPrintShowtitle','dialogPrintTitle','dialogPrintShowlegend','dialogPrintShowNorthArrow'],dialog.content);dialog.getObj('dialogPrintShowtitle').checked=this.showTitle;dialog.getObj('dialogPrintTitle').value=this.pageTitle;dialog.getObj('dialogPrintTitle').disabled=!this.showTitle;dialog.getObj('dialogPrintShowlegend').checked=this.showLegend;dialog.getObj('dialogPrintShowNorthArrow').checked=this.showNorthArrow;Event.observe(dialog.getObj('dialogPrintShowtitle'),'click',this.controlTitle.bind(this));},controlTitle:function(){this.dialog.getObj('dialogPrintTitle').disabled=!this.dialog.getObj('dialogPrintShowtitle').checked;},handler:function(button){if(button=='generate'){this.showTitle=this.dialog.getObj('dialogPrintShowtitle').checked;this.pageTitle=this.dialog.getObj('dialogPrintTitle').value;this.showLegend=this.dialog.getObj('dialogPrintShowlegend').checked;this.showNorthArrow=this.dialog.getObj('dialogPrintShowNorthArrow').checked;this.openPrintable();}
this.dialog.close();},openPrintable:function(){var mainMap=this.getMap();var url=this.printablePageURL+'?';var extents=mainMap.getCurrentExtents();var centerX=(extents.left+extents.right)/2;var centerY=(extents.top+extents.bottom)/2;var dpi=mainMap._nDpi;var scale=mainMap.getScale();var maps=mainMap.getAllMaps();url=url+'MAPNAME='+mainMap.getMapName();url=url+'&SESSION='+maps[0].getSessionID();url=url+'&CENTERX='+centerX;url=url+'&CENTERY='+centerY;url=url+'&DPI='+dpi;url=url+'&SCALE='+scale;url=url+'&ISTITLE='+(this.showTitle!=''?'1':'0');url=url+'&ISLEGEND='+(this.showLegend?'1':'0');url=url+'&ISARROW='+(this.showNorthArrow?'1':'0');if(this.pageTitle!=''){url=url+'&TITLE='+this.pageTitle;}
window.open(url,'printablepage','');}};Fusion.Widget.RefreshMap=Class.create();Fusion.Widget.RefreshMap.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);},execute:function(){var map=this.getMap();map.redraw();}};Fusion.Widget.SaveMap=Class.create();Fusion.Widget.SaveMap.prototype={iframe:null,printLayout:null,printScale:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.format=(json.Format&&json.Format[0]!='')?json.Format[0]:'png';if(this.format=='DWF'){if(json.ResourceId){this.printLayout=json.ResourceId[0];if(json.Scale){this.printScale=json.Scale[0];}}else{}}
this.enable=Fusion.Widget.SaveMap.prototype.enable;},enable:function(){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);},activateTool:function(){if(!this.iframe){this.iframe=document.createElement('iframe');this.iframe.id='w';this.iframe.style.visibility='hidden';document.body.appendChild(this.iframe);}
var szLayout='';var szScale='';if(this.format==='DWF'){if(this.printLayout){szLayout='&layout='+this.printLayout;}else{return;}
if(this.printScale){szScale='&scale='+this.printScale;}}
var m=this.getMap().aMaps[0];if(navigator.appVersion.match(/\bMSIE\b/)){var url=Fusion.fusionURL+'/'+m.arch+'/'+Fusion.getScriptLanguage()+"/SaveMapFrame."+Fusion.getScriptLanguage()+'?session='+m.getSessionID()+'&mapname='+m.getMapName()+'&format='+this.format+szLayout;w=open(url,"Save",'menubar=no,height=200,width=300');}else{var s=Fusion.fusionURL+'/'+m.arch+'/'+Fusion.getScriptLanguage()+"/SaveMap."+Fusion.getScriptLanguage()+'?session='+m.getSessionID()+'&mapname='+m.getMapName()+'&format='+this.format+szLayout;this.iframe.src=s;}}};if(typeof(ScaleBarTool)=='undefined'){Fusion.require('widgets/scalebar/scalebartool.js');}
Fusion.Widget.Scalebar=Class.create();Fusion.Widget.Scalebar.prototype={style:'thin',displaySystem:'metric',minWidth:100,maxWidth:200,divisions:2,subdivisions:2,showMinorMeasures:true,abbreviateLabel:true,singleLine:false,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);var json=widgetTag.extension;this.style=json.Style?json.Style[0].toLowerCase():this.style;if(this.style!='fancy'&&this.style!='fat'&&this.style!='thin'&&this.style!='thinner'){this.style='thin';}
this.displaySystem=json.DisplaySystem?json.DisplaySystem[0]:this.displaySystem;this.minWidth=json.MinWidth?json.MinWidth[0]:this.minWidth;this.maxWidth=json.MaxWidth?json.MaxWidth[0]:this.maxWidth;this.divisions=json.Divisions?json.Divisions[0]:this.divisions;this.subdivisions=json.SubDivisions?json.SubDivisions[0]:this.subdivisions;this.showMinorMeasures=(json.ShowMinorMeasures&&json.ShowMinorMeasures[0])=='false'?false:true;this.abbreviateLabel=(json.AbbreviateLabel&&json.AbbreviateLabel[0])=='true'?true:false;this.singleLine=(json.SingleLine&&json.SingleLine[0])=='true'?true:false;if(document.styleSheets){if(document.styleSheets[0]){var url=Fusion.getFusionURL()+'widgets/scalebar/scalebar-'+this.style+'.css';if(document.styleSheets[0].addImport){document.styleSheets[0].addImport(url);}else{document.styleSheets[0].insertRule('@import url('+url+');',0);}}}
this.oScaleBar=new ScaleBarTool(1);this.oScaleBar.displaySystem=this.displaySystem;this.oScaleBar.minWidth=this.minWidth;this.oScaleBar.maxWidth=this.maxWidth;this.oScaleBar.divisions=this.divisions;this.oScaleBar.subdivisions=this.subdivisions;this.oScaleBar.showMinorMeasures=this.showMinorMeasures;this.oScaleBar.abbreviateLabel=this.abbreviateLabel;this.oScaleBar.singleLine=this.singleLine;window.setTimeout(this.oScaleBar.place.bind(this.oScaleBar,widgetTag.name),1);this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.extentsChangedCB.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.extentsChangedCB.bind(this));},extentsChangedCB:function(){this.oScaleBar.update(this.getMap().getScale());}};Fusion.Widget.Search=Class.create();Fusion.Widget.Search.prototype={sFeatures:'menubar=no,location=no,status=no,scrollbars=yes',initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.sTarget=json.Target?json.Target[0]:"SearchWindow";this.sBaseUrl=Fusion.getFusionURL()+'widgets/Search/SearchPrompt.php';this.prompt=json.Prompt?json.Prompt[0]:"";this.layer=json.Layer?json.Layer[0]:"";this.filter=json.Filter?json.Filter[0]:"";this.limit=json.MatchLimit?json.MatchLimit[0]:100;this.resultColumns=json.ResultColumns?json.ResultColumns[0].Column:[];},execute:function(){var url=this.sBaseUrl;var map=this.getMap();var mapLayers=map.getAllMaps();var taskPaneTarget=Fusion.getWidgetById(this.sTarget);var pageElement=$(this.sTarget);var params=[];params.push('locale='+Fusion.locale);params.push('session='+mapLayers[0].getSessionID());params.push('mapname='+mapLayers[0].getMapName());if(taskPaneTarget||pageElement){params.push('popup=false');}else{params.push('popup=true');}
params.push('widgetname='+this.id);if(url.indexOf('?')<0){url+='?';}else if(url.slice(-1)!='&'){url+='&';}
url+=params.join('&');if(taskPaneTarget){taskPaneTarget.setContent(url);}else{if(pageElement){pageElement.src=url;}else{window.open(url,this.sTarget,this.sWinFeatures);}}}};Fusion.Widget.Select=Class.create();Fusion.Widget.Select.prototype={selectionType:'INTERSECTS',nTolerance:3,bActiveOnly:false,maxFeatures:0,keyModifiers:0,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);this.asCursor=['auto'];this.enable=Fusion.Widget.Select.prototype.enable;var json=widgetTag.extension;this.selectionType=json.SelectionType?json.SelectionType[0]:'INTERSECTS';if(json.Tolerance&&(parseInt(json.Tolerance[0])>0)){nTolerance=parseInt(json.Tolerance[0]);}
if(json.MaxFeatures){this.maxFeatures=parseInt(json.MaxFeatures[0]);}
this.bActiveOnly=(json.QueryActiveLayer&&(json.QueryActiveLayer[0]=='true'||json.QueryActiveLayer[0]=='1'))?true:false;if(this.bActiveOnly){this.getMap().registerForEvent(Fusion.Event.MAP_ACTIVE_LAYER_CHANGED,this.enable.bind(this));}
this.map=this.getMap().oMapOL;this.handler=new OpenLayers.Handler.Box(this,{done:this.execute});this.handler.dragHandler.up=this.setModifiers.bind(this);this.handler.dragHandler.down=this.clearModifiers.bind(this);},enable:function(){if(this.bActiveOnly){var layer=this.getMap().getActiveLayer();if(layer&&layer.selectable){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}else{this.disable();}}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}},activateTool:function(){this.getMap().activateWidget(this);},activate:function(){this.handler.activate();this.getMap().setCursor(this.asCursor);this._oButton.activateTool();},deactivate:function(){this.handler.deactivate();this.getMap().setCursor('auto');this._oButton.deactivateTool();},execute:function(position){if(this.keyModifiers&OpenLayers.Handler.MOD_CTRL){return;}
var nRight,nTop;var nLeft=position.left;var nBottom=position.bottom;if(position instanceof OpenLayers.Bounds){nRight=position.right;nTop=position.top;}else{nRight=nLeft=position.x;nTop=nBottom=position.y;}
var sMin=this.getMap().pixToGeo(nLeft,nBottom);var sMax=this.getMap().pixToGeo(nRight,nTop);var nXDelta=Math.abs(nLeft-nRight);var nYDelta=Math.abs(nBottom-nTop);var options={};if(nXDelta<=this.nTolerance&&nYDelta<=this.nTolerance){var dfGeoTolerance=this.getMap().pixToGeoMeasure(this.nTolerance);sMin.x=sMin.x-dfGeoTolerance;sMin.y=sMin.y-dfGeoTolerance;sMax.x=sMax.x+dfGeoTolerance;sMax.y=sMax.y+dfGeoTolerance;}
options.geometry='POLYGON(('+sMin.x+' '+sMin.y+', '+sMax.x+' '+sMin.y+', '+sMax.x+' '+sMax.y+', '+sMin.x+' '+sMax.y+', '+sMin.x+' '+sMin.y+'))';options.selectionType=this.selectionType;options.maxFeatures=this.maxFeatures;if(this.bActiveOnly){var layer=this.getMap().getActiveLayer();if(layer){options.layers=layer.layerName;}else{return;}}
if(this.keyModifiers&OpenLayers.Handler.MOD_SHIFT){options.extendSelection=true;}
this.getMap().query(options);},setModifiers:function(evt){this.keyModifiers=(evt.shiftKey?OpenLayers.Handler.MOD_SHIFT:0)|(evt.ctrlKey?OpenLayers.Handler.MOD_CTRL:0)|(evt.altKey?OpenLayers.Handler.MOD_ALT:0);},clearModifiers:function(evt){this.keyModifiers=0;},setParameter:function(param,value){if(param=="Tolerance"&&value>0){this.nTolerance=value;}
if(param=='SelectionType'){this.selectionType=value;}}};Fusion.Widget.SelectPolygon=Class.create();Fusion.Widget.SelectPolygon.prototype={selectionType:'INTERSECTS',nTolerance:3,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);Object.inheritFrom(this,Fusion.Tool.Canvas.prototype,[]);this.asCursor=['auto'];var json=widgetTag.extension;this.selectionType=json.SelectionType?json.SelectionType[0]:'INTERSECTS';if(json.Tolerance&&(parseInt(json.Tolerance[0])>0)){nTolerance=parseInt(json.Tolerance[0]);}
this.polygon=new Fusion.Tool.Canvas.Polygon();},activateTool:function()
{this.getMap().activateWidget(this);},activate:function()
{this.activateCanvas();this.getMap().setCursor(this.asCursor);this._oButton.activateTool();this.polygon=new Fusion.Tool.Canvas.Polygon(this.getMap());},deactivate:function()
{this.deactivateCanvas();this.getMap().setCursor('auto');this._oButton.deactivateTool();},mouseDown:function(e){if(Event.isLeftClick(e)){var p=this.getMap().getEventPosition(e);if(!this.isDigitizing){this.polygon=new Fusion.Tool.Canvas.Polygon(this.getMap());var point=this.getMap().pixToGeo(p.x,p.y);var from=new Fusion.Tool.Canvas.Node(point.x,point.y,this.getMap());var to=new Fusion.Tool.Canvas.Node(point.x,point.y,this.getMap());var seg=new Fusion.Tool.Canvas.Segment(from,to);seg.setEditing(true);this.polygon.addSegment(seg);this.clearContext();this.polygon.draw(this.context);this.isDigitizing=true;}else{var seg=this.polygon.lastSegment();seg.setEditing(false);seg=this.polygon.extendLine();seg.setEditing(true);this.clearContext();this.polygon.draw(this.context);}}},mouseMove:function(e){if(!this.isDigitizing){return;}
var p=this.getMap().getEventPosition(e);var seg=this.polygon.lastSegment();seg.to.setPx(p.x,p.y);seg.to.updateGeo();this.clearContext();this.polygon.draw(this.context);},dblClick:function(e){if(!this.isDigitizing){return;}
this.event=e;var p=this.getMap().getEventPosition(e);var point=this.getMap().pixToGeo(p.x,p.y);var seg=this.polygon.lastSegment();seg.setEditing(false);seg.to.set(point.x,point.y);this.clearContext();this.isDigitizing=false;this.execute();},execute:function(){var wkt='POLYGON((';var nodes=this.polygon.getNodes();var sep='';for(var i=0;i<nodes.length;i++){wkt=wkt+sep+nodes[i].x+' '+nodes[i].y;sep=',';}
wkt=wkt+sep+nodes[0].x+' '+nodes[0].y+'))';var options={};options.geometry=wkt;options.selectionType="inside";if(this.bActiveOnly){var layer=this.getMap().getActiveLayer();if(layer){options.layers=layer.layerName;}else{return;}}
if(this.event.shiftKey){options.extendSelection=true;}
this.getMap().query(options);},setParameter:function(param,value){if(param=="Tolerance"&&value>0){this.nTolerance=value;}
if(param=='SelectionType'){this.selectionType=value;}}};Fusion.Widget.SelectRadius=Class.create();Fusion.Widget.SelectRadius.prototype={selectionType:'INTERSECTS',nTolerance:3,defaultRadius:20,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);Object.inheritFrom(this,Fusion.Tool.Canvas.prototype,[]);this.asCursor=['auto'];var json=widgetTag.extension;this.selectionType=json.SelectionType?json.SelectionType[0]:'INTERSECTS';if(json.Tolerance&&(parseInt(json.Tolerance[0])>0)){nTolerance=parseInt(json.Tolerance[0]);}
this.defaultRadius=json.DefaultRadius?parseInt(json.DefaultRadius[0]):this.defaultRadius;var container=json.RadiusTooltipContainer?json.RadiusTooltipContainer[0]:'';if(container!=''){this.radiusTip=$(container);}
if(this.radiusTip){this.radiusTipType=json.RadiusTooltipType?json.RadiusTooltipType[0].toLowerCase():'dynamic';if(this.radiusTipType=='dynamic'){var oDomElem=this.getMap().getDomObj();oDomElem.appendChild(this.radiusTip);this.radiusTip.style.position='absolute';this.radiusTip.style.display='none';this.radiusTip.style.top='0px';this.radiusTip.style.left='0px';this.radiusTip.style.zIndex=101;}}},setRadius:function(r){this.defaultRadius=r;},getRadius:function(){if(this.circle){return this.circle.radius;}else{return this.defaultRadius;}},activateTool:function(){this.getMap().activateWidget(this);},activate:function(){this.activateCanvas();this.getMap().setCursor(this.asCursor);this._oButton.activateTool();if(!this.circle){this.circle=new Fusion.Tool.Canvas.Circle(this.getMap());this.circle.setCenter(0);}},deactivate:function(){this.deactivateCanvas();this.getMap().setCursor('auto');this._oButton.deactivateTool();},mouseDown:function(e){if(Event.isLeftClick(e)){var p=this.getMap().getEventPosition(e);if(!this.isDigitizing){this.circle.setCenter(p.x,p.y);this.circle.setRadius(this.defaultRadius);this.clearContext();this.circle.draw(this.context);this.isDigitizing=true;}}
if(this.radiusTip&&this.radiusTipType=='dynamic'){this.radiusTip.style.display='block';var size=Element.getDimensions(this.radiusTip);this.radiusTip.style.top=(p.y-size.height*2)+'px';this.radiusTip.style.left=p.x+'px';var r=this.getMap().pixToGeoMeasure(this.circle.radius);this.radiusTip.innerHTML=r;}},mouseMove:function(e){if(!this.isDigitizing){return;}
var p=this.getMap().getEventPosition(e);var center=this.circle.center;var radius=Math.sqrt(Math.pow(center.x-p.x,2)+Math.pow(center.y-p.y,2));if(radius>this.nTolerance){this.circle.setRadius(radius);}
this.clearContext();this.circle.draw(this.context);if(this.radiusTip&&this.radiusTipType=='dynamic'){this.radiusTip.style.display='block';var size=Element.getDimensions(this.radiusTip);this.radiusTip.style.top=(p.y-size.height*2)+'px';this.radiusTip.style.left=p.x+'px';var r=this.getMap().pixToGeoMeasure(this.circle.radius);this.radiusTip.innerHTML=r;}},mouseUp:function(e){if(this.isDigitizing){this.event=e;this.clearContext();this.isDigitizing=false;var center=this.getMap().pixToGeo(this.circle.center.x,this.circle.center.y);var radius=this.getMap().pixToGeoMeasure(this.circle.radius);this.execute(center,radius);}
if(this.radiusTip&&this.radiusTipType=='dynamic'){this.radiusTip.style.display='none';this.radiusTip.innerHTML='';}},execute:function(center,radius){var wkt='POLYGON((';var nPoints=16;var angle=2*Math.PI/nPoints;var sep='';var first;for(var i=0;i<nPoints;i++){var x=center.x+radius*Math.cos(i*angle);var y=center.y+radius*Math.sin(i*angle);if(i==0){first=x+' '+y;}
wkt=wkt+sep+x+' '+y;sep=',';}
wkt=wkt+sep+first+'))';var options={};options.geometry=wkt;options.selectionType="inside";if(this.bActiveOnly){var layer=this.getMap().getActiveLayer();if(layer){options.layers=layer.layerName;}else{return;}}
if(this.event.shiftKey){options.extendSelection=true;}
this.getMap().query(options);},setParameter:function(param,value){if(param=="Tolerance"&&value>0){this.nTolerance=value;}
if(param=='SelectionType'){this.selectionType=value;}}};Fusion.Widget.SelectRadiusValue=Class.create();Fusion.Widget.SelectRadiusValue.prototype={radiusWidgetName:null,label:'',className:'',domLabel:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);var json=widgetTag.extension;this.radiusWidgetName=json.RadiusName?json.RadiusName[0]:null;this.label=json.Label?json.Label[0]:'';this.className=json.ClassName?json.ClassName[0]:'';this.domLabel=document.createElement('label');this.domLabel.className=this.className;this.domLabel.innerHTML=this.label;this.input=document.createElement('input');this.input.type='text';this.domLabel.appendChild(this.input);this.domObj.appendChild(this.domLabel);Event.observe(this.input,'blur',this.onBlur.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.mapLoaded.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.mapExtentsChanged.bind(this));},mapLoaded:function(){var widgets=Fusion.getWidgetsByType('SelectRadius');for(var i=0;i<widgets.length;i++){if(widgets[i].sName==this.radiusWidgetName){this.widget=widgets[i];}}
this.updateFromWidgetValue();},mapExtentsChanged:function(){this.updateWidgetValue();},onBlur:function(){this.updateWidgetValue();},updateWidgetValue:function(){if(this.widget){var radius=this.getMap().geoToPixMeasure(this.input.getValue());this.widget.setRadius(radius);}},updateFromWidgetValue:function(){if(this.widget){this.input.value=this.getMap().pixToGeoMeasure(this.widget.getRadius());}}};Fusion.Widget.SelectWithin=Class.create();Fusion.Widget.SelectWithin.prototype={sFeatures:'menubar=no,location=no,resizable=no,status=no',initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.sTarget=json.Target?json.Target[0]:"SelectWithinWindow";this.sBaseUrl=Fusion.getFusionURL()+'widgets/SelectWithin/SelectWithinPanel.php';this.bSelectionOnly=(json.DisableIfSelectionEmpty&&(json.DisableIfSelectionEmpty[0]=='true'||json.DisableIfSelectionEmpty[0]=='1'))?true:false;this.additionalParameters=[];if(json.AdditionalParameter){for(var i=0;i<json.AdditionalParameter.length;i++){var p=json.AdditionalParameter[i];var k=p.Key[0];var v=p.Value[0];this.additionalParameters.push(k+'='+encodeURIComponent(v));}}
this.enable=Fusion.Widget.SelectWithin.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.enable.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.enable.bind(this));this.disable();},enable:function(){var map=this.getMap();if(this.bSelectionOnly||!map){if(map&&map.hasSelection()){if(this.action){this.action.setEnabled(true);}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}}else{if(this.action){this.action.setEnabled(false);}else{this.disable();}}}else{if(this.action){this.action.setEnabled(true);}else{Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}}},execute:function(){var url=this.sBaseUrl;var map=this.getMap();var mapLayers=map.getAllMaps();var taskPaneTarget=Fusion.getWidgetById(this.sTarget);var pageElement=$(this.sTarget);var params=[];params.push('locale='+Fusion.locale);params.push('session='+mapLayers[0].getSessionID());params.push('mapname='+mapLayers[0].getMapName());if(taskPaneTarget||pageElement){params.push('popup=false');}else{params.push('popup=true');}
params=params.concat(this.additionalParameters);if(url.indexOf('?')<0){url+='?';}else if(url.slice(-1)!='&'){url+='&';}
url+=params.join('&');if(taskPaneTarget){taskPaneTarget.setContent(url);}else{if(pageElement){pageElement.src=url;}else{window.open(url,this.sTarget,this.sWinFeatures);}}}};Fusion.Widget.SelectionInfo=Class.create();Fusion.Widget.SelectionInfo.prototype={defaultTemplate:'selectionInfo',domSpan:null,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);var json=widgetTag.extension;this.emptyText=json.EmptyText?json.EmptyText[0]:this.domObj.innerHTML;this.template=json.Template?json.Template[0]:null;this.domSpan=document.createElement('span');this.domSpan.className='spanSelectionInfo';this.domSpan.innerHTML=OpenLayers.String.translate(this.emptyText);this.domObj.innerHTML='';this.domObj.appendChild(this.domSpan);this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.update.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.update.bind(this));},update:function(){var olMap=this.getMap();var aMaps=olMap.getAllMaps();var map=aMaps[0];if(map.hasSelection()){var layers=map.getSelectedLayers();var nLayers=layers.length;var nFeatures=map.getSelectedFeatureCount();if(this.template){this.domSpan.innerHTML=this.template.replace('{0}',nFeatures).replace('{1}',nLayers);}else{this.domSpan.innerHTML=OpenLayers.String.translate(this.defaultTemplate,nFeatures,nLayers);}}else{this.domSpan.innerHTML=OpenLayers.String.translate(this.emptyText);}}};Fusion.Widget.SelectionPanel=Class.create();Fusion.Widget.SelectionPanel.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);this.defPrevTaskIcon='images/icon_back.gif';this.defNextTaskIcon='images/icon_forward.gif';var json=widgetTag.extension;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.updateSelection.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.clearSelection.bind(this));var d=document.createElement('div');this.toolbar=document.createElement('div');this.toolbar.className='selectionPanelToolbar';this.layerList=document.createElement('select');this.layerList.className='layerSelector';this.toolbar.appendChild(this.layerList);Event.observe(this.layerList,'change',this.renderSelectionFeatures.bind(this));this.featureList=document.createElement('select');this.featureList.className='featureSelector';this.toolbar.appendChild(this.featureList);Event.observe(this.featureList,'change',this.renderFeature.bind(this));this.featureDiv=document.createElement('div');this.featureDiv.className='selectionPanelContent';this.clearSelection();d.appendChild(this.toolbar);d.appendChild(this.featureDiv);Fusion.addWidgetStyleSheet(widgetTag.location+'SelectionPanel/SelectionPanel.css');this.domObj.appendChild(d);},clearSelection:function(){this.layerList.options.length=0;this.featureList.options.length=0;this.oSelection=null;Element.addClassName(this.featureDiv,'noSelection');this.featureDiv.innerHTML=OpenLayers.String.translate('noSelection');},updateSelection:function(){this.getMap().getSelection(this.renderSelectionLayers.bind(this));},renderSelectionLayers:function(oSelection){this.oSelection=null;for(var mapName in oSelection){this.oSelection=oSelection[mapName];break;}
if(!this.oSelection){return;}
Element.removeClassName(this.featureDiv,'noSelection');while(this.layerList.length>0){this.layerList.remove(this.layerList.options[0]);}
var nLayers=this.oSelection.getNumLayers();for(var i=0;i<nLayers;i++){var layerObj=this.oSelection.getLayer(i);var mapLayers=this.getMap().aMaps[0].aLayers;var labelName=layerObj.getName();for(var j=0;j<mapLayers.length;++j){if(mapLayers[j].layerName==labelName){labelName=mapLayers[j].legendLabel;break;}}
var opt=new Option(labelName,i);this.layerList.options[i]=opt;}
this.layerList.selectedIndex=0;this.renderSelectionFeatures();},renderSelectionFeatures:function(){var layerIdx=this.layerList.selectedIndex;while(this.featureList.length>0){this.featureList.remove(this.featureList.options[0]);}
var layerObj=this.oSelection.getLayer(layerIdx);var nElements=layerObj.getNumElements();for(var i=0;i<nElements;i++){var opt=new Option(i+1,i);this.featureList.options[i]=opt;}
this.featureList.selectedIndex=0;this.renderFeature();},renderFeature:function(){var layerIdx=this.layerList.selectedIndex;var featureIdx=this.featureList.selectedIndex;var layerObj=this.oSelection.getLayer(layerIdx);var nProperties=layerObj.getNumProperties();var aNames=layerObj.getPropertyNames();var table=document.createElement('table');var thead=document.createElement('thead');var tr=document.createElement('tr');var th=document.createElement('th');th.innerHTML=OpenLayers.String.translate('attribute');tr.appendChild(th);var th=document.createElement('th');th.innerHTML=OpenLayers.String.translate('value');tr.appendChild(th);thead.appendChild(tr);table.appendChild(thead);var tbody=document.createElement('tbody');table.appendChild(tbody);for(var i=0;i<nProperties;i++){var tr=document.createElement('tr');if(i%2){Element.addClassName(tr,'oddRow');}
var th=document.createElement('th');th.innerHTML=aNames[i];var td=document.createElement('td');td.innerHTML=layerObj.getElementValue(featureIdx,i);tr.appendChild(th);tr.appendChild(td);tbody.appendChild(tr);}
this.featureDiv.innerHTML='';this.featureDiv.appendChild(table);}};Fusion.Widget.TaskPane=Class.create();Fusion.Widget.TaskPane.prototype={aExecutedTasks:null,nCurrentTask:0,nTasks:0,homeAction:null,prevAction:null,nextAction:null,initialize:function(widgetTag)
{Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);this.aExecutedTasks=[];this.defHomeIcon='images/icon_home.png';this.defPrevTaskIcon='images/icon_back.png';this.defNextTaskIcon='images/icon_forward.png';this.defTaskListIcon='images/icon_tasks.png';this.defInitialTask=widgetTag.location+'TaskPane/TaskPane.html';var json=widgetTag.extension;if(json.InitialTask){this.initialTask=taskURL=json.InitialTask[0];}else{this.initialTask=Fusion.getFusionURL()+this.defInitialTask;}
if(json.MenuContainer){this.menuName=json.MenuContainer[0];}
var divName='TaskNav';var tmpDiv=document.createElement('div');tmpDiv.setAttribute('id',divName);this.toolbar=new Jx.Toolbar(tmpDiv,{left:0});this.homeAction=new Jx.Action(this.goHome.bind(this));this.toolbar.add(new Jx.Button(this.homeAction,{image:this.defHomeIcon,tooltip:OpenLayers.String.translate('taskHome')}));this.prevAction=new Jx.Action(this.gotoPrevTask.bind(this));this.toolbar.add(new Jx.Button(this.prevAction,{image:this.defPrevTaskIcon,tooltip:OpenLayers.String.translate('prevTask')}));this.nextAction=new Jx.Action(this.gotoNextTask.bind(this));this.toolbar.add(new Jx.Button(this.nextAction,{image:this.defNextTaskIcon,tooltip:OpenLayers.String.translate('nextTask')}));this.taskMenu=new Jx.Menu({image:this.defTaskListIcon,label:OpenLayers.String.translate('taskList'),right:0});Element.addClassName(this.taskMenu.domObj,'taskMenu');Element.addClassName(this.taskMenu.button.domObj,'jxButtonContentLeft');this.toolbar.add(this.taskMenu);var iframeName=this.sName+'_IFRAME';this.iframe=document.createElement('iframe');new Jx.Layout(this.iframe);this.iframe.setAttribute('name',iframeName);this.iframe.setAttribute('id',iframeName);this.iframe.setAttribute('frameborder',0);this.iframe.style.border='0px solid #fff';this.oTaskPane=new Jx.Panel({toolbar:tmpDiv,label:OpenLayers.String.translate('taskPane'),content:this.iframe});Element.addClassName(this.domObj,'taskPanePanel');Fusion.addWidgetStyleSheet(widgetTag.location+'TaskPane/TaskPane.css');this.domObj.appendChild(this.oTaskPane.domObj);this.oTaskPane.domObj.resize();this.setContent(this.initialTask);Fusion.registerForEvent(Fusion.Event.FUSION_INITIALIZED,this.setTaskMenu.bind(this));},updateButtons:function(){this.prevAction.setEnabled(this.nCurrentTask>0);this.nextAction.setEnabled(this.nCurrentTask<this.aExecutedTasks.length-1);},gotoPrevTask:function(){this.nCurrentTask=this.nCurrentTask>0?--this.nCurrentTask:0;this.iframe.src=this.aExecutedTasks[this.nCurrentTask];this.updateButtons();},gotoNextTask:function(){this.nCurrentTask=this.nCurrentTask<this.aExecutedTasks.length-1?++this.nCurrentTask:this.aExecutedTasks.length-1;this.iframe.src=this.aExecutedTasks[this.nCurrentTask];this.updateButtons();},goHome:function(){this.nCurrentTask=0;this.iframe.src=this.aExecutedTasks[this.nCurrentTask];this.updateButtons();},setContent:function(url){if(this.nCurrentTask<this.aExecutedTasks.length){this.aExecutedTasks.splice(this.nCurrentTask,this.aExecutedTasks.length-this.nCurrentTask);}
this.aExecutedTasks.push(url);++this.nCurrentTask;this.iframe.src=url;this.iframe.taskPaneId=this.widgetTag.name;this.updateButtons();},setTaskMenu:function(){if(this.menuName){var container=this.getMap().widgetSet.getContainerByName(this.menuName);if(container){container.createWidgets(this.getMap().widgetSet,this.taskMenu);}}}};Fusion.Widget.ViewOptions=Class.create();Fusion.Widget.ViewOptions.prototype={displayUnits:false,options:{'imperial':'Miles','metric':'Meters','deg':'Degrees'},initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.MenuBase.prototype,[]);var json=widgetTag.extension;for(var key in this.options){var action=new Jx.Action(this.setViewOptions.bind(this,this.options[key]));var menuItem=new Jx.MenuItem(action,{label:OpenLayers.String.translate(key)});this.oMenu.add(menuItem);}
this.displayUnits=json.DisplayUnits?json.DisplayUnits[0]:false;if(!this.displayUnits){this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.setMapUnits.bind(this));}},activateTool:function(e){this.oMenu.show(e);},setMapUnits:function(){this.setViewOptions(this.getMap().getUnits());},setViewOptions:function(data){for(var i=0;i<Fusion.applicationDefinition.widgetSets.length;++i){var widgetSet=Fusion.applicationDefinition.widgetSets[i];for(var j=0;j<widgetSet.widgetInstances.length;++j){var widget=widgetSet.widgetInstances[j];for(var k=0;k<widget.paramRegister.length;++k){if(widget.paramRegister[k]=='Units'){widget.setParameter('Units',data);}}}}}};Fusion.Widget.ViewSize=Class.create();Fusion.Widget.ViewSize.prototype={defaultTemplate:'x: {x}, y: {y}',domSpan:null,units:Fusion.UNKNOWN,initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);this.emptyText=this.domObj.innerHTML;var json=widgetTag.extension;this.template=json.Template?json.Template[0]:this.defaultTemplate;this.precision=json.Precision?parseInt(json.Precision[0]):-1;this.units=json.Units?Fusion.unitFromName(json.Units[0]):Fusion.UNKOWN;this.domSpan=document.createElement('span');this.domSpan.className='spanViewSize';this.domSpan.innerHTML=this.emptyText;this.domObj.innerHTML='';this.domObj.appendChild(this.domSpan);this.getMap().registerForEvent(Fusion.Event.MAP_RESIZED,this.updateViewSize.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_LOADED,this.setUnits.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_EXTENTS_CHANGED,this.updateViewSize.bind(this));this.registerParameter('Units');},updateViewSize:function(e){var map=this.getMap();var p=map.getSize();if(this.units!=Fusion.PIXELS){var gw=map.pixToGeoMeasure(p.w);var gh=map.pixToGeoMeasure(p.h);if(this.units!=Fusion.UNKNOWN){gw=Fusion.fromMeter(this.units,gw*map._fMetersperunit);gh=Fusion.fromMeter(this.units,gh*map._fMetersperunit);}
if(this.precision>=0){var factor=Math.pow(10,this.precision);gw=Math.round(gw*factor)/factor;gh=Math.round(gh*factor)/factor;}}
var unitAbbr=Fusion.unitAbbr(this.units);this.domSpan.innerHTML=this.template.replace('{w}',gw).replace('{h}',gh).replace('{units}',unitAbbr).replace('{units}',unitAbbr);},setUnits:function(){if(this.units==Fusion.UNKNOWN){this.setParameter('Units',this.getMap().getUnits());}
this.updateViewSize();},setParameter:function(param,value){if(param=='Units'){this.units=Fusion.unitFromName(value);this.updateViewSize();}}};Fusion.Widget.Zoom=Class.create();Fusion.Widget.Zoom.prototype={nTolerance:5,nFactor:2,zoomIn:true,keyModifiers:0,initialize:function(widgetTag)
{Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,true]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);this.asCursor=["url('images/zoomin.cur'),auto",'-moz-zoom-in','auto'];var json=widgetTag.extension;this.nTolerance=json.Tolerance?json.Tolerance[0]:this.nTolerance;this.nFactor=json.Factor?json.Factor[0]:this.nFactor;this.zoomIn=(json.Direction&&json.Direction[0]=='out')?false:true;this.zoomInCursor=["url('images/zoomin.cur'),auto",'-moz-zoom-in','auto'];this.zoomOutCursor=["url('images/zoomout.cur'),auto",'-moz-zoom-out','auto'];this.keypressWatcher=this.keypressHandler.bind(this);this.map=this.getMap().oMapOL;this.handler=new OpenLayers.Handler.Box(this,{done:this.execute});this.handler.dragHandler.up=this.setModifiers.bind(this);this.handler.dragHandler.down=this.clearModifiers.bind(this);},activateTool:function()
{this.getMap().activateWidget(this);Event.observe(document,'keypress',this.keypressWatcher);},activate:function()
{this.handler.activate();if(this.zoomIn){this.getMap().setCursor(this.zoomInCursor);}else{this.getMap().setCursor(this.zoomOutCursor);}
this._oButton.activateTool();},deactivate:function()
{this.handler.deactivate();this.getMap().setCursor('auto');this._oButton.deactivateTool();Event.stopObserving(document,'keypress',this.keypressWatcher);},execute:function(position){var zoomIn=this.zoomIn;if(this.keyModifiers&OpenLayers.Handler.MOD_SHIFT){zoomIn=!zoomIn;}
if(position instanceof OpenLayers.Bounds){var minXY=this.map.getLonLatFromPixel(new OpenLayers.Pixel(position.left,position.bottom));var maxXY=this.map.getLonLatFromPixel(new OpenLayers.Pixel(position.right,position.top));var bounds=new OpenLayers.Bounds(minXY.lon,minXY.lat,maxXY.lon,maxXY.lat);if(zoomIn){this.getMap().setExtents(bounds);}else{var newWidth=bounds.getWidth();var newHeight=bounds.getHeight();var currentExtents=this.getMap().getCurrentExtents();var currentWidth=currentExtents.getWidth();var currentHeight=currentExtents.getHeight();var factor=Math.min(newWidth/currentWidth,newHeight/currentHeight);var center=bounds.getCenterLonLat();this.getMap().zoom(center.lon,center.lat,factor);}}else{var center=this.map.getLonLatFromPixel(position);var factor;if(!zoomIn&&this.nFactor>1){factor=1/this.nFactor;}else{factor=this.nFactor;}
this.getMap().zoom(center.lon,center.lat,factor);}},setModifiers:function(evt){this.keyModifiers=(evt.shiftKey?OpenLayers.Handler.MOD_SHIFT:0)|(evt.ctrlKey?OpenLayers.Handler.MOD_CTRL:0)|(evt.altKey?OpenLayers.Handler.MOD_ALT:0);},clearModifiers:function(evt){this.keyModifiers=0;},setParameter:function(param,value)
{if(param=="Factor"&&value>0)
{this.nFactor=value;}},keypressHandler:function(e){var charCode=(e.charCode)?e.charCode:e.keyCode;if(charCode==Event.KEY_ESC){this.handler.deactivate();this.handler.activate();}}};Fusion.Widget.ZoomOnClick=Class.create();Fusion.Widget.ZoomOnClick.prototype={nFactor:2,initialize:function(widgetTag)
{Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.nFactor=parseFloat(json.Factor?json.Factor[0]:this.nFactor);},execute:function()
{var center=this.getMap().getCurrentCenter();this.getMap().zoom(center.x,center.y,this.nFactor);},setParameter:function(param,value)
{if(param=="Factor"&&value>0)
{this.nFactor=value;}}};Fusion.Widget.ZoomToSelection=Class.create();Fusion.Widget.ZoomToSelection.prototype={initialize:function(widgetTag){Object.inheritFrom(this,Fusion.Widget.prototype,[widgetTag,false]);Object.inheritFrom(this,Fusion.Tool.ButtonBase.prototype,[]);var json=widgetTag.extension;this.maxDimension=json.MaximumZoomDimension?json.MaximumZoomDimension[0]:-1;this.zoomFactor=json.ZoomFactor?json.ZoomFactor[0]:2;this.enable=Fusion.Widget.ZoomToSelection.prototype.enable;this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_ON,this.enable.bind(this));this.getMap().registerForEvent(Fusion.Event.MAP_SELECTION_OFF,this.disable.bind(this));},execute:function(){this.getMap().getSelection(this.zoomToSelection.bind(this));},zoomToSelection:function(selection){var map=this.oMap.aMaps[0];var ll=selection[map.getMapName()].getLowerLeftCoord();var ur=selection[map.getMapName()].getUpperRightCoord();var zoom_size=this.zoomFactor*Math.max(Math.abs(ur.x-ll.x),Math.abs(ur.y-ll.y))/2;var cX=(ur.x+ll.x)/2;var cY=(ur.y+ll.y)/2;ll.x=cX-zoom_size;ur.x=cX+zoom_size;ll.y=cY-zoom_size;ur.y=cY+zoom_size;this.getMap().setExtents(new OpenLayers.Bounds(ll.x,ll.y,ur.x,ur.y));},enable:function(){if(this.oMap&&this.oMap.hasSelection()){Fusion.Tool.ButtonBase.prototype.enable.apply(this,[]);}else{this.disable();}}};function ScaleBarTool(scaleDenominator){this.scaleDenominator=(scaleDenominator==null)?1:scaleDenominator;this.displaySystem='metric';this.minWidth=100;this.maxWidth=200;this.divisions=2;this.subdivisions=2;this.showMinorMeasures=false;this.abbreviateLabel=false;this.singleLine=false;this.resolution=72;this.align='center';this.container=document.createElement('div');this.container.className='sbWrapper';this.labelContainer=document.createElement('div');this.labelContainer.className='sbUnitsContainer';this.labelContainer.style.position='absolute';this.graphicsContainer=document.createElement('div');this.graphicsContainer.style.position='absolute';this.graphicsContainer.className='sbGraphicsContainer';this.numbersContainer=document.createElement('div');this.numbersContainer.style.position='absolute';this.numbersContainer.className='sbNumbersContainer';var markerMajor=document.createElement('div');markerMajor.className='sbMarkerMajor';this.graphicsContainer.appendChild(markerMajor);var markerMinor=document.createElement('div');markerMinor.className='sbMarkerMinor';this.graphicsContainer.appendChild(markerMinor);var barPiece=document.createElement('div');barPiece.className='sbBar';this.graphicsContainer.appendChild(barPiece);var barPieceAlt=document.createElement('div');barPieceAlt.className='sbBarAlt';this.graphicsContainer.appendChild(barPieceAlt);}
ScaleBarTool.prototype.update=function(scaleDenominator){if(scaleDenominator!=null){this.scaleDenominator=scaleDenominator;};function HandsomeNumber(smallUglyNumber,bigUglyNumber,sigFigs){var sigFigs=(sigFigs==null)?10:sigFigs;var bestScore=Number.POSITIVE_INFINITY;var bestTieBreaker=Number.POSITIVE_INFINITY;var handsomeValue=smallUglyNumber;var handsomeNumDec=3;for(var halvingExp=0;halvingExp<3;++halvingExp){var comelyMultiplicand=Math.pow(2,(-1*halvingExp));var maxTensExp=Math.floor(Math.log(bigUglyNumber/comelyMultiplicand)/Math.LN10);for(var tensExp=maxTensExp;tensExp>(maxTensExp-sigFigs+1);--tensExp){var numDec=Math.max(halvingExp-tensExp,0);var testMultiplicand=comelyMultiplicand*Math.pow(10,tensExp);if((testMultiplicand*Math.floor(bigUglyNumber/testMultiplicand))>=smallUglyNumber){if(smallUglyNumber%testMultiplicand==0){var testMultiplier=smallUglyNumber/testMultiplicand;}
else{var testMultiplier=Math.floor(smallUglyNumber/testMultiplicand)+1;}
var testScore=testMultiplier+(2*halvingExp);var testTieBreaker=(tensExp<0)?(Math.abs(tensExp)+1):tensExp;if((testScore<bestScore)||((testScore==bestScore)&&(testTieBreaker<bestTieBreaker))){bestScore=testScore;bestTieBreaker=testTieBreaker;handsomeValue=(testMultiplicand*testMultiplier).toFixed(numDec);handsomeNumDec=numDec;}}}}
this.value=handsomeValue;this.score=bestScore;this.tieBreaker=bestTieBreaker;this.numDec=handsomeNumDec;};HandsomeNumber.prototype.toString=function(){return this.value.toString();};HandsomeNumber.prototype.valueOf=function(){return this.value;};function styleValue(aSelector,styleKey){var aValue=0;if(document.styleSheets){for(var sheetIndex=document.styleSheets.length-1;sheetIndex>=0;--sheetIndex){var aSheet=document.styleSheets[sheetIndex];if(!aSheet.disabled){var allRules;if(typeof(aSheet.cssRules)=='undefined'){if(typeof(aSheet.rules)=='undefined'){return 0;}
else{allRules=aSheet.rules;}}
else{allRules=aSheet.cssRules;}
for(var ruleIndex=0;ruleIndex<allRules.length;++ruleIndex){var aRule=allRules[ruleIndex];if(aRule.selectorText&&(aRule.selectorText.toLowerCase()==aSelector.toLowerCase())){if(aRule.style[styleKey]!=''){aValue=parseInt(aRule.style[styleKey]);}}}}}}
return aValue?aValue:0;};function formatNumber(aNumber,numDecimals){numDecimals=(numDecimals)?numDecimals:0;var formattedInteger=''+Math.round(aNumber);var thousandsPattern=/(-?[0-9]+)([0-9]{3})/;while(thousandsPattern.test(formattedInteger)){formattedInteger=formattedInteger.replace(thousandsPattern,'$1,$2');}
if(numDecimals>0){var formattedDecimal=Math.floor(Math.pow(10,numDecimals)*(aNumber-Math.round(aNumber)));if(formattedDecimal==0){return formattedInteger;}
else{return formattedInteger+'.'+formattedDecimal;}}
else{return formattedInteger;}};this.container.title='scale 1:'+formatNumber(this.scaleDenominator);var measurementProperties=new Object();measurementProperties.english={units:['miles','feet','inches'],abbr:['mi','ft','in'],inches:[63360,12,1]};measurementProperties.metric={units:['kilometers','meters','centimeters'],abbr:['km','m','cm'],inches:[39370.07874,39.370079,0.393701]};var comparisonArray=new Array();for(var unitIndex=0;unitIndex<measurementProperties[this.displaySystem].units.length;++unitIndex){comparisonArray[unitIndex]=new Object();var pixelsPerDisplayUnit=this.resolution*measurementProperties[this.displaySystem].inches[unitIndex]/this.scaleDenominator;var minSDDisplayLength=(this.minWidth/pixelsPerDisplayUnit)/(this.divisions*this.subdivisions);var maxSDDisplayLength=(this.maxWidth/pixelsPerDisplayUnit)/(this.divisions*this.subdivisions);for(var valueIndex=0;valueIndex<(this.divisions*this.subdivisions);++valueIndex){var minNumber=minSDDisplayLength*(valueIndex+1);var maxNumber=maxSDDisplayLength*(valueIndex+1);var niceNumber=new HandsomeNumber(minNumber,maxNumber);comparisonArray[unitIndex][valueIndex]={value:(niceNumber.value/(valueIndex+1)),score:0,tieBreaker:0,numDec:0,displayed:0};for(var valueIndex2=0;valueIndex2<(this.divisions*this.subdivisions);++valueIndex2){displayedValuePosition=niceNumber.value*(valueIndex2+1)/(valueIndex+1);niceNumber2=new HandsomeNumber(displayedValuePosition,displayedValuePosition);var isMajorMeasurement=((valueIndex2+1)%this.subdivisions==0);var isLastMeasurement=((valueIndex2+1)==(this.divisions*this.subdivisions));if((this.singleLine&&isLastMeasurement)||(!this.singleLine&&(isMajorMeasurement||this.showMinorMeasures))){comparisonArray[unitIndex][valueIndex].score+=niceNumber2.score;comparisonArray[unitIndex][valueIndex].tieBreaker+=niceNumber2.tieBreaker;comparisonArray[unitIndex][valueIndex].numDec=Math.max(comparisonArray[unitIndex][valueIndex].numDec,niceNumber2.numDec);comparisonArray[unitIndex][valueIndex].displayed+=1;}
else{comparisonArray[unitIndex][valueIndex].score+=niceNumber2.score/this.subdivisions;comparisonArray[unitIndex][valueIndex].tieBreaker+=niceNumber2.tieBreaker/this.subdivisions;}}
var scoreAdjustment=(unitIndex+1)*comparisonArray[unitIndex][valueIndex].tieBreaker/comparisonArray[unitIndex][valueIndex].displayed;comparisonArray[unitIndex][valueIndex].score*=scoreAdjustment;}}
var subdivisionDisplayLength=null;var displayUnits=null;var displayUnitsAbbr=null;var subdivisionPixelLength=null;var bestScore=Number.POSITIVE_INFINITY;var bestTieBreaker=Number.POSITIVE_INFINITY;var numDec=0;for(var unitIndex=0;unitIndex<comparisonArray.length;++unitIndex){for(valueIndex in comparisonArray[unitIndex]){if((comparisonArray[unitIndex][valueIndex].score<bestScore)||((comparisonArray[unitIndex][valueIndex].score==bestScore)&&(comparisonArray[unitIndex][valueIndex].tieBreaker<bestTieBreaker))){bestScore=comparisonArray[unitIndex][valueIndex].score;bestTieBreaker=comparisonArray[unitIndex][valueIndex].tieBreaker;subdivisionDisplayLength=comparisonArray[unitIndex][valueIndex].value;numDec=comparisonArray[unitIndex][valueIndex].numDec;displayUnits=measurementProperties[this.displaySystem].units[unitIndex];displayUnitsAbbr=measurementProperties[this.displaySystem].abbr[unitIndex];pixelsPerDisplayUnit=this.resolution*measurementProperties[this.displaySystem].inches[unitIndex]/this.scaleDenominator;subdivisionPixelLength=pixelsPerDisplayUnit*subdivisionDisplayLength;}}}
var xOffsetMarkerMajor=(styleValue('.sbMarkerMajor','borderLeftWidth')+styleValue('.sbMarkerMajor','width')+styleValue('.sbMarkerMajor','borderRightWidth'))/2;var xOffsetMarkerMinor=(styleValue('.sbMarkerMinor','borderLeftWidth')+styleValue('.sbMarkerMinor','width')+styleValue('.sbMarkerMinor','borderRightWidth'))/2;var xOffsetBar=(styleValue('.sbBar','borderLeftWidth')+styleValue('.sbBar','borderRightWidth'))/2;var xOffsetBarAlt=(styleValue('.sbBarAlt','borderLeftWidth')+styleValue('.sbBarAlt','borderRightWidth'))/2;if(!document.styleSheets){xOffsetMarkerMajor=0.5;xOffsetMarkerMinor=0.5;}
while(this.labelContainer.hasChildNodes()){this.labelContainer.removeChild(this.labelContainer.firstChild);}
while(this.graphicsContainer.hasChildNodes()){this.graphicsContainer.removeChild(this.graphicsContainer.firstChild);}
while(this.numbersContainer.hasChildNodes()){this.numbersContainer.removeChild(this.numbersContainer.firstChild);}
var aMarker,aBarPiece,numbersBox,xOffset;var alignmentOffset={left:0,center:(-1*this.divisions*this.subdivisions*subdivisionPixelLength/2),right:(-1*this.divisions*this.subdivisions*subdivisionPixelLength)};var xPosition=0+alignmentOffset[this.align];var markerMeasure=0;for(var divisionIndex=0;divisionIndex<this.divisions;++divisionIndex){xPosition=divisionIndex*this.subdivisions*subdivisionPixelLength;xPosition+=alignmentOffset[this.align];markerMeasure=(divisionIndex==0)?0:((divisionIndex*this.subdivisions)*subdivisionDisplayLength).toFixed(numDec);aMarker=document.createElement('div');aMarker.className='sbMarkerMajor';aMarker.style.position='absolute';aMarker.style.overflow='hidden';aMarker.style.left=Math.round(xPosition-xOffsetMarkerMajor)+'px';aMarker.appendChild(document.createTextNode(' '));this.graphicsContainer.appendChild(aMarker);if(!this.singleLine){numbersBox=document.createElement('div');numbersBox.className='sbNumbersBox';numbersBox.style.position='absolute';numbersBox.style.overflow='hidden';numbersBox.style.textAlign='center';if(this.showMinorMeasures){numbersBox.style.width=Math.round(subdivisionPixelLength*2)+'px';numbersBox.style.left=Math.round(xPosition-subdivisionPixelLength)+'px';}
else{numbersBox.style.width=Math.round(this.subdivisions*subdivisionPixelLength*2)+'px';numbersBox.style.left=Math.round(xPosition-(this.subdivisions*subdivisionPixelLength))+'px';}
numbersBox.appendChild(document.createTextNode(markerMeasure));this.numbersContainer.appendChild(numbersBox);}
for(var subdivisionIndex=0;subdivisionIndex<this.subdivisions;++subdivisionIndex){aBarPiece=document.createElement('div');aBarPiece.style.position='absolute';aBarPiece.style.overflow='hidden';aBarPiece.style.width=Math.round(subdivisionPixelLength)+'px';if((subdivisionIndex%2)==0){aBarPiece.className='sbBar';aBarPiece.style.left=Math.round(xPosition-xOffsetBar)+'px';}
else{aBarPiece.className='sbBarAlt';aBarPiece.style.left=Math.round(xPosition-xOffsetBarAlt)+'px';}
aBarPiece.appendChild(document.createTextNode(' '));this.graphicsContainer.appendChild(aBarPiece);if(subdivisionIndex<(this.subdivisions-1)){xPosition=((divisionIndex*this.subdivisions)+(subdivisionIndex+1))*subdivisionPixelLength;xPosition+=alignmentOffset[this.align];markerMeasure=(divisionIndex*this.subdivisions+subdivisionIndex+1)*subdivisionDisplayLength;aMarker=document.createElement('div');aMarker.className='sbMarkerMinor';aMarker.style.position='absolute';aMarker.style.overflow='hidden';aMarker.style.left=Math.round(xPosition-xOffsetMarkerMinor)+'px';aMarker.appendChild(document.createTextNode(' '));this.graphicsContainer.appendChild(aMarker);if(this.showMinorMeasures&&!this.singleLine){numbersBox=document.createElement('div');numbersBox.className='sbNumbersBox';numbersBox.style.position='absolute';numbersBox.style.overflow='hidden';numbersBox.style.textAlign='center';numbersBox.style.width=Math.round(subdivisionPixelLength*2)+'px';numbersBox.style.left=Math.round(xPosition-subdivisionPixelLength)+'px';numbersBox.appendChild(document.createTextNode(markerMeasure));this.numbersContainer.appendChild(numbersBox);}}}}
xPosition=(this.divisions*this.subdivisions)*subdivisionPixelLength;xPosition+=alignmentOffset[this.align];markerMeasure=((this.divisions*this.subdivisions)*subdivisionDisplayLength).toFixed(numDec);aMarker=document.createElement('div');aMarker.className='sbMarkerMajor';aMarker.style.position='absolute';aMarker.style.overflow='hidden';aMarker.style.left=Math.round(xPosition-xOffsetMarkerMajor)+'px';aMarker.appendChild(document.createTextNode(' '));this.graphicsContainer.appendChild(aMarker);if(!this.singleLine){numbersBox=document.createElement('div');numbersBox.className='sbNumbersBox';numbersBox.style.position='absolute';numbersBox.style.overflow='hidden';numbersBox.style.textAlign='center';if(this.showMinorMeasures){numbersBox.style.width=Math.round(subdivisionPixelLength*2)+'px';numbersBox.style.left=Math.round(xPosition-subdivisionPixelLength)+'px';}
else{numbersBox.style.width=Math.round(this.subdivisions*subdivisionPixelLength*2)+'px';numbersBox.style.left=Math.round(xPosition-(this.subdivisions*subdivisionPixelLength))+'px';}
numbersBox.appendChild(document.createTextNode(markerMeasure));this.numbersContainer.appendChild(numbersBox);}
var labelBox=document.createElement('div');labelBox.style.position='absolute';var labelText;if(this.singleLine){labelText=markerMeasure;labelBox.className='sbLabelBoxSingleLine';labelBox.style.top='-0.6em';labelBox.style.left=(xPosition+10)+'px';}
else{labelText='';labelBox.className='sbLabelBox';labelBox.style.textAlign='center';labelBox.style.width=Math.round(this.divisions*this.subdivisions*subdivisionPixelLength)+'px';labelBox.style.left=Math.round(alignmentOffset[this.align])+'px';labelBox.style.overflow='hidden';}
if(this.abbreviateLabel){labelText+=' '+displayUnitsAbbr;}
else{labelText+=' '+displayUnits;}
labelBox.appendChild(document.createTextNode(labelText));this.labelContainer.appendChild(labelBox);if(!document.styleSheets){var defaultStyle=document.createElement('style');defaultStyle.type='text/css';var styleText='.sbBar {top: 0px; background: #666666; height: 1px; border: 0;}';styleText+='.sbBarAlt {top: 0px; background: #666666; height: 1px; border: 0;}';styleText+='.sbMarkerMajor {height: 7px; width: 1px; background: #666666; border: 0;}';styleText+='.sbMarkerMinor {height: 5px; width: 1px; background: #666666; border: 0;}';styleText+='.sbLabelBox {top: -16px;}';styleText+='.sbNumbersBox {top: 7px;}';defaultStyle.appendChild(document.createTextNode(styleText));document.getElementsByTagName('head').item(0).appendChild(defaultStyle);}
this.container.appendChild(this.graphicsContainer);this.container.appendChild(this.labelContainer);this.container.appendChild(this.numbersContainer);};ScaleBarTool.prototype.place=function(elementId){if(elementId==null){document.body.appendChild(this.container);}
else{var anElement=document.getElementById(elementId);if(anElement!=null){anElement.appendChild(this.container);}}
this.update();};