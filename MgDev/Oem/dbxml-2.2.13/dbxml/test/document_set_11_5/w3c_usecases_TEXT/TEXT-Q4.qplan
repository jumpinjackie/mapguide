<XQuery>
  <FunctionDefinition name="{http://www.w3.org/2005/04/xquery-local-functions}:partners">
    <FLWOR>
      <LetBinding name="c">
        <Navigation>
          <QueryPlanFunction result="document" container="11.5.6.dbxml">
            <RQPlan>D(node-metadata-equality-string,name:http://www.sleepycat.com/2002/dbxml,=,'company-data.xml',V(company.name,=,'[to be calculated]'))</RQPlan>
          </QueryPlanFunction>
          <Step axis="descendant" name="company" nodeType="element"/>
          <DbXmlFilter>
            <Navigation>
              <Step axis="child" name="name" nodeType="element">
                <RQPlan>V(company.name,=,'[to be calculated]')</RQPlan>
              </Step>
              <DbXmlCompare name="equal">
                <Variable name="company"/>
              </DbXmlCompare>
            </Navigation>
          </DbXmlFilter>
        </Navigation>
      </LetBinding>
      <Navigation>
        <Variable name="c"/>
        <Step axis="descendant" name="partner" nodeType="element"/>
      </Navigation>
    </FLWOR>
  </FunctionDefinition>
  <FLWOR>
    <ForBinding name="item">
      <Navigation>
        <QueryPlanFunction result="document" container="11.5.6.dbxml">
          <OQPlan>D(node-metadata-equality-string,name:http://www.sleepycat.com/2002/dbxml,=,'string.xml',U)</OQPlan>
        </QueryPlanFunction>
        <Step axis="descendant" name="news_item" nodeType="element"/>
      </Navigation>
    </ForBinding>
    <ForBinding name="c">
      <Navigation>
        <QueryPlanFunction result="document" container="11.5.6.dbxml">
          <OQPlan>D(node-metadata-equality-string,name:http://www.sleepycat.com/2002/dbxml,=,'company-data.xml',U)</OQPlan>
        </QueryPlanFunction>
        <Step axis="descendant" name="company" nodeType="element"/>
      </Navigation>
      <Where>
        <Function name="{http://www.w3.org/2005/04/xpath-functions}:contains">
          <Function name="{http://www.w3.org/2005/04/xpath-functions}:string">
            <Variable name="item"/>
          </Function>
          <Navigation>
            <Variable name="c"/>
            <Step axis="child" name="name" nodeType="element">
              <OQPlan>P(edge-element-equality-string,prefix,company.name)</OQPlan>
            </Step>
          </Navigation>
        </Function>
      </Where>
    </ForBinding>
    <LetBinding name="partners">
      <UserFunction name="{http://www.w3.org/2005/04/xquery-local-functions}:partners">
        <Binding name="{}:company">
          <Navigation>
            <Variable name="c"/>
            <Step axis="child" name="name" nodeType="element">
              <OQPlan>P(edge-element-equality-string,prefix,company.name)</OQPlan>
            </Step>
          </Navigation>
        </Binding>
      </UserFunction>
      <Where>
        <SomeFLWOR>
          <ForBinding name="p">
            <Variable name="partners"/>
          </ForBinding>
          <Operator name="and">
            <Function name="{http://www.w3.org/2005/04/xpath-functions}:contains">
              <Function name="{http://www.w3.org/2005/04/xpath-functions}:string">
                <Variable name="item"/>
              </Function>
              <Variable name="p"/>
            </Function>
            <Navigation>
              <Variable name="c"/>
              <Step axis="child" name="name" nodeType="element">
                <OQPlan>P(edge-element-equality-string,prefix,company.name)</OQPlan>
              </Step>
              <DbXmlCompare name="not_equal">
                <Navigation>
                  <Variable name="item"/>
                  <Step axis="child" name="news_agent" nodeType="element">
                    <OQPlan>P(edge-element-equality-string,prefix,news_item.news_agent)</OQPlan>
                  </Step>
                </Navigation>
              </DbXmlCompare>
            </Navigation>
          </Operator>
        </SomeFLWOR>
      </Where>
    </LetBinding>
    <Variable name="item"/>
  </FLWOR>
</XQuery>
