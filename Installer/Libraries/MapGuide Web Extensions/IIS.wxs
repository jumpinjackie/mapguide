<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:iis="http://schemas.microsoft.com/wix/IIsExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
	<Fragment>
    <Property Id="FRAMEWORKDIR">
        <RegistrySearch Id="DotNetSearch" Root="HKLM" Key="Software\Microsoft\.NETFramework" Name="InstallRoot" Type="directory" />
    </Property>
    <PropertyRef Id="MGWEB_CONFIG"/>
    <PropertyRef Id="IISVERSIONMAJOR"/>
    <PropertyRef Id="IIS_API_TYPE"/>

    <CustomAction Id="AspNetRegIIS_Cmd" Property="AspNetRegIIS" Execute="immediate"
        Value="&quot;[FRAMEWORKDIR]v2.0.50727\aspnet_regiis.exe&quot; -s W3SVC/[SITE_ID]/ROOT/[VIRTUALDIR]" />
    <CustomAction Id="AspNetRegIIS" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Return="ignore" Impersonate="no" />

    <!-- This doesn't do anything; just a pointer -->
    <iis:WebSite Id="IISDefaultWebSite" Description="[MG_WEBSITE]">
      <iis:WebAddress Id="AllUnassigned" Port="80" />
    </iis:WebSite>

    <Feature Id="IISSetupFeature" Level="1" Display="hidden" >

      <!-- IIS5 Base component -->
      <Component Id="IIS5BaseMapGuideComponent" Guid="4174B322-8449-4299-813F-E2B1FCB4ECB4" Directory="WEBEXTENSIONSLOCATION">
        <Condition>MGWEB_CONFIG=&quot;IIS&quot; AND IISVERSIONMAJOR=&quot;#5&quot;</Condition>
        <CreateFolder />
        <iis:WebVirtualDir Id="IIS5MapGuideVDir" Alias="[VIRTUALDIR]" Directory="WEBROOTLOCATION" WebSite="IISDefaultWebSite">
          <iis:WebDirProperties Id="IIS5MapGuideDocuments" DefaultDocuments="index.php,index.html,index.htm,default.aspx,index.aspx,default.htm,default.html"/>
          <iis:WebApplication Id="IIS5MapGuideWebApp" Name="[VIRTUALDIR]">
            <iis:WebApplicationExtension Extension="php" Script="yes" Verbs="GET,POST" CheckPath="no" Executable="[!file_PHPFILES_40]" />
          </iis:WebApplication>
          <iis:WebVirtualDir Id="IIS5MapAgentVDir" Alias="mapagent" Directory="dir_mapagent_0" >
            <iis:WebError ErrorCode="401" SubCode="0" />
            <iis:WebError ErrorCode="401" SubCode="1" />
            <iis:WebError ErrorCode="401" SubCode="2" />
            <iis:WebError ErrorCode="401" SubCode="3" />
            <iis:WebError ErrorCode="401" SubCode="4" />
            <iis:WebError ErrorCode="401" SubCode="5" />
            <iis:WebApplication Id="IIS5MapAgentWebApp" Name="mapagent" >
              <iis:WebApplicationExtension Extension="fcgi" Script="yes" Verbs="GET,POST" CheckPath="no" Executable="[!file_MAPAGENTFILES_96]" />
              <iis:WebApplicationExtension Extension="php" Script="yes" Verbs="GET,POST" CheckPath="no" Executable="[!file_PHPFILES_40]" />
            </iis:WebApplication>
          </iis:WebVirtualDir>
          <iis:WebVirtualDir Id="IIS5MapAdminVDir" Alias="mapadmin" Directory="dir_mapadmin_0" >
            <iis:WebDirProperties Id="IIS5MapAdminDocument" DefaultDocuments="login.php"/>
          </iis:WebVirtualDir>
        </iis:WebVirtualDir>
      </Component>

      <!-- IIS5 PHP MapViewer component -->
      <Component Id="IIS5PhpViewerComponent" Guid="1E56B410-1305-4406-BDFB-1252E159B746" Directory="WEBEXTENSIONSLOCATION">
        <Condition>MGWEB_CONFIG=&quot;IIS&quot; AND IIS_API_TYPE=&quot;PHP&quot; AND IISVERSIONMAJOR=&quot;#5&quot;</Condition>
        <CreateFolder />
        <iis:WebVirtualDir Id="IIS5PhpViewerVDir" Alias="mapguide/mapviewerajax" Directory="dir_mapviewerphp_0" WebSite="IISDefaultWebSite">
          <iis:WebDirProperties Id="IIS5PhpViewerDocument" DefaultDocuments="ajaxviewer.php"/>
        </iis:WebVirtualDir>
      </Component>

      <!-- IIS5 DotNet MapViewer component -->
      <Component Id="IIS5DotNetViewerComponent" Guid="EC460125-D5D4-4596-BD03-B8D920F02E7F" Directory="WEBEXTENSIONSLOCATION">
        <Condition>NETFRAMEWORK20 AND MGWEB_CONFIG=&quot;IIS&quot; AND IIS_API_TYPE=&quot;DOTNET&quot; AND IISVERSIONMAJOR=&quot;#5&quot;</Condition>
        <CreateFolder />
        <iis:WebVirtualDir Id="IIS5DotNetViewerVDir" Alias="mapguide/mapviewerajax" Directory="dir_mapviewernet_0" WebSite="IISDefaultWebSite">
          <iis:WebDirProperties Id="IIS5DotNetViewerDocument" DefaultDocuments="ajaxviewer.aspx"/>
          <iis:WebApplication Id="IIS5MapViewerWebApp" Name="mapviewerajax" />
        </iis:WebVirtualDir>
      </Component>

      <!-- IIS6 Base component -->
      <Component Id="IIS6BaseMapGuideComponent" Guid="BC77760D-55D5-4111-BC1D-50CEC0482D60" Directory="WEBEXTENSIONSLOCATION">
        <Condition>MGWEB_CONFIG=&quot;IIS&quot; AND IISVERSIONMAJOR=&quot;#6&quot;</Condition>
        <CreateFolder />
        <iis:WebAppPool Id="IIS6MapGuideAppPool" Name="[APP_POOL_NAME]" />
        <iis:WebServiceExtension Id="IIS6PhpWebServiceExt" Allow="yes" Description="MapGuide PHP ISAPI Extension" File="[!file_PHPFILES_40]" />
        <iis:WebServiceExtension Id="IIS6MapGuideWebServiceExt" Allow="yes" Description="MapGuide MapAgent ISAPI Extension" File="[!file_MAPAGENTFILES_96]" />
        <iis:WebVirtualDir Id="IIS6MapGuideVDir" Alias="[VIRTUALDIR]" Directory="WEBROOTLOCATION" WebSite="IISDefaultWebSite" >
          <iis:WebDirProperties Id="IIS6MapGuideDocuments" DefaultDocuments="index.php,index.html,index.htm,default.aspx,index.aspx,default.htm,default.html"/>
          <iis:MimeMap Id="IIS6JsonMimeType" Type="application/json" Extension =".json" />
          <iis:WebApplication Id="IIS6MapGuideWebApp" Name="[VIRTUALDIR]" WebAppPool="IIS6MapGuideAppPool" >
            <iis:WebApplicationExtension Extension="php" Script="yes" Verbs="GET,POST" CheckPath="no" Executable="[!file_PHPFILES_40]" />
          </iis:WebApplication>
          <iis:WebVirtualDir Id="IIS6MapAgentVDir" Alias="mapagent" Directory="dir_mapagent_0" >
            <iis:WebError ErrorCode="401" SubCode="0"/>
            <iis:WebError ErrorCode="401" SubCode="1" />
            <iis:WebError ErrorCode="401" SubCode="2" />
            <iis:WebError ErrorCode="401" SubCode="3" />
            <iis:WebError ErrorCode="401" SubCode="4" />
            <iis:WebError ErrorCode="401" SubCode="5" />
            <iis:WebApplication Id="IIS6MapAgentWebApp" Name="mapagent" WebAppPool="IIS6MapGuideAppPool">
              <iis:WebApplicationExtension Extension="fcgi" Script="yes" Verbs="GET,POST" CheckPath="no" Executable="[!file_MAPAGENTFILES_96]" />
              <iis:WebApplicationExtension Extension="php" Script="yes" Verbs="GET,POST" CheckPath="no" Executable="[!file_PHPFILES_40]" />
            </iis:WebApplication>
          </iis:WebVirtualDir>
          <iis:WebVirtualDir Id="IIS6MapAdminVDir" Alias="mapadmin" Directory="dir_mapadmin_0" >
            <iis:WebDirProperties Id="IIS6MapAdminDocument" DefaultDocuments="login.php"/>
          </iis:WebVirtualDir>
        </iis:WebVirtualDir>
      </Component>

      <!-- IIS6 PHP MapViewer component -->
      <Component Id="IIS6PhpViewerComponent" Guid="6CDC8E73-B6B1-4A2E-98E3-953C399D1D0D" Directory="WEBEXTENSIONSLOCATION">
        <Condition>MGWEB_CONFIG=&quot;IIS&quot; AND IIS_API_TYPE=&quot;PHP&quot; AND IISVERSIONMAJOR=&quot;#6&quot;</Condition>
        <CreateFolder />
        <iis:WebVirtualDir Id="IIS6PhpViewerVDir" Alias="mapguide/mapviewerajax" Directory="dir_mapviewerphp_0" WebSite="IISDefaultWebSite">
          <iis:WebDirProperties Id="IIS6PhpViewerDocument" DefaultDocuments="ajaxviewer.php"/>
        </iis:WebVirtualDir>
      </Component>

      <!-- IIS6 DotNet MapViewer component -->
      <Component Id="IIS6DotNetViewerComponent" Guid="357E1C68-9E29-474F-A783-6F8FD8BCEAB4" Directory="WEBEXTENSIONSLOCATION">
        <Condition>NETFRAMEWORK20 AND MGWEB_CONFIG=&quot;IIS&quot; AND IIS_API_TYPE=&quot;DOTNET&quot; AND IISVERSIONMAJOR=&quot;#6&quot;</Condition>
        <CreateFolder />
        <iis:WebVirtualDir Id="IIS6DotNetViewerVDir" Alias="mapguide/mapviewerajax" Directory="dir_mapviewernet_0" WebSite="IISDefaultWebSite">
          <iis:WebDirProperties Id="IIS6DotNetViewerDocument" DefaultDocuments="ajaxviewer.aspx"/>
          <iis:WebApplication Id="IIS6MapViewerWebApp" Name="mapviewerajax" WebAppPool="IIS6MapGuideAppPool" />
        </iis:WebVirtualDir>
      </Component>

    </Feature>

  </Fragment>
</Wix>